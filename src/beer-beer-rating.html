

<!--TODO fix occastional background color on select
TODO default no rating back to average rating when user removes rating-->


<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">


<dom-module id="beer-beer-rating">
<template>



<style is="custom-style">



    paper-listbox {
        --paper-listbox-color: white;
        --paper-listbox-background-color: white;
    }

    .selected-class{
        background-color: white;
    }

    .rating-wrapper{
        @apply(--layout-horizontal);
        @apply(--layout-start-justified);
    }

    .rating-stars{
        @apply(--layout-horizontal);
        @apply(--layout-start-justified);
    }

    .rating-number{
        margin: 25px 0 0 15px;
    
        font-size: 1em;
        font-weight: 300;
        color: var(--app-primary-color); 
    }

    .rating-icon{
        /*width: 10px;*/
        margin: 0 -20px 0 0;
        font-size: 1em;
        font-weight: 300;
        
    }

    .has-rating{
        color: var(--app-accent-color); 
    }

    .user-rating{
        color: var(--app-selected-color);
    }

    .no-rating{
        color: var(--app-secondary-color); 
    }


</style>

    <firebase-auth 
        id="auth" 
        app-name="beer"
        user="{{user}}">
    </firebase-auth>

    <firebase-document
        app-name="beer"
        id="rating"
        path="rating/[[beerId]]/[[user.uid]]/rating">
    </firebase-document>

    <firebase-document
        id="savedRating"
        app-name="beer"
        path="rating/[[beerId]]"
        data="{{savedRating}}">
    </firebase-document>


    <div id="ratingWrapper" class="rating-wrapper">
       <!--<div hidden$="[[!rating]]">RATING<div>-->
            <paper-listbox 
                id="selectedRating" 
                class="rating-stars"
                selected-class="selected-class" 
                selected="{{selectedRating}}" 
                on-click="_selectedRating">
                
                <template is="dom-repeat" items="[[_positiveStars(rating)]]" as="rating">
                    
                    <paper-item>
                       <iron-icon class="rating-icon" icon="beer-icons:star"></iron-icon>
                    </paper-item>
                </template>
                <template is="dom-if" if="[[_middleRating(rating)]]">
                    <paper-item>
                        <iron-icon class="rating-icon" icon="beer-icons:star-half"></iron-icon>
                    </paper-item>
                </template>
                <template is="dom-repeat" items="[[_leftOverStars(rating)]]" as="rating">
                    <paper-item>
                        <iron-icon class="rating-icon" icon="beer-icons:star-border"></iron-icon>
                    </paper-item>
                </template>
            </paper-listbox>
            
        <div hidden$="[[!rating]]">
            <div class="rating-number">[[rating]]</div>
        </div>
    </div>



</template>

<script>

Polymer({

  is: 'beer-beer-rating',

  properties: {
 
    savedRating:{
        type: Object
    },

    beerId:{
        type: String
    },

    rating:{
        type: Number,
    },

    selectedRating:{
        type: Number
    },

    user:{
        type: Object
    },

    ratingType: {
        type: String
    },

    login: {
         type: Boolean,
         notify: true
    }
  },
 
observers:['_userSignedIn(user)',
            '_updateRatingCSS(ratingType)',
            '_computeRating(savedRating)'
            ],
ready: function () {
    // this.rating = this.googleRating;
    // _calculateRating();
},


_computeRating: function (savedRating){
    var ratings = savedRating;
    if(typeof ratings === 'object'){
        var total = 0;
        var key = Object.keys(ratings);
        for (var i=0; i<key.length; i++){
            var rating = ratings[key[i]];
            if(this.user.uid === key[i]){
                this.ratingType = 'user'
                this.rating = rating.rating;
                return;
            }
            total += rating.rating;
        }
        if(key.length >=5){
          
            this.rating = total/key.length;
            this.ratingType = 'aggregate'
        }
    }
    this.ratingType = 'none'
    this.rating = 0;
   

},



_userSignedIn: function (user){
    if(user){
        this.$.rating.disabled = false;
    }else{
        this.$.rating.disabled = true;
    }
},

_updateRatingCSS: function (ratingType) {
    var selectedRating = this.$.selectedRating;
    if(ratingType === 'user'){
        // this.rating = ratingType;
        selectedRating.classList.remove('no-rating');
        selectedRating.classList.remove('has-rating');
        selectedRating.classList.add('user-rating');

    }else if(ratingType === 'aggregate') {
        this.rating = this.googleRating;
        selectedRating.classList.remove('no-rating');
        selectedRating.classList.add('has-rating');
        selectedRating.classList.remove('user-rating');

    }else{
        // this.rating = 0;
        selectedRating.classList.add('no-rating');
        selectedRating.classList.remove('has-rating');
        selectedRating.classList.remove('user-rating');
    }
},



_selectedRating: function (){
    var rating = this.selectedRating +1;
    var saved = this.$.rating.data;
    if(this.user){
        var obj = {};
        var favorite = {};
        if(saved === rating){
          favorite = null;
          rating = null;
        } 

        obj['rating/'+this.beerId+'/'+this.user.uid+'/rating'] = rating;
        obj['user/'+this.user.uid+'/rating/'+this.beerId] = rating;

        var app = this.$.rating.app;
        var that = this;
        firebase.database(app).ref().update(obj, function(error) {
            if (error){
                console.log("Error" + error);
            }else{
                if(rating === null){
                    that.rating = 0;
                    that.ratingType = 'none'
                }else{
                that.rating = rating;
                that.ratingType = 'user'
                }
                console.log("Saved");
            }
        })
          
    }else{
        this.login = true;
    }
},


  _positiveStars: function (rating) {
     
      var returnArray = []
      var positiveRating = Math.floor(rating);
      
       for(var i=0; i<positiveRating; i++){
         returnArray.push('true');
      }
      
      return returnArray;
    },

  _leftOverStars: function (rating) {
      var returnArray = []
      if(rating >4){
        return [];
      }
      var floor = Math.floor(rating);
      
      var negitiveRating = 4-floor;
      if(rating === floor){
          //add one if there is no half star
          negitiveRating ++
      }
        for(var i=0; i<negitiveRating; i++){
            returnArray.push('true')
      }
      return returnArray;
    },

  _middleRating: function (rating) {
      var remainder = rating % 1;
      return remainder;
    },


  _test: function (obj){
      console.log(obj)
  }

});


   

</script>
</dom-module>
