

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">




<dom-module id="beer-beer-rating">
<template strip-whitespace>



<style is="custom-style">



paper-listbox {
    --paper-listbox-color: white;
}

.rating-wrapper{
    @apply(--layout-horizontal);
    @apply(--layout-start-justified);
}

.rating-stars{
    @apply(--layout-horizontal);
    @apply(--layout-start-justified);
}

.rating-number{
    margin: 25px 0 0 15px;
  
    font-size: 1em;
    font-weight: 300;
    color: var(--app-primary-color); 
}

.rating-icon{
    /*width: 10px;*/
    margin: 0 -20px 0 0;
    font-size: 1em;
    font-weight: 300;
    
}

.has-rating{
    color: var(--app-accent-color); 

}

.user-rating{
    color: var(--app-selected-color);
}

.no-rating{
    color: var(--app-secondary-color); 
}


</style>

<firebase-auth 
    id="auth" 
    app-name="beer"
    user="{{user}}" 
    status-known="{{statusKnown}}"
    on-error="handleError">
</firebase-auth>

<firebase-document
    app-name="beer"
    id="beerRating"
    path="rating/[[beerId]]/[[user.uid]]/rating"
    >
</firebase-document>

<firebase-document
    id="rating"
    app-name="beer"
    path="rating/[[beerId]]"
    data="{{savedRating}}">
</firebase-document>


    <div class="rating-wrapper">
        <div>
            <paper-listbox 
                id="selectedRating" 
                class="rating-stars"
                selected="{{selectedRating}}" 
                on-click="_selectedRating">
                <template is="dom-repeat" items="[[_positiveStars(rating)]]" as="rating">
                    <paper-item>
                        <iron-icon class="rating-icon" icon="beer-icons:star"></iron-icon>
                    </paper-item>
                </template>
                <template is="dom-if" if="[[_middleRating(rating)]]">
                    <paper-item>
                        <iron-icon class="rating-icon" icon="beer-icons:star-half"></iron-icon>
                    </paper-item>
                </template>
                <template is="dom-repeat" items="[[_leftOverStars(rating)]]" as="rating">
                    <paper-item>
                        <iron-icon class="rating-icon" icon="beer-icons:star-border"></iron-icon>
                    </paper-item>
                </template>
            </paper-listbox>
        </div>
            
        <div hidden$="[[!rating]]">
            <div class="rating-number">[[rating]]</div>
        </div>
    </div>





</template>

<script>

Polymer({

  is: 'beer-beer-rating',

  properties: {

    beerId:{
        type: String
    },

    login: {
        type: Boolean,
        notify: true
    },

    rating:{
        type: Number,
        computed: '_computeRating(savedRating)'
    },

    savedRating:{
        type: Object
    },

    selectedRating:{
        type: Number
    },
    user:{
        type: Object
    }
   
  },
 


_computeRating: function (rating){

  var totalRating = 0;
  var numberRatings = 0;
  var selectedRating = this.$.selectedRating;
    if(this.user){
        var userId = this.user.uid;
    }

    if(typeof rating === 'object'){
      
        var key = Object.keys(rating);
        for (var i=0; i< key.length; i++){
            if(userId){
                if(userId === key[i]){
                    selectedRating.classList.remove('no-rating');
                    selectedRating.classList.remove('has-rating');
                    selectedRating.classList.add('user-rating');
                    return rating[key[i]].rating;
                }
            }
            if(rating[key[i]].rating){
                totalRating += rating[key[i]].rating;
                numberRatings ++;
            }
        }
    }
    if(numberRatings < 4){
        selectedRating.classList.add('no-rating');
        selectedRating.classList.remove('has-rating');
        selectedRating.classList.remove('user-rating');
        return 0;

    }else{
        selectedRating.classList.remove('no-rating');
        selectedRating.classList.add('has-rating');
        selectedRating.classList.remove('user-rating');
        return Math.round((totalRating/numberRatings)*100)/100;
    }
    
},

_selectedRating: function (){
    var rating = this.selectedRating +1;
    var saved = this.$.beerRating.data;
    if(this.user){
        var obj = {};
        if(saved === rating){
          rating = null;
        } 
                
        obj['rating/'+this.beerId+'/'+this.user.uid+'/rating'] = rating;
        obj['user/'+this.user.uid+'/rating/'+this.beerId+'/rating'] = rating;
        // console.log(obj);
        var app = this.$.rating.app;
        var that = this;
        firebase.database(app).ref().update(obj, function(error) {
            if (error){
                console.log("Error" + error);
            }else{
                console.log("Saved");
            }
        })
          
    }else{

        //SEND SIGN IN ISSUE
        this.login = true;

    }
},




//   _onKeyDown: function(event) {
//     var currentRating = this.value || 0;

//     if (event.keyCode === 37) {
//       this.value = Math.max(currentRating - 1, 0);
//     } else if (event.keyCode === 39) {
//       this.value = Math.min(currentRating + 1, 5);
//     }
//   },

  _positiveStars: function (rating) {
      var returnArray = []
      var positiveRating = Math.floor(rating);
      
       for(var i=0; i<positiveRating; i++){
         returnArray.push('true');
      }
      
      return returnArray;
    },

  _leftOverStars: function (rating) {
      var returnArray = []
      if(rating >4){
        return [];
      }
      var floor = Math.floor(rating);
      
      var negitiveRating = 4-floor;
      if(rating === floor){
          //add one if there is no half star
          negitiveRating ++
      }
        for(var i=0; i<negitiveRating; i++){
            returnArray.push('true')
      }
      return returnArray;
    },

  _middleRating: function (rating) {
      var remainder = rating % 1;
      return remainder;
    },


  _test: function (obj){
      console.log(obj)
  }

});

</script>
</dom-module>
