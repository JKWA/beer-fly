<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="beer-icons.html">

<dom-module id="beer-pub-rating">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
      }
      :host[disabled] .foreground-rating .item {
        cursor: default;
      }
      .background-rating {
        color: var(--app-secondary-color);
      }
      .user-rating {
        color: var(--app-selected-color);
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }

      .google-rating {
        color: var(--app-accent-color);
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
      
      .item {
        display: inline-block;
        cursor: pointer;
      }
      .item-icon {
        overflow: hidden;
      }

      

      .rating-wrapper{
            @apply --layout-horizontal;
            @apply --layout-start-justified;
            
        }

      .rating-number{
        font-size: 1.2em;
        font-weight: 300;
        color: var(--app-secondary-color);
         margin: 2px 0 0 10px;
    }

    </style>

     <firebase-auth 
        id="auth" 
        app-name="beer"
        user="{{user}}">
      </firebase-auth>


    <firebase-document
        app-name="beer"
        id="rating"
        disabled
        path="user/[[user.uid]]/favorite/[[placeId]]/rating"
        data="{{userRating}}">
    </firebase-document>


   <div class="rating-wrapper" hidden$="[[!value]]">
    <div class="background-rating">
     
      <template is="dom-repeat" items="{{limitItems}}" strip-whitespace>
        <iron-icon icon="beer-icons:star-border"></iron-icon>
      </template>
    </div>

    <div class$="[[ratingStyle]]">
      <template is="dom-repeat" items="{{limitItems}}" strip-whitespace>
        <div class="item" on-mouseover="_previewRating" on-mouseout="reset" on-tap="_onRate">
          <div class="item-icon">
            <iron-icon icon="beer-icons:star"></iron-icon>
          </div>
        </div>
    </template>
    </div>
     <div hidden$="[[!value]]">
            <div class="rating-number">[[value]]</div>
    </div>
   </div>

  </template>

  <script>
    Polymer({
      is: 'beer-pub-rating',
      properties: {

        /**
         * If true, the user will not be able to select a rating.
         */
        disabled: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
    	},

        googleRating: {
            type: Number,
            value:0
         },

        /**
         * The number of items to display
         */
        limit: {
          type: Number,
          value: 5,
          observer: 'renderItems'
        },

         name: {
            type: String
        },

       
      
        /**
         * The rating items displayed on the screen
         */
    	  limitItems: {
            type: Array,
            readOnly: true
    	  },

          login:{
              type: Boolean,
              notify: true
          },

          placeId:{
              type: String
          },

          ratingStyle:{
              type: String,
              value: 'google-rating',
              reflectToAttribute: true
          },

          user: {
              type: Object
          },

          userRating: {
            type: Number
         },

         vicinity:{
             type: String
         },

          value: {
          type: Number,
          value: 0,
          observer: 'reset'
        }
      },

      observers:[
            '_userSignedIn(user)',
            '_hasUserRating(userRating)'
            ],

      ready: function () {
            this.value = this.googleRating;
      },
      
    //   attached: function() {
    //     this.async(function() {
    //       this.reset();
    //     }.bind(this));
    //   },

    _userSignedIn: function (user){
        if(user){
            this.$.rating.disabled = false;
        }else{
            this.$.rating.disabled = true;
        }
    },

      _hasUserRating: function (userRating) {
        console.log('userRating', userRating)
        if(typeof userRating === 'number'){
            this.value = userRating;
            this.ratingStyle = 'user-rating'

        }else if(this.googleRating) {
            this.value = this.googleRating;
            this.ratingStyle = 'google-rating'

        }else{
            this.value = 0;
            this.ratingStyle = 'google-rating'

        }
            
    },
      /**
       * Refreshes the rating display to the current rating
       */
      reset: function() {
        this._refreshRating(this.value);
      },
      /**
       * Renders the items based on the limit
       */
      renderItems: function() {
        var limitItems = [];
        for (var i = 0; i < this.limit; i++) {
          limitItems.push(i);
        }
        this._setLimitItems(limitItems);
      },
      _refreshRating: function(value) {
        var items = Polymer.dom(this.root).querySelectorAll('.item-icon');
        for (var i = 0; i < items.length; i++) {
          items[i].style.width = Math.min(Math.max(value - i, 0), 1) * 100 + '%';
        }
      },
      _previewRating: function(e) {
        if (this.disabled) return;
        this._refreshRating(e.model.index + 1);
      },

      _onRate: function(e) {

         var rating = e.model.index + 1
    
        var saved = this.$.rating.data;
        if(this.user){
            var obj = {};
            var favorite = {};

            if(saved === rating){
            favorite = null;
            rating = null;
            } else {
                
                favorite.rating = rating;
                favorite.name = this.name;
                favorite.vicinity = this.vicinity;
                favorite.place_id = this.placeId;
            }

            obj['favorite/'+this.placeId+'/'+this.user.uid+'/rating'] = rating;
            obj['user/'+this.user.uid+'/favorite/'+this.placeId] = favorite;

            // console.log(obj);

            firebase.database(this.$.auth.app).ref().update(obj)
                .then(function(){
                    console.log("Saved");
                })
                .catch(function (error){
                    console.log("Rating Error" + error);
                })
                  
            
        }else{
            this.login = true;
        }

            if (this.disabled) return;
          
            

    }
   
    });
  </script>
</dom-module>