

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">

<link rel="import" href="beer-icons.html">
<link rel="import" href="beer-login.html">


<dom-module id="beer-account">

<template strip-whitespace>
  <style include="paper-material-styles">

    a{
      text-decoration: none;
    }

     .card {
        padding: 12px;
        margin: 10px;
        @apply --paper-material-elevation-1;
    }

     paper-button{
        text-align: left;
        text-transform: none;
        min-height: 40px;
        width: 220px;
    }

     .button-wrapper{
         @apply --layout-vertical;
      }


     .button-wrapper > div{
        @apply --layout-horizontal;
        @apply --layout-center-justified;
        margin: 20px 0 20px 0;
        
    }

      .item {
        margin: 30px;
        padding: 10px;
        @apply --layout-horizontal;
        @apply --layout-center-justified;
      }

      .account-details {
        font-size: 1.5em;
        font-weight: 400;
       
      }

      .message {
        font-size: 1.0em;
        font-weight: 300;
        color: var(--app-primary-color);
        margin: 20px 0 10px 0;
      }

      .edit-icon{
        font-size: 1em;
        font-weight: 300;
        color: var(--app-secondary-color);
      }


      .name {
        font-size: 1.5em;
        font-weight: 300;
        color: var(--app-primary-color);
        margin: 10px 0 0 0;
      }

      .address {
        font-size: 1.0em;
        font-weight: 300;
        color: var(--app-primary-color);
      }



    </style>

     <firebase-auth id="auth" app-name="beer" status-known="[[statusKnown]]"user="{{user}}"></firebase-auth>

   

    <firebase-document
        app-name="beer"
        id="userData"
        disabled
        path="user/[[user.uid]]"
        data="{{userData}}">
    </firebase-document>

     <firebase-query
        id="organization"
        app-name="beer"
        order-by-child="domain";
        equal-to="[[userData.domain]]"
        disabled
        path="organization"
        data="{{organizations}}">
    </firebase-query>


<!--[[userStatus]]-->
      <div hidden$="[[!statusKnown]]">
          <div hidden$="[[user]]">
             <beer-login class="item"></beer-login>
          </div>
 
          <div hidden$="[[!user]]">
            <div class="card" elevation="1">
           
              <div class="account-details">Account Details</div>
              <div><b>Name:</b>
                <span> [[userData.displayName]]</span>
                <paper-icon-button 
                  class="edit-icon" 
                  icon="beer-icons:edit"
                  on-tap="_toggleDisplayNameEdit">
                </paper-icon-button>
              </div>
              
              <iron-collapse no-animation opened="{{displayNameEditToggle}}"> 
                <paper-input label="Display Name" value="{{userData.displayName}}"></paper-input>
              </iron-collapse>
              
              <div><b>Email:</b> [[user.email]]</div>
              <div><b>Provider:</b> [[provider]]</div>
              <div><b>Verified:</b> [[user.emailVerified]]</div>
              <div><b>Domain:</b> [[userData.domain]]</div>
              <div hidden="[[!userData.ADMIN]]"><b>Admin:</b> [[userData.ADMIN]]</div>
              <div class="message">[[message]]</div>
            </div>

            <template is="dom-repeat" items="[[organizations]]" as="pub">

              <a aria-label$="[[pub.name]]" href$="/[[_computeNameForUrl(pub.name)]]/main?orgid=[[pub.place_id]]">
                <div class="card" elevation="1">
                  <div class="name">[[pub.name]]</div>
                  <div class="address"><b>Domain:</b> [[pub.domain]]</div>
                  <div class="address">[[pub.formatted_address]]</div>
                </div>
              </a>
                
            </template>
           
            <div class="button-wrapper">
              <template is="dom-if" if="[[!user.emailVerified]]">
              <div>
                <paper-button on-tap="_verifyAccount" raised>
                  <iron-icon icon="beer-icons:email"></iron-icon>
                  <div>Verify Email</div>
                </paper-button>
              </div>
              </template>
             
              <template is="dom-if" if="[[smallScreen]]">
                <div hidden$="[[!user]]">
                  <paper-button on-tap="_logout" raised>
                      <iron-icon icon="beer-icons:account"></iron-icon>
                      <div>Sign out</div>
                  </paper-button>
                </div>
              </template>
            </div>
                 
          </div>
          
      </div>
      
        <paper-toast 
            id="verificationToast" 
            duration="0" 
            horizontal-align="right"
            horizontal-offset="50"
            vertical-offset="100">
            <div>Verification sent to [[user.email]]</div>
            <div>Please refresh the app after verifying.</div>
        </paper-toast>
      

</template>
  <script>

    Polymer({

      is: 'beer-account',

      properties: {

        displayNameEditToggle:{
          type:Boolean,
          value: false
        },

        message:{
          type: String
        },

        organizations:{
          type: Array
        },

        smallScreen:{
          type: Boolean
        },

        statusKnown:{
          type:Boolean
        },

        user:{
          type: Object
        },
        
        userData:{
          type: Object
        },

        userStatus:{
          type: String,
          value: 'NONE'
        },

        provider: {
          type: String,
          computed: '_computeProvider(user)'

        },

      },

 

      observers:['_watchUserStatus(user, userData)'],
      
      _watchUserStatus: function (user, userData){
         var userStatus = "NONE";
         var userMessage = 'Not signed in.';
         

        if(user){
          this.$.userData.disabled = false;
          


            userStatus = 'SIGNED_IN';
            userMessage = 'Save star ratings for beers and breweries';


          if(user.emailVerified){
              userStatus = 'VERIFIED';
          
            if(userData){
              var domainEmail = this._isDomainEmail(userData.domain);

                if(userData.domain){
                  if(domainEmail){   
                    userStatus = 'VERIFIED_DOMAIN_EMAIL';
                    userMessage = 'Save star ratings and edit information for organizations with matching domains.';
                    this.$.organization.disabled = false;
                  }else{
                    this.$.organization.disabled = true;
                  }
                }else{
                  this.$.organization.disabled = true;
                }

                if(userData.ADMIN){
                  userStatus = "ADMIN";
                  userMessage = 'Edit information for any organization';
                }
            }
          }
        
        }else{
          this.$.userData.disabled = true;
        }

        this.userStatus = userStatus;
        this.message = userMessage;


      },


    
     _isDomainEmail: function (email) {
       var emails = ['gmail.com', 'hotmail.com', 'aol.com', 'mac.com', 'me.com',
                     'yahoo.com', 'outlook.com', 'mail.com', 'zoho.com', 'hushmail.com', 
                     'facebook.com', 'lycos.com', 'inbox.com', 'gmx.com'];
        if(typeof email === 'string'){
          for (var i=0; i<emails.length; i++){
            if(email.toLowerCase() === emails[i]){
              return false;
            }
          }
          return true;
        }else{
          return false;
        }

     },

      _computeProvider: function (user){
        if(user){
          var provider = user.providerData[0];
          return provider.providerId;
        }else{
          return 'your provider'
        }

      },

      
      _computedOwnsOrganizations: function (){
        var organizations = this.$.organizations
        return !organizations.valueIsEmpty(organizations);
      },

      _edit: function(){
        'use strict';
        var body = document.querySelector('body');
        Polymer.dom(body).appendChild(this.$.editDialog);
        this.$.editDialog.open()
      },

      _verifyAccount: function (){
        var that = this;
        console.log(this.$.auth);
        var app = this.$.auth.app;

        firebase.auth(app).currentUser.sendEmailVerification()
         .then(function(response) {
            console.log("Email Sent")
            that.$.verificationToast.open();

        })
        .catch(function(error) {
          console.log('error', JSON.stringify(error))

        });
                   
      },

      _toggleDisplayNameEdit: function (){
        if(this.displayNameEditToggle){
          this.displayNameEditToggle = false;
        }else{
          this.displayNameEditToggle = true;
        }
      },
 

      _logout: function(){
        'use strict';
        return this.$.auth.signOut();
      }, 

       _computeNameForUrl: function (name) {
         'use strict';
          if (name) {
            name = name.replace(/\s/g, '-')
            return name.replace(/[^a-zA-Z\d\s:]/g, '');
          } else {
            return 'pub-name-missing'
          }
      },

     

      _test: function(obj){
          console.log(obj);
      }

    });

  </script>

</dom-module>
