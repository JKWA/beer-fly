<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="beer-icons.html">
<link rel="import" href="beer-style-select.html">


<dom-module id="beer-beer-edit">


  <template>

    <style>

     :host {
        display: block;
        max-width: 640px;
      }

      a{
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 0.3em;
        color: var(--app-primary-color);
        text-decoration: none;
        /* required for IE 11, so this <a> can receive pointer events */
        display: inline-block;
        pointer-events: auto;
        }

      paper-spinner-lite{
        position: absolute;
        top: 40%;
        left: 50%;
      }

      .card{
        margin: 10px;
        padding: 20px;
      }

      .abv {
        width: 100px;
      }

      .beer-name{
        font-size: 1.25em;
        font-weight: 400;
        color: var(--app-primary-color);
      }

      .return-link{
        margin: 0 0 0 15px;
      }

      .brewed-by{
        font-size: 1em;
        font-weight: 600;
        color: var(--app-primary-color);
      }

      .saved-message{
        font-size: 1em;
        font-weight: 400;
        color: green;
      }

      .error-message{
        font-size: 1em;
        font-weight: 400;
        color: red;
      }

      .button{
         color: var(--app-accent-color);
      }

      .brewery-name {
        font-size: 1.7em;
        font-weight: 500;
        color: var(--app-primary-color);
      }

      .address {
        font-size: .9em;
        font-weight: 300;
        color: var(--app-primary-color);
      }

      .action-wrapper{
         @apply(--layout-horizontal);
         @apply(--layout-justified);
      }

      .message-wrapper{
         @apply(--layout-horizontal);
         @apply(--layout-end-justified);
      }

    </style>

    <firebase-auth  
        app-name="beer" 
        id="auth"
        user="{{user}}">
    </firebase-auth>

     <firebase-document 
        id="pub"
        app-name="beer" 
        path="organization/[[place.place_id]]">
    </firebase-document>


     <firebase-document
        app-name="beer"
        id="beer"
        disabled
        path="beer/[[beerId]]"
        data="{{beer}}">
    </firebase-document>

    <paper-material class="card" elevation="0">

    <div class="beer-name" hidden$="[[!beerId]]">[[beerName]]</div>
        <paper-input 
          hidden$="[[beerId]]"
          id="beerName"
          label="Beer Name" 
          char-counter 
          maxlength="100" 
          error-message="Required"
          value="{{beerName}}">
        </paper-input>

        <paper-textarea 
          id="description"
          label="Beer Description" 
          char-counter 
          maxlength="500" 
          value="{{description}}">
        </paper-textarea>

        <paper-input 
            id="abv" 
            class="abv" 
            label="ABV" 
            error-message="Invalid"
            value="{{abv}}">
          <div suffix>%</div>
        </paper-input>

        <beer-style-select
            preset-style-name="{{presetStyleName}}"
            selected-style="{{selectedStyle}}">
        </beer-style-select>


    </paper-material>

    <paper-material class="card" elevation="0">
        <paper-button 
            id="submitButton" 
            on-tap="_addNewBeer" 
            raised
            class="button">[[buttonName]]</paper-button>
    </paper-material>


   <paper-toast 
      class="toast" 
      id="savedToast" 
      horizontal-align="right"
      horizontal-offset="50"
      vertical-offset="100"
      duration="5000">
      <div> 
        Saved [[savedMessage]]
        <br>
      </div>
    </paper-toast>

   
  </template>

  <script>

    Polymer({

      is: 'beer-beer-edit',
  

      properties:{

        abv:{
          type: Number
        },

        beer: {
          type: Object
        },

        buttonName:{
          type:String,
          value: 'Add Beer'

        },

        description:{
          type: String
        },
        
        beerId:{
          type: String,
        },

        beerName:{
          type: String
        },

        organization:{
          type: Object
        },

        place:{
          type: Object
        },

        returnOrgId:{
            type: String
        },

        returnName:{
            type: String
        },

        savedMessage:{
          type: String,
          value: 'test'
        },


        selectedStyle:{
          type: Object,
          value: function (){return {};}
        },

        styleId:{
          type: Number
        },


        valid:{
          type: Boolean,
          value: false
        },
        
        user:{
          type:Object
        }

      },

      ready: function (){
        this.$.beerName.invalid = true;
      },

      observers:[
        '_validateABV(abv)',
        '_validateName(beerName)',
        '_validateAll(name, abv)',
        '_ifBeerId(beerId)',
        '_prefillData(beer)'
      ],



      _ifBeerId: function (beerId) {
        console.log('getting beer id', beerId);
        
        if(beerId){
          this.$.beer.disabled = false;
          this.buttonName = "SAVE";
        }else{
          this.$.beer.disabled = true;
          this.beerName = null;
          this.description = null;
          this.searchString = null;
          this.styleName = null;
          this.styleId = null;
          this.abv = null;
          this.buttonName = "ADD BEER";

        }
      },

      _prefillData: function (beer) {
      
        if(beer){

            this.beerName = beer.name;
            this.description = beer.description;
            if(beer.abv){
              this.abv = beer.abv;
            }

            this.presetStyleName = beer.styleName;
            this._validateAll();
            
        }else{
           
        
        }
        // if(Object.keys(beer).length >0){
        // this.$.editCard.hidden = false;
        // this.$.spinner.active = false;
        },



      _validateABV: function (abv){
        if(abv){
          if(abv >0 && abv <=30){
            this.$.abv.invalid = false;
          }else{
            this.$.abv.invalid = true;
          }
        }else{
          this.$.abv.invalid = false;
        }
      },

      _validateName: function (beerName){
        if(beerName){
            this.$.beerName.invalid = false;
          }else{
            this.$.beerName.invalid = true;
          }
      },


      _validateAll: function (){
        var name  = !this.$.beerName.invalid;
        // var description  = !this.$.description.invalid;
        var abv  = !this.$.abv.invalid;
        var search = false;

        if(typeof this.selectedStyle === 'object'){
          search  = (Object.keys(this.selectedStyle).length >0) ? true:false;
        }

        if(name && abv && search){
          this.valid = true;

        }else{
          this.valid = false;
        }

      },

   
        // _resetFormStyleData: function (){
        //   this.styleName = ''
        //   this.styleId = ''
        //   this.$.options.hidden = false;

        // },
        

     _addNewBeer: function (){
        this._validateAll();
        if(this.valid){

          var beer = {};
          var org = {};
          var obj = {};
          var category = this.selectedStyle
          var pub = this.organization;

          var pre = 'brewBeer/';
         
          obj['beerLastUpdated'] = Date.now();
          
          if(this.beerId){
            var id = this.beerId
            obj[pre+id+'/lastEdited'] = Date.now();
            obj[pre+id+'/edited'] = true;
            
          }else{
            var id = firebase.database(this.$.auth.app).ref('beer').push().key;
            obj[pre+id+'/createDate'] = Date.now();
            obj[pre+id+'/new'] = true
          }
          var orgPre = pre+id;

          
          if(this.abv){
            obj[orgPre+'/abv'] = Number(this.abv);
          }
          if(category.category){
            obj[orgPre+'/category'] = category.category;
          }
          if(category.categoryName){
            obj[orgPre+'/categoryName'] = category.categoryName;
          }
          if(category.categoryTitle){
            obj[orgPre+'/categoryTitle'] = category.categoryTitle;
          }
          if(category.order){
            obj[orgPre+'/order'] = Number(category.order);
          }

          if(category.styleId){
            obj[orgPre+'/styleId'] = Number(category.styleId);
          }

          if(category.styleName){
            obj[orgPre+'/styleName'] = category.styleName; 
          }

          if(this.description){
            obj[orgPre+'/description'] = this.description;
          }
          if(id){
            obj[orgPre+'/id'] = id;
          }
          //only replace name if new, not editing
          if(this.beerName){
            if(!this.beerId){
              obj[orgPre+'/name'] = this.beerName;
            }
          }
        

          var that = this;
         
          if(this.owner){
            obj[orgPre+'/status'] = 'verified';
          }else{
            obj[orgPre+'/status'] = 'not_verified';
          }
          // console.log('save', JSON.stringify(obj));
            
             
          this.$.pub.ref.update(obj)
            .then(function(){

              console.log("Saved");
              that.$.savedToast.open();
              that.savedMessage = that.beerName;
              if(!that.beerId){
                that.abv = '';
                that.beerName = '';
                that.description = '';
                that.valid = false;
                that.searchString = '';
                that.selectedStyle={};
                // that._resetFormStyleData();
              }
            })
            .catch(function (error) {
              console.log("Error" + error);
            })
    
        }else{
          console.log('not valid');
        }

      },


      _computeNameForUrl: function (name) {
        'use strict';
        if (name) {
          name = name.replace(/\s/g, '-')
          return name.replace(/[^a-zA-Z\d\s:]/g, '');
        } else {
          return 'unknown-name'
        }
      },

      _test(obj){
        console.log('test', obj);
      }


    });

  </script>

</dom-module>
