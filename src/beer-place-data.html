<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../bower_components/google-apis/google-maps-api.html">
<!--<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">-->
<link rel="import" href="../bower_components/app-storage/app-storage-behavior.html">


<dom-module id="beer-place-data">

  <template>


   <google-maps-api id="map" api-key="AIzaSyBPa6XlVFjF48fEyNT3qtnkFTZ0_dGMAzI" version="3.exp"></google-maps-api>
<!--TEST[[placeId]]-->

<!--<app-localstorage-document 
      key="place_[[orgId]]" 
      data="{{localOrganizationData}}">
  </app-localstorage-document>-->
  

    
  </template>

  <script>

    Polymer({

      is: 'beer-place-data',

       properties: {

          data:{
            type: Object,
            notify: true
          },

          placeId: {
            type: String
          },

          online:{
            type: Boolean,
            value: true
          },

          hasLocalPlaceData:{
            type: Boolean,
            value: false
          },

          mapHasLoaded:{
            type: Boolean,
            value: false
          },
        },

        behaviors: [Polymer.AppStorageBehavior],

        listeners: {'api-load':'_mapHasLoaded' },
        observers: ['_getPlaceData(placeId, mapHasLoaded, online)'],

        _mapHasLoaded: function () {
          this.mapHasLoaded = true;
        },


        _getPlaceData: function (placeId, mapHasLoaded, online){
          // console.log(online);
         
          if(!online){
              var path = 'place_'+placeId;
            var data = window.localStorage.getItem(path);
           
            if(data){
              try{
                var localData = JSON.parse(data);
                  if(localData){
                  console.log('local');
                  this.data = JSON.parse(data);
                  }
                // console.log(this.data);
                }catch (error){
                console.error('Cannot parse data '+error);
                // this._getGoogleDetails(placeId);
              }
            }

          }else{
             //clean up local storage
            for ( var i = 0; i<window.localStorage.length; i++ ) {
              try{
                var timestamp = JSON.parse(window.localStorage.getItem(window.localStorage.key(i))).cacheTimestamp;
                if(timestamp){
                  if((timestamp) < Date.now()){
                    window.localStorage.removeItem(window.localStorage.key(i));
                    console.log('removed cache item');
                  }
                }
              }catch (error) {
                console.log('CACHE CLEANUP ERROR: '+error);
                window.localStorage.removeItem(window.localStorage.key(i));
              }
            }
            //get details data
            if(mapHasLoaded){
                console.log('google');
                this._getGoogleDetails(placeId);
          
            }
          }
        },
        

         _getGoogleDetails: function (placeId){
          // console.log("LOADED MAP", this.mapHasLoaded)
          if(placeId){
            var map = this.$.map;
            var that = this;
            var parameter = {};
            parameter.placeId = placeId;
            // console.log(parameter);
            var places = new google.maps.places.PlacesService(map);
              places.getDetails(parameter, function (result, status){
                    that.data = result;
                    
                    // console.log(status);
                    // console.log(result);

                    if(result){
                      result.cacheTimestamp = Date.now()+86400000;
                      window.localStorage.setItem('place_'+placeId, JSON.stringify(result));
                    }
              })
            }
        },


    });

  </script>

</dom-module>
