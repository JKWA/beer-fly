<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">

<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">



<dom-module id="beer-beer-add">


  <template>

    <style>

      a{
        color: var(--app-accent-color);
        text-decoration: none;
        }

      .card{
        margin: 10px;
        padding: 20px;
      }


      .abv {
        width: 100px;
      }

      .style {
         max-width: 500px;
         margin: 0 0 30px 0
      }

      .option {
        height:100px;
        overflow-y: scroll;
        
      }

      
      paper-item {
          color: var(--app-primary-color);
          --paper-item-min-height: 20px;
          font-size: 1em;
          font-weight: 400;
      }

      .button{
         color: var(--app-accent-color);
      }

    </style>

    <firebase-query
        app-name="beer"
        id="styles"
        path="beerStyle"
        data="{{styles}}"
        >
    </firebase-query>

    <firebase-document
        app-name="beer"
        id="category"
        path="category/STYLE/[[styleId]]">
    </firebase-document>

    <!--<firebase-document
        app-name="beer"
        id="organization"
        path="organization/[[orgId]]">
    </firebase-document>-->

    <firebase-document
        app-name="beer"
        id="newBeer"
        path="beer">
    </firebase-document>

    <firebase-document
        app-name="beer"
        id="allData"
        path="">
    </firebase-document>

     <firebase-document
        app-name="beer"
        id="beer"
        disabled
        path="beer/[[editBeerId]]"
        data="{{beer}}">
    </firebase-document>
    <!--THIS "beer/[[editBeerId]]" [[beer.name]]-->

    <paper-material class="card" elevation="0">
      <div>Brewed by [[organization.name]] - [[organization.city]], [[organization.stateAbbreviation]]</div>
      <div>Saved: [[savedBeerName]]</div>  
        <paper-input 
          id="name"
          label="Beer Name" 
          char-counter 
          maxlength="100" 
          error-message="Required"
          value="{{name}}">
        </paper-input>

        <paper-textarea 
          id="description"
          label="Beer Description" 
          error-message="Required"
          char-counter 
          maxlength="500" 
          value="{{description}}">
        </paper-textarea>

        <paper-input 
            id="abv" 
            class="abv" 
            label="ABV" 
            error-message="Invalid"
            value="{{abv}}">
          <div suffix>%</div>
        </paper-input>


        <paper-input 
            id="search"
            class="style"
            label="Beer Style" 
            value="{{searchString}}" 
            validator="_validateStyle"
            error-message="Choose a style from below"
            on-keydown="_resetFormStyleData">
        </paper-input>

        <div id="options" class="option">
          
         <template is="dom-repeat" items="[[styles]]" filter="{{_filterByName(searchString)}}" as="style" >
            <paper-item beer="[[style]]" on-click="_setInputString">
                <div option-name>[[style.name]]</div>
            </paper-item>
          </template>
        </div>
    
          <input type="hidden" name="styleName" value="{{styleName}}">
          <input type="hidden" name="styleId" value="{{styleId}}">
          <!--<input type="hidden" name="description" value="[[description]]">
          <input type="hidden" name="abv" value="[[abv]]">
          <input type="hidden" name="orgId" value="[[orgId]]">
          <input type="hidden" name="nameUrl" value="[[nameUrl]]">
          <input type="hidden" name="name" value="[[name]]">
          <input type="hidden" name="breweryId" value="[[breweryId]]">
          <input type="hidden" name="uid" value="[[uid]]">-->

          <iron-label >
              <paper-button id="submitButton" on-tap="_addNewBeer" disabled="[[valid]]" class="button">[[buttonName]]</paper-button>
          </iron-label>
          <paper-button dialog-dismiss autofocus>CLOSE</paper-button>

    
    </paper-material>
 
    

  </template>

  <script>

    Polymer({

      is: 'beer-beer-add',

      properties:{
        styleName:{
          type: String,
        },
        searchString:{
          type: String,
        },
        savedBeerName:{
          type: String
        },
        valid:{
          type: Boolean,
          value: false
        },
        editBeerId:{
          type: String,
          notify: true
        },
        beer: {
          type: Object
        }

      },

      observers:[
        '_validateStyleData(searchString)',
        '_validateABV(abv)',
        '_validateName(name)',
        '_validateDescription(description)',
        '_validateAll(name, description, abv, searchString)',
        '_prefillData(beer)',
        '_ifEditBeerId(editBeerId)'
      ],

      ready: function (){
        this.$.description.invalid = true;
      },

      _ifEditBeerId: function (editBeerId) {
        if(editBeerId){
          this.$.beer.disabled = false;
          this.buttonName = "EDIT BEER";
        }else{
          this.$.beer.disabled = true;
          this.name = null;
          this.description = null;
          this.searchString = null;
          this.styleName = null;
          this.styleId = null;
          this.buttonName = "ADD BEER";

        }
      },

      _prefillData: function (beer) {
        
        if(beer){
            // console.log('test');
            
            // console.log(beer);
            this.name = beer.name;
            this.description = beer.description;
            if(beer.abv){
              this.abv = beer.abv;
            }
            this.searchString = beer.styleName;
            this.styleName = beer.styleName;
            this.styleId = beer.styleId;
            this._validateStyleData(beer.styleName);
            this._validateAll();
            
        }else{
           

        }
        // this.editBeerId = false
      },


      _validateStyleData: function (searchString){
          if(searchString){
            if(searchString === this.styleName){
              this.$.search.invalid = false;
              this.$.options.hidden = true;
            }else{
              this.$.search.invalid = true;
              this.$.options.hidden = false;
            }
          }else{
            this.$.search.invalid = true;
            this.$.options.hidden = false;
          }
      },

      _validateABV(abv){
        if(abv){
          if(abv >0 && abv <=30){
            this.$.abv.invalid = false;
          }else{
            this.$.abv.invalid = true;
          }
        }else{
          this.$.abv.invalid = false;
        }
      },

      _validateName(name){
        if(name){
            this.$.name.invalid = false;
          }else{
            this.$.name.invalid = true;
          }
      },

      _validateDescription(description){
        if(description){
            this.$.description.invalid = false;
          }else{
            this.$.description.invalid = true;
          }
      },

      _validateAll(){
        // console.log( this.$.description.invalid);
        var name  = !this.$.name.invalid;
        var description  = !this.$.description.invalid;
        var abv  = !this.$.abv.invalid;
        var search  = !this.$.search.invalid;
        // console.log('name',name)
        // console.log('description',description)
        // console.log('abv',abv)
        // console.log('search',search)

        if(name && description && abv && search){
          // console.log("VALID")
          this.valid = true;
         
          // this.$.submitButton.disabled = false;

        }else{
          this.valid = false;
          // console.log("NOT VALID");
         
          // this.$.submitButton.disabled = true;
        }

      },

   
        _resetFormStyleData: function (){
          this.styleName = ''
          this.styleId = ''
          this.$.options.hidden = false;

        },
        

       _filterByName: function(string) {
        if (!string) {
          
          return null;
        } else {
          string = string.toLowerCase();
          return function(style) {
            var first = style.name.toLowerCase();
            return (first.indexOf(string) != -1);
          };
        }
      },

      _setInputString: function(event){
        var style = event.currentTarget.beer;
        this.styleName = style.name;
        this.styleId = style.$key;
        this.searchString = style.name;
        this.$.options.hidden = true;

      },

      _addNewBeer: function (){
        this._validateAll();
        if(this.valid){
        var beer = {};
        var org = {};
        var obj = {};
        var category = this.$.category.data;
        var pub = this.organization;

        if(this.editBeerId){
          var id = this.editBeerId
          obj['beer/'+id+'/lastEdited'] = new Date();
          obj['beer/'+id+'/edited'] = true;
        }else{
          var id = this.$.newBeer.ref.push().key;
          obj['beer/'+id+'/createDate'] = new Date();
          obj['beer/'+id+'/new'] = true
        }

        if(this.abv){
          org.abv = Number(this.abv);
        }
        org.category = category.type;
        org.categoryName = category.name;
        org.description = this.description;
        org.categoryTitle = category.title;
        org.id = id;
        org.name = this.name;
        org.order = Number(category.order);
        org.styleId = Number(this.styleId);
        org.styleName = this.styleName; 
        
        if(this.abv){
          obj['beer/'+id+'/abv'] = Number(this.abv);
        }
        if(category.type){
          obj['beer/'+id+'/category'] = category.type;
        }
        if(category.name){
          obj['beer/'+id+'/categoryName'] = category.name;
        }
        if(category.title){
          obj['beer/'+id+'/categoryTitle'] = category.title;
        }
        if(category.order){
          obj['beer/'+id+'/order'] = Number(category.order);
        }
        if(this.description){
          obj['beer/'+id+'/description'] = this.description;
        }
        if(id){
          obj['beer/'+id+'/id'] = id;
        }
        if(this.name){
          obj['beer/'+id+'/name'] = this.name;
        }
        if(category.order){
          obj['beer/'+id+'/order'] = Number(category.order);
        }
        if(this.styleId){
          obj['beer/'+id+'/styleId'] = Number(this.styleId);
        }
        if(this.styleName){
          obj['beer/'+id+'/styleName'] = this.styleName;
        }
        if(pub.breweryId){
          obj['beer/'+id+'/breweryId'] = pub.breweryId;
        }
        if(pub.name){
          obj['beer/'+id+'/breweryName'] = pub.name;
        }
        if(pub.city){
          obj['beer/'+id+'/city'] = pub.city;
        }
        if(pub.domain){
          obj['beer/'+id+'/domain'] = pub.domain;
        }
        if(pub.place_id){
          obj['beer/'+id+'/place_id'] = pub.place_id;
        }
        if(pub.state){
          obj['beer/'+id+'/state'] = pub.state;
        }
        if(pub.stateAbbreviation){
          obj['beer/'+id+'/stateAbbreviation'] = pub.stateAbbreviation;
        }
        if(this.uid){
          obj['beer/'+id+'/uid'] = this.uid;
        }
        
        obj['beer/'+id+'/status'] = 'not-verified'

        // beer.abv = Number(this.abv);
        // beer.category = category.type;
        // beer.categoryName = category.name;
        // beer.categoryTitle = category.title;
        // beer.description = this.description;
        // beer.id = id;
        // beer.name = this.name;
        // beer.order = Number(category.order);
        // beer.styleId = Number(this.styleId);
        // beer.styleName = this.styleName;
        
        // beer.breweryId = pub.breweryId;
        // beer.breweryName = pub.name;
        // beer.city = pub.city;
        // beer.domain = pub.domain;
        // beer.place_id = pub.place_id;
        // beer.state = pub.state;
        // beer.stateAbbreviation = pub.stateAbbreviation;
        // beer.uid = this.uid;
        // // beer.createDate = new Date();
        // beer.status = 'not-verified'
       
        
        
        obj['organization/'+pub.place_id+'/brewBeer/'+id] = org;
        // obj['beer/'+beer.id] = beer;
  
        var app = this.$.category.app;
        var that = this;

        firebase.database(app).ref().update(obj, function(error) {
          if (error){
            console.log("Error" + error);
          }else{
            console.log("Saved");
            if(that.savedBeerName){
              that.savedBeerName += ', '+beer.name;
            }else{
              that.savedBeerName = beer.name;
            }
            if(!that.editBeerId){
            that.abv = '';
            that.name = '';
            that.description = '';
            that.valid = false;
            that.searchString = '';
            that._resetFormStyleData();
            }
          }
        });
        }else{
          console.log('not valid');
        }

      },

  
      

      _sortStyleName: function(){

      }

    });

  </script>

</dom-module>
