<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-from-right-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-right-animation.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">

<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">

<link rel="import" href="../my_components/data/upload-image.html">

<link rel="import" href="beer-fab.html">
<link rel="import" href="beer-icons.html">

<dom-module id="beer-menu">

  <template>

    <style>
      a{
        color: var(--app-accent-color);
        text-decoration: none;
        }

      .add{
        color: green;
        margin: 20px 0 20px 20px;
      }

      .card{
        margin: 10px;
        padding: 20px;
      }

      .motto {
        font-size: 2.0em;
        font-weight: 500;
        margin: 0 5px 0 20px;
        color: var(--app-primary-color);
      }

      .description {
        font-size: 1.2em;
        font-weight: 300;
        margin: 10px 5px 0 20px;
      }

      .category{
        /*margin: 20px 0 20px 0;*/
      }

      .menu{
         @apply(--layout-vertical);
      }

      .category-title{
        font-size: 2em;
        font-weight: 200;
        line-height: 70px;
        color: var(--app-accent-color);
      }

      .category-description{
        font-size: 1em;
        font-weight: 300;
        text-align: center;
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
      }

      /*.category-break{
         @apply(--layout-horizontal);
         @apply(--layout-center-justified);
         font-size: 2.25em;
         color: var(--app-accent-color);
         margin: 20px 0 10px 0;
      }*/


      .menu-category{
         @apply(--layout-horizontal);
         @apply(--layout-center-justified);
      }

      .menu-title{
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        color: var(--app-primary-color);
        font-size: 1.2em;
        font-weight: 400;
        line-height: 40px;
      }

      .menu-description{
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        font-size: .9em;
        font-weight: 300;
        color: var(--app-secondary-color);
        text-align: center;
      }

      .menu-item{
        margin: 20px 0
      }

      .menu-item > div{
        margin: 5px 0
      }

      .price-wrapper{
         @apply(--layout-horizontal);
         @apply(--layout-around-justified);
         @apply(--layout-wrap);
         color: var(--app-primary-color);
         font-size: 1em;
         font-weight: 300;
      }

      /*.price-cost{
        font-size: 1em;
        font-weight: 300;
      }

      .price-size{
        font-size: 1em;
        font-weight: 300;
      }*/

    </style>

    <firebase-auth  
        app-name="beer" 
        id="auth"
        user="{{user}}">
    </firebase-auth>


    <iron-image 
        style="width:100%; height:300px; background-color: #F8F8F8;"
        sizing="cover" 
        preload 
        placeholder="[[placeholder]]"
        fade
        src="[[photoUrl]]">
    </iron-image>

    <beer-fab owner="[[owner]]" on-tap="_edit"></beer-fab>

    <div class="motto">
        [[category.motto]]
    </div>
    <div class="description">
        [[category.description]]
    </div>


    <div class="menu">
[[owner]]
      <!--[[menuItemId]]-->
      <template is="dom-if" if="[[owner]]">
        <paper-material class="card"  elevation="1">
          <iron-label  class="add">
              <paper-icon-button 
                    icon="beer-icons:add" 
                    on-tap="_addMenuCategory">
                    
              </paper-icon-button>
            Add Category
          </iron-label>
        </paper-material>
      </template>


    <template is="dom-repeat" items="[[_toArray(category.menu)]]" as="menu" sort="_categoryOrder">
      <paper-material class="card" elevation="1">
      <template is="dom-if" if="[[owner]]">
        <iron-label>
          <a aria-label$="TEST" href$="/[[nameUrl]]/menu-edit?orgid=[[orgId]]&menuCategory=[[menu.id]]">
            <paper-icon-button icon="beer-icons:edit"></paper-icon-button>
            Edit</a>
        </iron-label>
      </template>
    
        <div class="category">
          <div class=" menu-category category-title">[[menu.name]]</div>
          
          
            <template is="dom-repeat" items="[[_addBreaks(menu.description)]]" as="categoryDescription">
              <div class="category-description">[[categoryDescription]]</div>
            </template>
          
          

          <template is="dom-repeat" items="[[_toArray(menu.item)]]" as="menuItem">
            <!--[[menuItem.id]]-->
            <div id="[[menuItem.id]]" class="menu-item">
            <div class="menu-title">[[menuItem.name]]</div>
            <template is="dom-repeat" items="[[_addBreaks(menuItem.description)]]" as="description">
                <div class="menu-description">[[description]]</div> 
            </template>
            <div class="price-wrapper">
            <template is="dom-repeat" items="[[_toArray(menuItem.price)]]" as="price">
              <div class="price-wrapper">
                <div hidden="[[!price.size]]" class="price-size">[[price.size]]:&nbsp</div> 
                <div class="price-cost">$[[price.cost]]</div> 
              </div>
            </template>
            </div>

          
            
            <!--<div hidden="[[!menuItem.price]]">
                <div class="menu-price">$[[menuItem.price]]</div> 
            </div>-->

        <!--</paper-material>-->
            </div>
          </template>
          
          
        <div>
    </template>
    </div>


   

    <paper-dialog 
        id="editDialog"
        with-backdrop
        style="width: 90vw;"
        entry-animation="slide-from-right-animation"
        exit-animation="slide-right-animation">
            
      <div class=""> 
          <h3>[[category.title]]</h3>
      </div>
      <template is="dom-if" if="[[owner]]">
      <paper-dialog-scrollable >
       <!--<beer-menu-edit org-id="[[orgId]]" category="{{category}}"></beer-menu-edit>-->
       
      </paper-dialog-scrollable>
      </template>

      <div class="">
        <paper-button dialog-dismiss autofocus>CLOSE</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>

    Polymer({

      is: 'beer-menu',
      properties: {

        photoUrl: {
          type: String,
          computed: '_computePhotoUrl(category, place)'
        },

        category:{
          type: Object
        },

        menuItemId:{
          type: String
        },

        owner:{
          type: Boolean
        }
      },

      observers:['_watchMenuItemId(menuItemId, category.item)'],

      ready: function (){
        // if(this.menuItemId){
        //   console.log(this.menuItemId);
        //   // this.$[this.menuItemId].scrollIntoView()
        //   var menuItems = this.category.item;
        //   if(typeof menuItems === 'object'){
        //     var key = Object.keys(menuItems)
        //     for(var i=0; i<key.length; i++){
        //       var menuItemKey = key[i]
        //       console.log(menuItemKey);
        //     }
        //   }

        // }
      },

      _watchMenuItemId: function(menuItemId){
        // this.$[menuItemId].scrollIntoView()
      },
       _addMenuCategory: function (){

         var database = firebase.database(this.$.auth.app).ref('organization/'+this.orgId+'/category/MENU/menu');
         var key = database.push().key;

        // var key = this.$.menu.ref.push(obj).key;
        var obj = {};
          obj.order = 99;
          obj.id = key;

          database.child(key).update(obj)
          .then(function (){
            console.log('NEW_CATEGORY_SAVED')
          }).catch(function(error){
            console.log('NEW_CATEGORY_SAVED_ERROR', error)
          }) 
      },
      
     _edit: function(){
        'use strict';
        var body = document.querySelector('body');
        Polymer.dom(body).appendChild(this.$.editDialog);
        this.$.editDialog.open()
      },

      _toArray: function (obj) {
        var returnArray = [];
        if(obj){
          var key = Object.keys(obj);
          
          for (var i=0; i<key.length; i++){
            // obj[key[i]].$key = key[i];
            returnArray.push(obj[key[i]]);
          }
        }
        return returnArray;
      },

      _categoryOrder: function(a,b){  
        'use strict';
        if(!a.order)
        return 0;
        if (a.order < b.order)
          return -1;
        if (a.order > b.order)
          return 1;
        return 0;
      },

      _addBreaks: function(str){
        'use strict';
        if(str){
          return str.split('\n');
        }else{
          return [];
        }
      },

      _computePhotoUrl: function (category, place) {
         try{
          if(category.image){
            if(category.image.banner){
              if(category.image.banner.url){
                return category.image.banner.url;
              }
            }
          }
          var photoMeta = {};
          var photos = place.photos
          var categoryIndex = 2
          if(photos.length < categoryIndex){
            categoryIndex = photos.length
          }
          photoMeta.maxWidth = place.photos[categoryIndex].width;
          photoMeta.maxHeight = place.photos[categoryIndex].height;
          return place.photos[categoryIndex].getUrl(photoMeta);
         
       }catch (error){

       }
      },

      _scrollTag: function (menuItem, menuItemId){
          if(menuItem === menuItemId){
            
          }
      },

      _test: function (obj){
        console.log(obj);
      }

    

    });

  </script>

</dom-module>
