

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-location/iron-location.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/google-apis/google-maps-api.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-from-right-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-down-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-from-bottom-animation.html">

<link rel="import" href="beer-icons.html">
<link rel="import" href="beer-rating-card.html">
<link rel="import" href="beer-home-dialog.html">

<link rel="import" href="beer-pub-card.html">
<link rel="import" href="beer-login.html">



<dom-module id="beer-home">

  <template strip-whitespace>
    
    <style include="paper-material-styles">

      :host {
        display: block;
        max-width: 640px;
      }

     a{
      color: var(--app-primary-color);
      text-decoration: none;
     }

    paper-spinner-lite{
      position: absolute;
      top: 5%;
      right: 5%;
      font-size: .4em;

    }

    paper-material > div{
        margin: 10px
      }

    .card{
      padding: 10px;
      margin: 15px 10px;
      @apply --paper-material-elevation-1;
    }

    .title-wrapper{
       @apply --layout-horizontal;
       @apply --layout-justified;
       @apply --layout-wrap;
    }

    .locationAddress{
      font-size: 1.2em;
      font-weight: 500;
      color: var(--app-primary-color);
    }

   .title{
     font-size: 1em;
     font-weight: 500;
     color: var(--app-accent-color);
     margin: 10px 0
   }

   .location-list {
        color: var(--app-primary-color);
    }

   .geo-error{
      font-size: .8em;
      font-weight: 300;
      color: var(--app-secondary-color);
    }

    .flip{
      -webkit-transform: scale(1, -1);
      transform: scale(1, -1);
    }

    .distance {
      color: var(--app-secondary-color);
      font-size: 1.2em;
      font-weight: 300;
    }
    
    .name{
      font-size: 1.5em;
      font-weight: 300;
      color: var(--app-primary-color);
    }

    .address{
      color: var(--app-seconpdary-color);
      font-size: 1em;
      font-weight: 400;
    }

    .wrapper{
        @apply --layout-horizontal;
        font-size: 1em;
        font-weight: 300;
        color: var(--app-accent-color);
      }

      .location-label{
        margin: 10px 0
      }
      
      paper-input{
        margin: 0 10px;
        color: var(--app-accent-color);
      }

      paper-button{
        color: var(--app-accent-color);
      }

     
      
    </style>

    <firebase-auth 
        id="auth" 
        app-name="beer"
        user="{{user}}">
    </firebase-auth>

   

      <div class="card" elevation="1">
        <div class="locationAddress">[[location.address]]</div>
        <paper-spinner-lite id="spinner"></paper-spinner-lite>
        <div hidden$="[[!geoError]]">
          <div class="geo-error">Location not available from this device.</div>
        </div>
        <div class="">

          <iron-label class="wrapper">
              <paper-icon-button noink icon="beer-icons:[[gpsIcon]]" on-tap="_resetToLocal"></paper-icon-button>
              <span class="title">Near my location<span>
          </iron-label>

           <iron-label class="wrapper">

            <paper-icon-button class$="[[toggleClass]]" icon="beer-icons:expand-more" on-tap="_toggle"></paper-icon-button>

              <span class="location-label">Change location</span>
          </iron-label>
        </div>
       

          <iron-collapse opened="[[toggle]]" no-animation>        
              <paper-listbox
                attr-for-selected="location"
                selected-class="location-list" 
                class="location-list"
                selected="{{location}}"
                on-click="close">
                <template is="dom-repeat" items="[[sortedLocationHistory]]" as="history" sort="_sortLocation">
                  <paper-item location="[[history]]">[[history.address]]</paper-item>
              </template>
            </paper-listbox>
              <paper-input value="{{address}}" on-keydown="_watchForSubmit" label="City, State; or Zip"></paper-input>
            <paper-button on-click="_getGeoFromAddress">SET LOCATION</paper-button>
          </iron-collapse>
              
      </div>

   
      <div id="pubCards">
      <template id="repeater" is="dom-repeat" 
          items="{{allArray}}" as="pub" 
          initial-count="20"  sort="_sort" 
          observe="sort distance" filter="{{_computeFilter(radius)}}" >

         <beer-pub-card 
            
            open-edit-pub-crawl="{{openEditPubCrawl}}"
            place-id="[[pub.place_id]]"
            user-data="[[userData]]"
            edit-favorite="{{editFavorite}}"
            place="[[pub]]"
            edit-place="{{editPlace}}"
            user="[[user]]"
            name="[[pub.name]]"
            address="[[pub.vicinity]]"
            motto="[[pub.motto]]"
            distance="[[pub.distance]]"  
            photo-url="[[pub.mainImage.banner.url]]"
            thumbnail="[[pub.mainImage.banner.thumbnail]]"
            plan="[[pub.plan]]"
            dog-friendly="[[!pub.dogFriendly]]"
            patio="[[!pub.patio]]"
            over21="[[!pub.over21]]"
            login="{{login}}">
        </beer-pub-card>
     

      </template>
      </div>
    </div>

    </div>

    <beer-home-dialog 
          id="favoriteDialogEditor"
          entry-animation="slide-from-bottom-animation"
          exit-animation="slide-down-animation"
          with-backdrop
          edit-place="[[editPlace]]"
          edit-favorite="[[editFavorite]]"
          crawl-data="{{crawlData}}"
          opened="{{openEditPubCrawl}}"
          places="{{allArray}}"
          places-obj="{{allObject}}">
   TEST: [[editFavorite]]
       </beer-home-dialog>
   

    </paper-dialog>
    


     <!--<paper-dialog 
            id="favoriteDialogEditor"
           
            with-backdrop
            entry-animation="slide-from-bottom-animation"
            >
        <h2>Add to Beer-Crawl</h2>
        <paper-dialog-scrollable>
          [[editPlace.name]]
          [[editPlace.place_id]]
          <paper-dropdown-menu no-label-float label="Add to a Beer-Crawl">
        <paper-listbox 
            attr-for-selected="crawl"
            slot="dropdown-content" 
            class$="dropdown-content"
            selected="{{crawl}}">
   
          <template is="dom-repeat" items="{{crawlData}}" as="crawl" filter="_filterDeleted" sort="_sortByNew" observe="deleted">
              <paper-item crawl="[[crawl]]">[[crawl.name]]</paper-item>
          </template>

        </paper-listbox>
      </paper-dropdown-menu>
          

        </paper-dialog-scrollable>
         <div class="buttons">
          <paper-button on-tap="_updateCrawl">Add</paper-button>
          <paper-button dialog-dismiss autofocus>Close</paper-button>
        </div>
      </paper-dialog>-->

      <paper-dialog 
            entry-animation="scale-up-animation"
            exit-animation="fade-out-animation"
            with-backdrop
            id="loginDialog"
            opened="{{login}}">
        <paper-dialog-scrollable>
          <section class="beer-login-dialog">
            <!--lazy loaded-->
            <beer-login class="beer-login-dialog"></beer-login>
          </section>
        </paper-dialog-scrollable>
        <paper-button dialog-dismiss autofocus>CLOSE</paper-button>
      </paper-dialog>
  
      
    
</template>
  <script>

    Polymer({

      is: 'beer-home',

      properties: {

        address: {
          type: String
        },


        allObject:{
          type: Object,
          notify: true,
          observer: '_observeAllObj'
        },

        allArray: {
          type: Array,
          notify: true
        },

        crawlData:{
          type: Array
        },

        editPlace:{
          type:Object
        },

        editFavorite:{
          type:String,
          value:'TESTING'
        },

        favoriteDialogEditorOpen:{
          type:Boolean,
          value:false
        },


        idle:{
          type: Boolean,
          notify: true
        },

        geoError:{
          type: Boolean,
          value: false
        },



        gpsIcon:{
          type: String,
          value: 'gps-searching'
        },


        location: {
          type: Object,
          notify: true,
          observer: '_observeLocation'
        },

        locationHistory: {
          type: Object,
          
        },
        sortedLocationHistory: {
          type: Array
        },

      login: {
         type: Boolean,
         observer:'_watchLogin'
       },

       openEditPubCrawl:{
         type: Boolean,
         value:false
       },

       organization: {
         type: Object
       },

       radius:{
          type: Number,
          value: 10
       },

        searchString:{
          type: 'String',
          notify:true
        },

        toggle:{
          type: Boolean,
          value: false
        },

        toggleClass:{
          type: String
        },

        user:Object,

        userData:Object

      },


      ready: function (){
        var body = document.querySelector('body');
          Polymer.dom(body).appendChild(this.$.favoriteDialogEditor);
      },


       _watchLogin: function (newData, oldData){
        if(newData){
          var body = document.querySelector('body');
          Polymer.dom(body).appendChild(this.$.loginDialog);
          this.$.loginDialog.open();
        }
      },


      _observeLocation: function (newLocation, oldLocation){
        
        // console.log('newLocation', newLocation);
        // console.log('oldLocation', oldLocation);
        this.$.spinner.active = false;

        if(oldLocation){
          // this.allObject = {};
          // this.allArray = [];
        }
        
      },

      _observeAllObj: function (newObj, oldObj){
        // console.log('newObj', newObj);
        // console.log('oldObj', oldObj)
      },

      _isVisible: function (page){
        if(page ==='home'){
          this.visible = true;
        }else{
          this.visible = false;
        }
      },


      _resetToLocal: function (){
        this.$.spinner.active = true;
        // this.$.pubCards.hidden = true;
        // this.geoFireReady = false;
        // this.allObject = {};
        // this.allArray = [];
        // this.latitude = null;
        // this.longitude = null;
        this.gpsIcon = 'gps-searching'
        this.toggle = false;
        this.idle = false;
       
      },
  

      _watchForSubmit: function (event){
         var key = event.which || event.keyCode;
         if(key === 13){
          this._getGeoFromAddress();
         }
      },

      _getGeoFromAddress: function () {
        // this.allObject = {};
        // this.allArray = [];
        this.searchString = this.address;
        this.searchString = '';
        this.address = '';
        this.$.spinner.active = true;
        this.toggle =false;
      },

      _sort: function (a,b){
        // console.log('sorted');
        return parseFloat(a.sort) - parseFloat(b.sort) ;
      },

      _sortLocation: function(a,b){
        'use strict';
        if (a.address < b.address)
          return -1;
        if (a.address > b.address)
          return 1;
        return 0;
      },


      _defaultIcon: function (icon){
        if(icon){
          true;
        }else{
          false
        }
      },

      _computeFilter: function (radius){
        return function(pub) {
          if(pub){
          return pub.distance <=radius;
          }else{
            return false
          }
        };
      },

      _toggle: function (){
        this.toggle = !this.toggle
        if(this.toggle){
          this.toggleClass = 'flip'
        }else{
          this.toggleClass = '';
        }
      },

      

      


      close: function (){
        this.toggle = false;
        // this.searchString = this.address;
      },

      _test: function(obj){
          console.log("TEST",obj);
      }

    });

  </script>

</dom-module>
