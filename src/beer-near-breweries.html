<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/geofire-elements/geofire-query.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/app-storage/app-storage-behavior.html">




<!--<link rel="import" href="beer-near-breweries-card.html">-->
<link rel="import" href="beer-pub-card.html">

<dom-module id="beer-near-breweries">
  

  <template>

    <style>
    /*.body {
      height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
    }*/
    .card{
      padding: 10px;
      margin: 10px;
    }

    .title{
     font-size: 1em;
      font-weight: 500;
      margin: 30px 15px 0 15px;
      color: var(--app-accent-color);
   }
    

    .distance-wrapper {
      /*color: var(--app-secondary-color);*/
      margin: 0 5px 0 20px;
    }
    .slider{
      color: var(--app-accent-color);
    }

    .distance {
      color: var(--app-secondary-color);
      font-size: 1.2em;
      font-weight: 300;
    }

  </style>

  <firebase-document 
      app-name="beer" 
      id="pub"
      path="organization">
  </firebase-document>


    <geofire-query 
        id="query" 
        app="beer" 
        path="GeoFire"
        lat="[[latitude]]" 
        lng="[[longitude]]" 
        radius="[[distance]]" 
        results-array="{{breweries}}">
    </geofire-query>

    <!--<app-indexeddb-mirror
        key="breweries"
        data="{{breweries}}"
        persisted-data="{{persistedBreweries}}">
    </app-indexeddb-mirror>-->


    <!--<template is="dom-repeat" items="[[data]]" as="pub">
      
      <beer-pub-card 
        place-id="[[pub.place_id]]"
        name="[[pub.name]]"
        motto="[[pub.motto]]"
        address="[[pub.vicinity]]"
        dog-friendly="[[pub.dogFriendly]]"
        patio="[[pub.patio]]"
        over21="[[pub.over21]]"
        distance="[[pub.distance]]"
        login="{{login}}"
       >
    </beer-pub-card>
 
    </template>-->


  </template>

  <script>

    Polymer({

      is: 'beer-near-breweries',

       properties: {
          login: {
          type: Boolean,
          notify: true
          },
          data: {
            type: Array,
            notify: true
          },
          latitude:{
            type: Number
          },
          longitude:{
            type: Number
          },
          distance:{
            type: Number
          },
          breweries:{
            type: Array
          }
       },

      listeners: {'ready':'_getNearObjects' },
      behaviors: [Polymer.AppStorageBehavior],

    
   

      _getNearObjects: function () {
        var brewery = this.breweries;
        var distObj = {};
        var pubArray = [];
        var pubObj = {};
        var that = this;
        var counter=0;
        var data = this.data;
        for(var i=0; i<brewery.length; i++){
          var placeId = brewery[i].key;
          
          distObj[placeId] = brewery[i].distance;
         

        this.$.pub.ref.child(placeId).once('value').then(function(snapshot) {
          var result =  snapshot.val();
          // console.log(result);
          result.distance = distObj[result.place_id];
          
          if(!result.PREMIUM){
            result.sort = distObj[result.place_id]*1000;
            result.PREMIUM = false;
          }else{
            result.sort = distObj[result.place_id]
          }
          try{
            result.cacheTimestamp = Date.now();
            localStorage.setItem('orgainziation_'+result.place_id, JSON.stringify(result));
          }catch (error){
            console.log("LOCAL SAVE ERROR ", error)
          }

          // result.sort = sort;
          // result.distance = distance;
          // data.push(result);
          // pubArray.push(result);
          // pubObj[result.place_id] = result;
          return result;
 
          }).then(function(nextone){
            // console.log('next', nextone);
            pubObj[nextone.place_id] = nextone;
            counter++
            // console.log(counter);
            if(counter === brewery.length){
              // console.log('true')
              that.data = pubObj;
            }
            
          });
        // pubArray.push(pubObj);
        
        }
        // when(counter === brewery.length){
        // // var finalData = pubArray.sort(this._sort);
        // // console.log(finalData);

        // this.data = pubObj;
        // }
       

      },

     

    
      _test: function (obj){

      }
      


    });

  </script>

</dom-module>
