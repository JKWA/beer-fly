<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-from-right-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-left-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">

<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/simple-carousel/simple-carousel.html">
<link rel="import" href="../bower_components/paper-carousel/paper-carousel.html">



<link rel="import" href="beer-tv-card.html">




<dom-module id="beer-tv">

  <template>

    <style>

      a{
        color: var(--app-accent-color);
        text-decoration: none;
        }
      paper-dialog {
        background-color: rgba(255, 255, 255, 0.95)
      }
      .dialog{
         @apply(--layout-vertical);
         /*border: 3px solid red;*/
        
        
         
      }

      .beer{
       width: 100%;
        height: 120px;
      }

     /*paper-dialog { 
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 0;
        margin: 0;  
        width: 100%;
        height: 100%;      
     }*/

      .card{
        margin: 10px;
        padding: 20px;
      }

      .dialog{
        /*width: 100vw;
        height: 100vh;
        z-index: 100000;
        margin:-200px 0 0 0 ;
        background-color: green;*/
        
      }


      .motto {
        font-size: 2.0em;
        font-weight: 500;
        margin: 40px 5px 0 20px;
      }

      .description {
        font-size: 1.2em;
        font-weight: 300;
        margin: 10px 5px 0 20px;
      }

    </style>

    <div id="parent">
    
     <template id="dialogs" is="dom-repeat" items="[[_getArrays(organization.onTap)]]" as="card">
     
       <paper-dialog 
          style="width: 100vw; height: 100vh;"
          with-backdrop
          horizontal-offset="-30"
          vertical-offset="-30"
          entry-animation="fade-in-animation"
          exit-animation="fade-out-animation">

        <div class="dialog"> 
          
          <template is="dom-repeat" items="[[card]]">
            <div class="beer">
              <beer-tv-card 
                  beer-id="[[item.id]]"
                  tapped="[[item.tapped]]">
              </beer-tv-card>
            </div>
          </template>
         
        </div>

         <paper-button dialog-dismiss autofocus>CLOSE</paper-button>

       </paper-dialog>
    </template>
  


</div>


  </template>

  <script>

    Polymer({

      is: 'beer-tv',

      properties:{
        display:{
          type: Boolean,
          value: false
        },
        width:{
          type: Number,
          value: function(){
            return 1
            // return Math.floor(Math.max(document.documentElement.clientWidth, window.innerWidth || 0)/800);
          }
        },
        height:{
          type: Number,
          value: function(){
            return Math.floor(Math.max(document.documentElement.clientHeight, window.innerHeight || 0)/120);
          }
        },

        numberOfCards:{
          type: Number,
          computed:'_calculateNumberOfCardsPerPage(width, height)'

        },
        interval:{
          type: Number

        },

        numberOfDialogs:{
          type: Number,
          computed:'_calculateNumberOfDialogs'
        },

        numberOfDialogs:{
          type: Number,
          computed:'_calculateNumberOfDialogs(numberOfCards, organization.onTap)'
        }
      
      },
      observers:['_watchForNewData(organization.onTap)'],
      // observers: ['_watchForChangeInNumberOfDialogs(numberOfDialogs)'],
      ready: function (){
        this._openTvView();
      },



      _watchForNewData: function (tapped){
        // console.log('tapped',tapped);
        if(tapped){
          if(this.display){
            this.$.dialogs.render();
            this._openTvView();
            // this._stopInterval();
          }
        }

      },

      _calculateNumberOfDialogs: function (card, tap){
        var counter = 0
          if(tap){
            var key = Object.keys(tap);
            for (var i=0; i<key.length; i++){
              if(tap[key[i]].tapped === 'TAPPED'){
                counter++
              }
            }
            return Math.ceil(counter/card);
          }
          return 0;
      },

      // _watchForChangeInNumberOfDialogs(numberOfDialogs){
      //   console.log('dialog', this.$.dialogs.renderedItemCount)
      //    if(numberOfDialogs){
      //     if(this.display){
      //       if(numberOfDialogs<=1){
      //          if(this.interval){
      //             window.clearInterval(this.interval);
      //           }
      //       }
      //       this._openTvView();
      //       // this._stopInterval();
      //     }
      //   }
         
      // },

      // _calculateNumberOfDialogs(){
      //   // console.log()
        
      //   var body = document.querySelector('parent');
      //   var dialog =  Polymer.dom(this.$.parent).querySelectorAll('paper-dialog');
      //   return dialog.length;
      // },

      _watchForCardNumberChange(width, height){
        // this.numberOfCards = width*height;
        // console.log(this.numberOfCards);
        // if(this.numberOfCards){

        //   if(this.display){
        //     this._openTvView();
        //   }
        // }

      },

      _calculateNumberOfCardsPerPage: function (width, height){
        return width*height;
      },

    //  _stopInterval(){
    //    window.clearInterval(this.interval);
    //  },

      _openTvView: function(stop){
        'use strict';
        this.display = true;
        this.$.dialogs.render();
        var rendoredCount = this.$.dialogs.renderedItemCount;
        console.log('rendoredCount', rendoredCount)


        if(this.interval){
            window.clearInterval(this.interval);
        }
        var body = document.querySelector('parent');
        var dialog =  Polymer.dom(this.$.parent).querySelectorAll('paper-dialog');
        // console.log(this.numberOfDialogs, dialog.length);

        // if(this.numberOfDialogs <= 1){
          if(rendoredCount <=1){
          dialog[0].open();

        }else{
          var counter = 0
  
          dialog[counter].open();
          
         
         var interval = window.setInterval(function () {
            dialog[counter].close();
            counter = (counter + 1) % rendoredCount;
            dialog[counter].open();

            }, 10000); 
            // console.log('interval', interval);
            this.interval = interval;
        }
      },


      _getArrays: function(obj){

        'use strict';
        if(obj){
          var fullArray = [];
          var key = Object.keys(obj);
          for (var i=0; i<key.length; i++){
            if(obj[key[i]].tapped === 'TAPPED'){
              obj[key[i]].$key = key[i]
              fullArray.push(obj[key[i]])
            }
          }
           fullArray = fullArray.sort(this._sortOrder);

           var returnArray = [];
           var blockArray = [];
           var counter = 0;
           for(var i=0; i<fullArray.length; i++){
             blockArray.push(fullArray[i]);
             counter++
             if(counter === this.numberOfCards){
               returnArray.push(blockArray);
               blockArray = [];
               counter=0;
             }

           }
           if(blockArray.length >0){
             returnArray.push(blockArray);
           }
          //  console.log(returnArray);
           return returnArray;

        }


      },

    
      _sortOrder: function(a,b){
      
        'use strict';
        if (a.order < b.order)
          return -1;
        if (a.order > b.order)
          return 1;
        return 0;
      },

     
     
      _test: function (obj) {
        console.log(obj);
      }

    });

  </script>

</dom-module>
