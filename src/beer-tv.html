<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-from-right-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-left-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">


<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="beer-tv-dialog.html">
<link rel="import" href="beer-tv-card.html">


<dom-module id="beer-tv">

  <template>

  <style is="custom-style">
    
      :host {
        display: block;
        max-width: 640px;
      }

      a{
        color: var(--app-accent-color);
        text-decoration: none;
        }

      paper-dropdown-menu{
        width: 100px;
      }

      paper-dropdown-menu.light{
        --paper-input-container-color: var(--app-primary-color);
      }

      paper-dropdown-menu.dark{
        --paper-input-container-color: white;
        --paper-input-container-input-color: white;
      }

      paper-slider.light{
        --paper-slider-active-color: var(--app-accent-color);
        --paper-slider-knob-color: var(--app-accent-color);
      }

      paper-slider.dark{
        --paper-slider-active-color: white;
        --paper-slider-knob-color: white;
      }
      
      .dialog{
         @apply(--layout-vertical);
      }

      .wrapper{
        @apply(--layout-vertical);
      }

      .wrapper > div{
        margin: 20px 0 0 0
      }

      .beer{
        width: 100%;
        height: 120px;
      }

      .title{
        font-size: 1.5em;
        font-weight: 400;
        /*color: var(--app-primary-color);*/
      }

      .label{
        font-size: 1em;
        font-weight: 300;
        /*color: var(--app-primary-color);*/
      }

      .dark{
        background-color: #263238;
        color: white
      }

      .light{
        background-color: white
        color: var(--app-primary-color);
      }
      
      .card{
        margin: 10px;
        padding: 20px;
      }

      .speed-display{
        width: 50px
      }

    </style>

    <app-localstorage-document 
        key="tvSpeed" 
        data="{{sliderSpeedPercent}}">
    </app-localstorage-document>

    <app-localstorage-document 
        key="tvTheme" 
        data="{{theme}}">
    </app-localstorage-document>

    <app-localstorage-document 
        key="tvCards" 
        data="{{numberOfBeers}}">
    </app-localstorage-document>

    <paper-material class$="[[theme]] card" elevation="1">
      <div class="title">On Tap Slide Show Settings</div>
      <div class="wrapper">

        <div>
          <paper-dropdown-menu class$="[[theme]]" label="Theme">
            <paper-listbox 
                attr-for-selected="theme"
                slot="dropdown-content" 
                class$="dropdown-content [[theme]]"
                selected="{{theme}}">
              <paper-item theme="light">Light</paper-item>
              <paper-item theme="dark">Dark</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
        </div>
        
        <div>
            <paper-slider class$="[[theme]]" value="{{sliderNumberBeers}}"></paper-slider>
            <div class="label">[[numberOfBeers]] beers per slide</div>
        </div>

        <div>
          <paper-slider class$="[[theme]]" value="{{sliderSpeedPercent}}"></paper-slider>
          <div class="label">[[speedDisplay]] seconds between slides</div>
        </div>

        <div>
          <paper-button on-tap="_openTvView" raised>Start</paper-button>
        </div>
      </div>

    </paper-material>

        

    <div id="parent">
     
     <template id="dialogs" 
        is="dom-repeat" 
        items="[[data]]" 
        as="card"
        strip-whitespace>

       <beer-tv-dialog 
          entry-animation="fade-in-animation"
          exit-animation="fade-out-animation"
          with-backdrop
          theme="[[theme]]">

          <template is="dom-repeat" items="[[card]]" as="beer" strip-whitespace>
            <beer-tv-card 
                beer="[[beer]]">
            </beer-tv-card>
          </template>

       </beer-tv-dialog>
     
    </template>
    
    </div>
  </div>


  </template>

  <script>

    Polymer({

      is: 'beer-tv',

      properties:{

        organization:{
          type: Object
        }, 

        backgroundColor:{
          type: String,
          computed: '_computeBackgroundColor(theme)'
        },

        theme:{
          type:String,
          string:"light"
        },

        data:{
          type:Array
        },

        display:{
          type: Boolean,
          value: false
        },

        numberOfBeers:{
          type: Number,
          value: 5
        },

        interval:{
          type: Number

        },

        numberOfDialogs:{
          type: Number,
          computed:'_calculateNumberOfDialogs(numberOfBeers, organization.onTap)'
        },

        sliderNumberBeers:{
          type:Number,
          value:50
        },

        sliderSpeedPercent:{
          type:Number,
          value: 50
        },

        speed:{
          type:Number,
          value: 10000,
        },

        speedDisplay:{
          type:Number,
          value: 10
        }
      
      },

      observers:['_watchForNewData(organization.onTap, numberOfBeers)',
                  '_watchForTheme(theme)',
                  '_watchSpeedDisplayChange(sliderSpeedPercent)',
                  '_watchNumberBeerDisplayChange(sliderNumberBeers)'
                  ],

      ready: function (){
        // this._openTvView();
      },

      // _watchForNewData: function (tapped){
      //   if(tapped){
      //     if(this.display){
      //       this.$.dialogs.render();
      //       this._openTvView();
      //     }
      //   }

      // },

       _watchForNewData: function (obj, numberOfBeers){
         var returnArray = [];
       

          if(obj){
          var fullArray = [];
          var key = Object.keys(obj);
          for (var i=0; i<key.length; i++){
            if(obj[key[i]].tapped === 'TAPPED'){
              obj[key[i]].$key = key[i]
              fullArray.push(obj[key[i]])
            }
          }
           fullArray = fullArray.sort(this._sortOrder);

           var returnArray = [];
           var blockArray = [];
           var counter = 0;
           for(var i=0; i<fullArray.length; i++){
             blockArray.push(fullArray[i]);
             counter++

             if(counter == numberOfBeers){
               returnArray.push(blockArray);
               blockArray = [];
               counter=0;
             }

           }
           if(blockArray.length >0){
             returnArray.push(blockArray);
           }
          //  console.log(returnArray);
           

        
         
        }
        this.data =  returnArray;

      },

      _calculateNumberOfDialogs: function (card, tap){
        var counter = 0
          if(tap){
            var key = Object.keys(tap);
            for (var i=0; i<key.length; i++){
              if(tap[key[i]].tapped === 'TAPPED'){
                counter++
              }
            }
            return Math.ceil(counter/card);
          }
          return 0;
      },

      _openTvView: function(){
        'use strict';
        var speed = this.speed;
        this.display = true;
        this.$.dialogs.render();
        var rendoredCount = this.$.dialogs.renderedItemCount;
        console.log('rendoredCount', rendoredCount)


        if(this.interval){ 
            window.clearInterval(this.interval);
        }
        var body = document.querySelector('body');
       
      
         

        var dialog =  Polymer.dom(this.$.parent).querySelectorAll('beer-tv-dialog');

          if(rendoredCount <=1){
            Polymer.dom(body).appendChild(dialog[0]);
            dialog[0].open();
             

          }else{
            var counter = 0

            Polymer.dom(body).appendChild(dialog[counter]);
            dialog[counter].open();
          
          var interval = window.setInterval(function () {
              dialog[counter].close();
              counter = (counter + 1) % rendoredCount;
              Polymer.dom(body).appendChild(dialog[counter]);
              dialog[counter].open();

              }, speed); 
              // console.log('interval', interval);
              this.interval = interval;
          }
      },

      _closeTvView: function (){
        var dialog =  Polymer.dom(this.$.parent).querySelectorAll('beer-tv-dialog');
        console.log(dialog);
      },


      _computeSpeed: function (speedDisplay){
        console.log('speedDisplay',speedDisplay)
        if(speedDisplay){
          
          var speedDisplay = Number.parseInt(speedDisplay);
          if(speedDisplay){
          this.speed = speedDisplay*1000;

          }else{
            this.speed = 10000;
          }
        }
      },

      _watchForTheme: function (theme){

        Polymer.updateStyles({
              '--iron-overlay-backdrop-background-color': this.backgroundColor,
              '--iron-overlay-backdrop-opacity': '1',
              '--paper-dialog-background-color': this.backgroundColor
            });
      },


      _watchSpeedDisplayChange: function (display){
        var seconds = Math.ceil(display/5)
        if(seconds === 0){
          this.speedDisplay = 1
          this.speed = 1000

        }else{
          this.speedDisplay = seconds;
          this.speed = seconds*1000
        }
      },

      _watchNumberBeerDisplayChange: function (display){
        var numBeers = Math.ceil(display/10);
        if(numBeers === 0){
          this.numberOfBeers = 1
        }else{
          this.numberOfBeers = numBeers;
        }
      },


      _computeBackgroundColor: function (theme){
        if(theme === 'dark'){
          return '#263238'
        }else{
          return 'rgba(255, 255, 255, 0.95)'
        }
      },
    
      _sortOrder: function(a,b){
      
        'use strict';
        if (a.order < b.order)
          return -1;
        if (a.order > b.order)
          return 1;
        return 0;
      },

     
     
      _test: function (obj) {
        console.log(obj);
      }

    });

  </script>

</dom-module>
