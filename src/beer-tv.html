<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-from-right-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-left-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="../bower_components/paper-material/paper-material.html">

<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">






<link rel="import" href="beer-tv-card.html">




<dom-module id="beer-tv">

  <template>

    <style>

      a{
        color: var(--app-accent-color);
        text-decoration: none;
        }

      /*paper-dialog {
        background-color: rgba(255, 255, 255, 0.95)
      }*/

      /*.card{
        padding: 10px;
        margin: 10px;
      }*/
      .dialog{
         @apply(--layout-vertical);
      }

      .beer{
       width: 100%;
        height: 120px;
      }

      .dark{
        background-color:#263238;
        color: white
      }

      .light{
        background-color: rgba(255, 255, 255, 0.95);
        color: var(--app-primary-color);
      }
      
      .card{
        margin: 10px;
        padding: 20px;
      }

      .speed-display{
        width: 50px
      }

    </style>

    <paper-material class="card" elevation="0">
      
      <div>Time between slides</div>
      <div>
        <paper-input class="speed-display" label="seconds" value="{{speedDisplay}}"></paper-input>
      </div>
   
      <div>
        <iron-label>
          <paper-checkbox checked="{{darkTheme}}"></paper-checkbox>
          <span>Dark theme</span>
        </iron-label>
      </div>
      <div>
        <paper-button on-tap="_openTvView" raised>Start</paper-button>
      </div>
    </paper-material>



   <div class$="{{themeCss}}">
    <div id="parent">
    
     
     <template id="dialogs" is="dom-repeat" items="[[_getArrays(organization.onTap)]]" as="card">
       <paper-dialog 
          class$="{{themeCss}}"
          style="width: 100vw; height: 100vh;"
          with-backdrop
          horizontal-offset="-30"
          vertical-offset="-30"
          entry-animation="fade-in-animation"
          exit-animation="fade-out-animation">

        <div class="dialog"> 
          
          <template is="dom-repeat" items="[[card]]">
            <div class="beer">
              <beer-tv-card 
                  beer-id="[[item.id]]"
                  tapped="[[item.tapped]]"
                  theme="[[darkTheme]]">
              </beer-tv-card>
            </div>
          </template>
         
        </div>
        <div>Powered by Beer-Fly</div>
         <!--<paper-button dialog-dismiss autofocus>CLOSE</paper-button>-->

       </paper-dialog>
     
    </template>
    
    
    </div>


</div>


  </template>

  <script>

    Polymer({

      is: 'beer-tv',

      properties:{

        organization:{
          type: Object
        }, 

        darkTheme:{
          type:Boolean,
          value:false
        },

        themeCss:{
          type:String
        },

        theme:{
          type:String,
          string:"light"
        },

        display:{
          type: Boolean,
          value: false
        },

        width:{
          type: Number,
          value: function(){
            return 1
            // return Math.floor(Math.max(document.documentElement.clientWidth, window.innerWidth || 0)/800);
          }
        },
        height:{
          type: Number,
          value: function(){
            return Math.floor(Math.max(document.documentElement.clientHeight, window.innerHeight || 0)/120);
          }
        },

        numberOfCards:{
          type: Number,
          computed:'_calculateNumberOfCardsPerPage(width, height)'

        },

        interval:{
          type: Number

        },

        numberOfDialogs:{
          type: Number,
          computed:'_calculateNumberOfDialogs'
        },

        numberOfDialogs:{
          type: Number,
          computed:'_calculateNumberOfDialogs(numberOfCards, organization.onTap)'
        },

        speed:{
          type:Number,
          value: 10000,
        },

        speedDisplay:{
          type:Number,
          value: 10
        }

      
      },
      observers:['_watchForNewData(organization.onTap)',
                  '_watchSpeedFromDisplay(speedDisplay)',
                  '_watchForTheme(darkTheme)'],

      ready: function (){
        // this._openTvView();
      },



      _watchForNewData: function (tapped){
        if(tapped){
          if(this.display){
            this.$.dialogs.render();
            this._openTvView();
          }
        }

      },

      _calculateNumberOfDialogs: function (card, tap){
        var counter = 0
          if(tap){
            var key = Object.keys(tap);
            for (var i=0; i<key.length; i++){
              if(tap[key[i]].tapped === 'TAPPED'){
                counter++
              }
            }
            return Math.ceil(counter/card);
          }
          return 0;
      },


      _calculateNumberOfCardsPerPage: function (width, height){
        return width*height;
      },


      _openTvView: function(){
        'use strict';
        var speed = this.speed;
        this.display = true;
        this.$.dialogs.render();
        var rendoredCount = this.$.dialogs.renderedItemCount;
        console.log('rendoredCount', rendoredCount)


        if(this.interval){
            window.clearInterval(this.interval);
        }
        var body = document.querySelector('parent');
        var dialog =  Polymer.dom(this.$.parent).querySelectorAll('paper-dialog');
          if(rendoredCount <=1){
          dialog[0].open();

        }else{
          var counter = 0
  
          dialog[counter].open();
          
         
         var interval = window.setInterval(function () {
            dialog[counter].close();
            counter = (counter + 1) % rendoredCount;
            dialog[counter].open();

            }, speed); 
            // console.log('interval', interval);
            this.interval = interval;
        }
      },

      _closeTvView: function (){

      },


      _getArrays: function(obj){

        'use strict';
        if(obj){
          var fullArray = [];
          var key = Object.keys(obj);
          for (var i=0; i<key.length; i++){
            if(obj[key[i]].tapped === 'TAPPED'){
              obj[key[i]].$key = key[i]
              fullArray.push(obj[key[i]])
            }
          }
           fullArray = fullArray.sort(this._sortOrder);

           var returnArray = [];
           var blockArray = [];
           var counter = 0;
           for(var i=0; i<fullArray.length; i++){
             blockArray.push(fullArray[i]);
             counter++
             if(counter === this.numberOfCards){
               returnArray.push(blockArray);
               blockArray = [];
               counter=0;
             }

           }
           if(blockArray.length >0){
             returnArray.push(blockArray);
           }
          //  console.log(returnArray);
           return returnArray;

        }


      },

      _watchSpeedFromDisplay: function (speedDisplay){
        console.log(speedDisplay)
        if(speedDisplay){
          
          var speedDisplay = Number.parseInt(speedDisplay);
          if(speedDisplay){
          this.speed = speedDisplay*1000;

          }else{
            this.speed = 10000;
          }
        }
      },

      _watchForTheme: function (){
        console.log(this.darkTheme)
        var theme = this.darkTheme ? "dark" : "light"
        this.themeCss = theme;
      },
      

    
      _sortOrder: function(a,b){
      
        'use strict';
        if (a.order < b.order)
          return -1;
        if (a.order > b.order)
          return 1;
        return 0;
      },

     
     
      _test: function (obj) {
        console.log(obj);
      }

    });

  </script>

</dom-module>
