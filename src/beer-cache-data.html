

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-storage/app-storage-behavior.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">



<dom-module id="beer-cache-data">

  <template>



</template>
  <script>

    Polymer({

      is: 'beer-cache-data',

      properties: {

        allObject:{
          type:Object,
          notify: true,
        },

        allArray:{
          type:Array,
          notify: true,
          value: function (){[];}
        },

        initialLoad:{
          type: Boolean,
          value: true
        },

        location:{
          type:Object
        },

        online:{
          type: Boolean
        },

        radius:{
          type: Number,
          value: 10
        },

      },
      
      observers:[' _getInitialCache(location)'],

      ready: function (){
        // this.initialLoad = true;
        // this.allArray = [];
        // this.allObject = {};
        // console.log('readycache')
        // _getInitialCache()
      },


      _getInitialCache: function (location){
        try{
          // console.log('location', location)
          if(location){
      
          if(this.initialLoad){

            for ( var i = 0; i<window.localStorage.length; i++ ) {
                  
              try{
                if(window.localStorage.getItem(window.localStorage.key(i)) !== undefined){

                var storedItem = JSON.parse(window.localStorage.getItem(window.localStorage.key(i)));

                if(storedItem.organization){
                  if(storedItem.place_id){
                    if(storedItem.cacheTimestamp) {

                      storedItem.distance = this._distance (location.latitude, location.longitude, storedItem.latitude, storedItem.longitude);
                     
                      if(storedItem.distance <= 10){
                        if(!this.allObject[storedItem.place_id]){
                          var position = this.push('allArray',storedItem);
                          storedItem.arrayPosition = position;
                          this.set(`allObject.${storedItem.place_id}`, storedItem);
                        }
                      }
                     
                    }
                  }
                  }else{
                      window.localStorage.removeItem(window.localStorage.key(i));
                  }
                }
              
              
            }catch (error){
              console.log('preset error', error);
              console.log('caused-error', window.localStorage.getItem(window.localStorage.key(i)))
            }
            }
            console.log('complete pre-load cache');
          }
          // console.log('test', this.allArray);
          
          this.initialLoad = false;
          this._removeOldCacheData();
          }
        }catch (error){
          console.log('CACHE_ERROR', error);
          this.allArray = [];
          this.allObject = {};
          this._removeOldCacheData();
        }
      },

    _removeOldCacheData: function (){
      if(this.online){
        for ( var i = 0; i<window.localStorage.length; i++ ) { 
          try{
            if(window.localStorage.getItem(window.localStorage.key(i)) !== undefined){
            var storedItem = JSON.parse(window.localStorage.getItem(window.localStorage.key(i)));
            var timestamp = storedItem.cacheTimestamp;
            if(timestamp){
              if(timestamp < Date.now()){
                window.localStorage.removeItem(window.localStorage.key(i));
                console.log('removed cache item');
              }
            }
            }else{
              window.localStorage.removeItem(window.localStorage.key(i));
            }
          }catch (error) {
            console.log('CACHE CLEANUP ERROR: '+error);
            window.localStorage.removeItem(window.localStorage.key(i));
          }
        }
      }

    },

      _distance: function (myLat, myLng, pubLat, pubLng){
          var R = 3959; 
          var dLat = this.deg2rad(pubLat-myLat);  
          var dLon = this.deg2rad(pubLng-myLng); 
          var a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.deg2rad(myLat)) * Math.cos(this.deg2rad(pubLat)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);

          var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
          var d = R * c; 
          return d
       },


       deg2rad: function (deg) {
              return deg * (Math.PI/180)
       },


      _test: function (obj){
        console.log('TEST', obj);
      }

    });

  </script>

</dom-module>
