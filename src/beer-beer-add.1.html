<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="beer-icons.html">

<dom-module id="beer-beer-add">


  <template>

    <style>

      a{
        color: var(--app-accent-color);
        text-decoration: none;
        }

      .card{
        margin: 10px;
        padding: 20px;
      }

      .abv {
        width: 100px;
      }

      .style {
         max-width: 500px;
         margin: 0 0 30px 0
      }

      .option {
        height:100px;
        overflow-y: scroll;
        
      }
      .beer-name{
        font-size: 1.25em;
        font-weight: 400;
        color: var(--app-primary-color);
      }

      .brewery-name {
        font-size: 1.7em;
        font-weight: 500;
        color: var(--app-primary-color);
      }

      .address {
        font-size: .9em;
        font-weight: 300;
        color: var(--app-primary-color);
      }

      .saved-message{
        font-size: 1em;
        font-weight: 400;
        color: green;
      }

      .error-message{
        font-size: 1em;
        font-weight: 400;
        color: red;
      }

      
      paper-item {
          color: var(--app-primary-color);
          --paper-item-min-height: 20px;
          font-size: 1em;
          font-weight: 400;
      }

      .button{
         color: var(--app-accent-color);
      }
      .action-wrapper{
         @apply(--layout-horizontal);
         @apply(--layout-justified);
      }

      .message-wrapper{
         @apply(--layout-horizontal);
         @apply(--layout-end-justified);
      }

    </style>

    <firebase-query
        app-name="beer"
        id="styles"
        path="beerStyle"
        data="{{styles}}"
        >
    </firebase-query>

    <firebase-document
        app-name="beer"
        id="category"
        path="category/STYLE/[[styleId]]">
    </firebase-document>

    <firebase-document
        app-name="beer"
        id="newBeer"
        path="beer">
    </firebase-document>

    <firebase-document
        app-name="beer"
        id="onTap"
        path="organization/[[orgId]]/onTap/[[editBeerId]]">
    </firebase-document>

    <firebase-document
        app-name="beer"
        id="allData"
        path="">
    </firebase-document>

     <firebase-document
        app-name="beer"
        id="beer"
        disabled
        path="beer/[[editBeerId]]"
        data="{{beer}}">
    </firebase-document>

    <!--THIS "beer/[[editBeerId]]" [[beer.name]]-->

    <paper-material class="card" elevation="0">

      <!--[[editBeerId]]-->
      <div class="brewed-by">
        <div class="brewery-name">Brewed by [[organization.name]]</div>
        <div class="address">[[organization.city]], [[organization.stateAbbreviation]]</div>
      </div>
      
       <div class="beer-name" hidden$="[[!editBeerId]]">[[name]]</div>
        <paper-input 
          hidden$="[[editBeerId]]"
          id="name"
          label="Beer Name" 
          char-counter 
          maxlength="100" 
          error-message="Required"
          value="{{name}}">
        </paper-input>

        <paper-textarea 
          id="description"
          label="Beer Description" 
          error-message="Required"
          char-counter 
          maxlength="500" 
          value="{{description}}">
        </paper-textarea>

        <paper-input 
            id="abv" 
            class="abv" 
            label="ABV" 
            error-message="Invalid"
            value="{{abv}}">
          <div suffix>%</div>
        </paper-input>

        <paper-input 
            id="search"
            class="style"
            label="Beer Style" 
            value="{{searchString}}" 
            validator="_validateStyle"
            error-message="Choose a style from below"
            on-keydown="_resetFormStyleData">
        </paper-input>

        <div id="options" class="option">
          
         <template is="dom-repeat" items="[[styles]]" filter="{{_filterByName(searchString)}}" as="style" >
            <paper-item beer="[[style]]" on-click="_setInputString">
                <div option-name>[[style.name]]</div>
            </paper-item>
          </template>
        </div>
    
          <input type="hidden" name="styleName" value="{{styleName}}">
          <input type="hidden" name="styleId" value="{{styleId}}">

          <div class="action-wrapper">
            <div>
              <iron-label >
                  <paper-button id="submitButton" on-tap="_addNewBeer" class="button">[[buttonName]]</paper-button>
              </iron-label>
              <paper-button dialog-dismiss autofocus>CLOSE</paper-button>
            </div>
            <div class="message-wrapper" id="message">
              <div>
                <paper-spinner-lite id="spinner"></paper-spinner-lite>
              </div>
              <div class="saved-message" id="saved" hidden>
                <iron-icon icon="beer-icons:save"></iron-icon>
              </div>
              <div class="error-message" id="error" hidden>
                <iron-icon icon="beer-icons:error"></iron-icon>
              </div>
            </div>
          </div>
    
    </paper-material>
 
    

  </template>

  <script>

    Polymer({

      is: 'beer-beer-add',
      behaviors: [ Polymer.NeonAnimationRunnerBehavior ],

      properties:{

        abv:{
          type: Number
        },

        beer: {
          type: Object
        },

        buttonName:{
          type:String
        },

        description:{
          type: String
        },
        
        editBeerId:{
          type: String,
          notify: true
        },

        name:{
          type: String
        },

        orgId:{
          type: String
        },

        organization:{
          type: Object
        },

        savedBeerName:{
          type: String
        },

        savedMessage:{
          type: String,
          value: 'test'
        },

        searchString:{
          type: String,
        },

        styles:{
          type: Array
        },

        styleId:{
          type: Number
        },

        styleName:{
          type: String,
        },

        valid:{
          type: Boolean,
          value: false
        },
       
        animationConfig: {
          value: function() {
            return {
              'entry': {
                // provided by neon-animation/animations/scale-up-animation.html
                name: 'scale-up-animation',
                node: this
              },
              'exit': {
                // provided by neon-animation-animations/fade-out-animation.html
                name: 'fade-in-animation',
                node: this.$.saved,
                timing: {delay: 1000}
                
              }
            }
          }
        }
      },

      observers:[
        '_validateStyleData(searchString)',
        '_validateABV(abv)',
        '_validateName(name)',
        '_validateDescription(description)',
        '_validateAll(name, description, abv, searchString)',
        '_prefillData(beer)',
        '_ifEditBeerId(editBeerId)'
      ],

      ready: function (){
        this.$.description.invalid = true;
      },

      _ifEditBeerId: function (editBeerId) {
        if(editBeerId){
          this.$.beer.disabled = false;
          this.buttonName = "SAVE";
        }else{
          this.$.beer.disabled = true;
          this.name = null;
          this.description = null;
          this.searchString = null;
          this.styleName = null;
          this.styleId = null;
          this.buttonName = "ADD BEER";

        }
      },

      _prefillData: function (beer) {
        
        if(beer){

            this.name = beer.name;
            this.description = beer.description;
            if(beer.abv){
              this.abv = beer.abv;
            }
            this.searchString = beer.styleName;
            this.styleName = beer.styleName;
            this.styleId = beer.styleId;
            this._validateStyleData(beer.styleName);
            this._validateAll();
            
        }else{
           

        }
        // this.editBeerId = false
      },


      _validateStyleData: function (searchString){
          if(searchString){
            if(searchString === this.styleName){
              this.$.search.invalid = false;
              this.$.options.hidden = true;
            }else{
              this.$.search.invalid = true;
              this.$.options.hidden = false;
            }
          }else{
            this.$.search.invalid = true;
            this.$.options.hidden = false;
          }
      },

      _validateABV: function (abv){
        if(abv){
          if(abv >0 && abv <=30){
            this.$.abv.invalid = false;
          }else{
            this.$.abv.invalid = true;
          }
        }else{
          this.$.abv.invalid = false;
        }
      },

      _validateName: function (name){
        if(name){
            this.$.name.invalid = false;
          }else{
            this.$.name.invalid = true;
          }
      },

      _validateDescription: function (description){
        if(description){
            this.$.description.invalid = false;
          }else{
            this.$.description.invalid = true;
          }
      },

      _validateAll: function (){
        var name  = !this.$.name.invalid;
        var description  = !this.$.description.invalid;
        var abv  = !this.$.abv.invalid;
        var search  = !this.$.search.invalid;

        if(name && description && abv && search){
          this.valid = true;

        }else{
          this.valid = false;
        }

      },

   
        _resetFormStyleData: function (){
          this.styleName = ''
          this.styleId = ''
          this.$.options.hidden = false;

        },
        

       _filterByName: function(string) {
        if (!string) {
          
          return null;
        } else {
          string = string.toLowerCase();
          return function(style) {
            var first = style.name.toLowerCase();
            return (first.indexOf(string) != -1);
          };
        }
      },

      _setInputString: function(event){
        var style = event.currentTarget.beer;
        this.styleName = style.name;
        this.styleId = style.$key;
        this.searchString = style.name;
        this.$.options.hidden = true;

      },

      _addNewBeer: function (){
        this._validateAll();
        if(this.valid){
          this.$.spinner.active = true;
          this.$.saved.hidden = true;
          this.$.error.hidden = true;
          var beer = {};
          var org = {};
          var obj = {};
          var category = this.$.category.data;
          var pub = this.organization;
          var onTap = this.$.onTap.data;
          var isOnTap = (Object.keys(onTap).length > 0) ? true : false;
          // var isOnTap = (onTap.id) ? true : false;
          console.log('onTap', isOnTap);

          if(this.editBeerId){
            var id = this.editBeerId
            obj['beer/'+id+'/lastEdited'] = new Date();
            obj['beer/'+id+'/edited'] = true;
          }else{
            var id = this.$.newBeer.ref.push().key;
            obj['beer/'+id+'/createDate'] = new Date();
            obj['beer/'+id+'/new'] = true
          }

          var orgPre = 'organization/'+pub.place_id+'/brewBeer/'+id;
          var tapPre = 'organization/'+pub.place_id+'/onTap/'+id;
          var onTapPre = 'onTap/'+onTap.tapId;
          
          
          if(this.abv){
            obj['beer/'+id+'/abv'] = Number(this.abv);
            obj[orgPre+'/abv'] = Number(this.abv);
            if(isOnTap) { 
              obj[tapPre+'/abv'] = Number(this.abv); 
              obj[onTapPre+'/abv'] = Number(this.abv); 
            };
          }
          if(category.type){
            obj['beer/'+id+'/category'] = category.type;
            obj[orgPre+'/category'] = category.type;
            if(isOnTap) { 
              obj[tapPre+'/category'] = category.type; 
              obj[onTapPre+'/category'] = category.type; 
            };
          }
          if(category.name){
            obj['beer/'+id+'/categoryName'] = category.name;
            obj[orgPre+'/categoryName'] = category.name;
            if(isOnTap) { 
              obj[tapPre+'/categoryName'] = category.name;
              obj[onTapPre+'/categoryName'] = category.name;
            };
          }
          if(category.title){
            obj['beer/'+id+'/categoryTitle'] = category.title;
            obj[orgPre+'/categoryTitle'] = category.title;
            if(isOnTap) { 
              obj[tapPre+'/categoryTitle'] = category.title;
              obj[onTapPre+'/categoryTitle'] = category.title;
            };
          }
          if(category.order){
            obj['beer/'+id+'/order'] = Number(category.order);
            obj[orgPre+'/order'] = Number(category.order);
            if(isOnTap) { 
              obj[tapPre+'/order'] = Number(category.order); 
              obj[onTapPre+'/order'] = Number(category.order);
            };
          }
          if(this.description){
            obj['beer/'+id+'/description'] = this.description;
            obj[orgPre+'/description'] = this.description;
            if(isOnTap) { 
              obj[tapPre+'/description'] = this.description;
              obj[onTapPre+'/description'] = this.description;
            };
          }
          if(id){
            obj['beer/'+id+'/id'] = id;
            obj[orgPre+'/id'] = id;
            if(isOnTap) { 
              obj[tapPre+'/id'] = id; 
              obj[onTapPre+'/id'] = id;  
            };
          }
          if(this.name){
            if(!this.editBeerId){
              obj['beer/'+id+'/name'] = this.name;
              obj[orgPre+'/name'] = this.name;
              if(isOnTap) { 
                obj[tapPre+'/name'] = this.name;
                obj[onTapPre+'/name'] = this.name;
              };
            }
          }
  
          if(this.styleId){
            obj['beer/'+id+'/styleId'] = Number(this.styleId);
            obj[orgPre+'/styleId'] = Number(this.styleId);
            if(isOnTap) { 
              obj[tapPre+'/styleId'] = Number(this.styleId);
              obj[onTapPre+'/styleId'] = Number(this.styleId);
            }
          }
          if(this.styleName){
            obj['beer/'+id+'/styleName'] = this.styleName;
            obj[orgPre+'/styleName'] = this.styleName; 
            if(isOnTap) { 
              obj[tapPre+'/styleName'] = this.styleName;
              obj[onTapPre+'/styleName'] = this.styleName; 
            }
          }
          if(pub.breweryId){
            obj['beer/'+id+'/breweryId'] = pub.breweryId;
            if(isOnTap) { 
              obj[onTapPre+'/breweryId'] = pub.breweryId;
            }
          }
          if(pub.name){
            obj['beer/'+id+'/breweryName'] = pub.name;
            if(isOnTap) { 
              obj[onTapPre+'/breweryName'] = pub.name;
            }
          }
          if(pub.city){
            obj['beer/'+id+'/city'] = pub.city;
            if(isOnTap) { 
              obj[onTapPre+'/city'] = pub.city;
            }
          }
          if(pub.domain){
            obj['beer/'+id+'/domain'] = pub.domain;
          }
          if(pub.place_id){
            obj['beer/'+id+'/place_id'] = pub.place_id;
            if(isOnTap) { 
              obj[onTapPre+'/place_id'] = pub.place_id;
            }
          }
          if(pub.state){
            obj['beer/'+id+'/state'] = pub.state;
            if(isOnTap) { 
              obj[onTapPre+'/state'] = pub.state;
            }
          }
          if(pub.stateAbbreviation){
            obj['beer/'+id+'/stateAbbreviation'] = pub.stateAbbreviation;
            if(isOnTap) { 
              obj[onTapPre+'/stateAbbreviation'] = pub.stateAbbreviation;
            }
          }
          if(this.uid){
            obj['beer/'+id+'/uid'] = this.uid;
            if(isOnTap) { 
              obj[onTapPre+'/uid'] = this.uid;
            }
          }
          
          obj['beer/'+id+'/status'] = 'not-verified'
          console.log(obj);
    
          var app = this.$.category.app;
          var that = this;

          firebase.database(app).ref().update(obj, function(error) {
            if (error){
              that.$.spinner.active = false;
              that.$.saved.hidden = true;
              that.$.error.hidden = false;
              // that.playAnimation('exit');

              console.log("Error" + error);
            }else{
              console.log("Saved");
              that.$.spinner.active = false;
              that.$.saved.hidden = false;
              // that.playAnimation('exit');
              that.$.error.hidden = true;
              if(that.savedBeerName){
                that.savedBeerName += ', '+beer.name;
              }else{
                that.savedBeerName = beer.name;
              }
              if(!that.editBeerId){
              that.abv = '';
              that.name = '';
              that.description = '';
              that.valid = false;
              that.searchString = '';
              that._resetFormStyleData();
              }
            }
          });
        }else{
          console.log('not valid');
          this.$.saved.hidden = true;
          this.$.error.hidden = false;
          // this.playAnimation('exit');
        }

      },

  
      

      _sortStyleName: function(){

      }

    });

  </script>

</dom-module>
