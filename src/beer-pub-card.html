<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">

<link rel="import" href="../bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">

<link rel="import" href="beer-crawl-select.html">
<link rel="import" href="beer-pub-card-favorite.html">

<link rel="import" href="beer-pub-icons.html">
<link rel="import" href="beer-pub-favorite.html">

<dom-module id="beer-pub-card">

  <template strip-whitespace>
    
    <style include="paper-material-styles">

      :host {
        display: block;
        position: relative;
      }

      a{
        color: var(--app-primary-color);
        text-decoration: none;
      }

      .card{
         @apply --paper-material-elevation-1;
        margin: 10px; 
      }

      .card-wrapper{
        @apply --layout-horizontal;
        @apply --layout-justified;
        
      }

      .actions{
         width: 80px;
         height:100%;
         background-color: var(--app-shadow-color);
      }

      .actions-wrapper{
         @apply --layout-vertical;
         @apply --layout-center-justified;
      }

      .action-button{
        /*color: white;
        background-color: var(--app-accent-color);*/
        margin: 10px 20px;
      }

      .favorite-rating{
        overflow: hidden;
        color: var(--app-accent-color);
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }

      .toggle-button{
        @apply --layout-horizontal;
        @apply --layout-end-justified;
        /*width: 100%;*/
      }

      .card-information{
        padding: 10px;
        margin: 10px;
        width: 95%;

      }

      .items > div{
        margin: 0 10px 10px 10px
      }


      .name {
        font-size: 1.5em;
        font-weight: 300;
        color: var(--app-primary-color);
        margin: 10px 0 0 0;
      }

      .motto {
        font-size: 1.0em;
        font-weight: 400;
        color: var(--app-primary-color);
      }

      .address {
        font-size: 1.0em;
        font-weight: 300;
        color: var(--app-primary-color);
      }
      
      .distance{
        font-size: 1.0em;
        font-weight: 300;
        color: var(--app-secondary-color);
      }

      .swipe{
        overflow:hidden;
      }

      .favorite-icon-message{
        font-size: 1.0em;
        font-weight: 300;
        margin: 7px 0 0 0;
        color: var(--app-accent-color);
      }

      .icons-wrapper{
        @apply --layout-horizontal;
        @apply --layout-wrap;
      }

      .sponsor-wrapper{
        font-size: .8em;
        font-weight: 300;
        color: var(--app-secondary-color);
      }


    </style>
   
      <div class="card">
        
        <template is="dom-if" if="[[_isPremium]]">
          <template is="dom-if" if="[[place.mainImage.banner.url]]">
         
          <a aria-label$="[[place.name]]" href$="/[[urlName]]/main?orgid=[[placeId]]">
            <iron-image 
                style="width:100%; height:300px; background-color: #F8F8F8;"
                sizing="cover" 
                preload 
                placeholder="[[_computedPlaceHolder]]"
                fade
                src="[[place.mainImage.banner.url]]">
            </iron-image>
          </a>
          </template>
          <div  class="sponsor-wrapper">
            <div id="sponsor">Sponsoring Organization</div>
          </div>
        </template>
   
        <div class="card-wrapper">
          <!-- [[favorite]] -->
          
          <div class="card-information">
       
              <div class="items">
                <a aria-label$="[[place.name]]" href$="/[[urlName]]/main?orgid=[[placeId]]">
                  <div class="name">[[place.name]]</div>
                </a>

                <a aria-label$="[[place.name]]" href$="/[[urlName]]/main?orgid=[[placeId]]">
                <template is="dom-if" if="[[_isPremium]]">
                  <div class="motto">[[place.motto]]</div>
                </template>
                <div class="address" hidden$="[[!place.vicinity]]">[[place.vicinity]]</div>
                <div class="distance" hidden$="[[!place.distance]]">[[_computeDisplayDistance(place.distance)]] miles from you</div>
                </a>
              </div>

              <div class="icons-wrapper">
                <beer-pub-icons
                  dogs="[[place.dogFriendly]]"
                  patio="[[place.patio]]"
                  over21="[[place.over21]]">
                </beer-pub-icons>
                
                <div id="favoriteIcon" class="favorite-icon-message" hidden$="[[!_numberFavorite]]">
                  <iron-label>
                    <paper-icon-button no-ink icon="thumb-up" place="[[place]]" on-tap="_openEditPlaceDialog"></paper-icon-button>
                    <span>([[_numberFavorite]])</span>
                  </iron-label>
                </div>
               
              </div>
          </div>
          
          <div class="toggle-button">
            <div hidden$="[[!edit]]">
              <paper-icon-button no-ink icon="more-vert" place="[[place]]" on-tap="_openEditPlaceDialog"></paper-icon-button>
            </div>
          </div>
        
      </div>
    </div>
   
    
  </template>

  <script>

    Polymer({

      is: 'beer-pub-card',

      properties: {

        edit:{
          type:Boolean,
          value:false,
          reflectToAttribute:true
        },

        favorite:{
          type:Boolean
        },

        login: {
          type: Boolean,
          notify: true
        },

        openEditPubCrawl:{
          type:Boolean,
          notify:true
          // observer: '_watchOpenEditPubCrawl'
        },

        place:{
          type:Object
        },

        toggle:{
          type:Boolean,
          value: false
        },

        placeId:{
          type: String
        },

        editPlace:{
          type:Object,
          notify:true
        },

        editFavorite:{
          type:String,
          notify:true
        },

        _computedImageUrl:{
          type: String,
          computed: '_computeImageUrl(place.mainImage.banner.url)'
        },

        _computedPlaceHolder:{
          type: String,
          computed: '_computePlaceHolder(place.mainImage.banner.thumbnail)'
        },

        _isPremium:{
          type:Boolean,
          value:false,
          computed: '_computeIsPremium(place.plan)'
        },


        user: {
          type:Object
        },

        userData:{
          type:Object
        },

        _isFavoriteCSS:{
          type:String,
          value:'not-selected'
        },

        _isNotFavoriteCSS:{
          type:String,
          value:'not-selected'
        },
        
        urlName:{
            type: String,
            computed: '_computeNameForUrl(place.name)'
        },

        _numberFavorite:{
          type:Number,
          value: 0
        },

        _numberNotFavorite: Number,
        _percentFavorite: Number,
        _totalFavorite: Number,
        _favoriteIcon:String
        
      },

      observers:['_watchFavorite(userData.favoriteOrganization)',
                  '_watchPlaceFavorite(place.favorite)',
                  '_watchFavoriteActivity(place.action)'],

    

      _watchFavoriteActivity: function (action){
        // console.log(action);
        switch(action){
          case 'ADD_FAVORITE':
            this._watchPlaceFavorite(this.place.favorite)
            this.$.favoriteIcon.hidden=false;
            break;

          case 'REMOVE_FAVORITE':
            this._watchPlaceFavorite(this.place.favorite)
            break;

          case 'ADD_NOT_FAVORITE':
            break;
          case 'REMOVE_NOT_FAVORITE':
            break;

        }
      },

      _watchFavorite: function (favorite){
        // console.log(favorite);
        if(favorite){
          
          if(favorite[this.placeId]){
            // console.log(favorite[this.placeId]);
            
            if(favorite[this.placeId].favorite === 'yes'){
              this._isFavoriteCSS = 'favorite';
              this._isNotFavoriteCSS = 'not-selected';
              this.favorite = 'yes';
            
              
            }else if(favorite[this.placeId].favorite === 'no'){
              this._isFavoriteCSS = 'not-selected';
              this._isNotFavoriteCSS = 'not-favorite';
              this.favorite = 'no';
            }else{
              this._isFavoriteCSS = 'not-selected';
              this._isNotFavoriteCSS = 'not-selected';
              this.favorite = 'none';
              
            }
          }
        }
        
      },

      _watchPlaceFavorite: function (favorite){
        var numFav = 0;
        var numNotFav = 0;
        // console.log('noticed change', this.place.name)
      

        if(typeof favorite ==='object'){
          // console.log(Object.keys(favorite).length)
          for (let key of Object.keys(favorite)){
            
            var fav = favorite[key];
            //  console.log(key);
        
            if (fav) {
              
                if(fav.favorite){
                  if(fav.favorite === 'yes'){
                    numFav++
                  }else if(fav.favorite === 'no'){
                    numNotFav++
                  }
                }
              }
            // }
          }
        }else{
          this.set('place.favorite', {});
        }

        this._numberFavorite = numFav;
        this._numberNotFavorite = numNotFav;
        this._percentFavorite = (numFav/(numFav+numNotFav));
        this._totalFavorite = numFav+numNotFav;
        if(this._totalFavorite == 0 ){
          this._favoriteIcon = 'favorite-border';
        }

        if(this._percentFavorite > 0){
          this._favoriteIcon = 'favorite';
        }else{
          this._favoriteIcon = 'favorite-border';
        }
      },

      _computeIsPremium: function (plan) {

        var today = Date.now() / 1000;
        if (plan) {
          if (plan.current_period_end) {
            if (plan.current_period_end > today) {
                return true;
            }
          }
        }
        return false;
      },


      _computeDisplayDistance: function (distance){
        return Math.round(distance*10)/10
      },


      _computeImageUrl: function (url){
        if(url){
          return url
        }
        return false
      },

      _computeNameForUrl: function (name) {
          'use strict';
          if (name) {
            name = name.replace(/\s/g, '-')
            return name.replace(/[^a-zA-Z\d\s:]/g, '');
          } else {
            return 'pub-name-missing'
          }
      },

      _computePlaceHolder: function (thumbnail){
        if(thumbnail){
          return 'data:image/png;base64, '+thumbnail;
        }
      },


      _openEditPlaceDialog: function (){
        var target = event.currentTarget;
        var place = target.place;
        
        if(this.user){
          this.openEditPubCrawl = true;
          this.editPlace = place;
          this.editFavorite = (this.favorite) ? this.favorite : 'none';
        }else{
          this.login = true;
        }
      },

      _computeFavoriteStatus: function (favorite){
        console.log(favorite);
        if(!favorite){
          return false;
        }
        if(!favorite[this.user.uid]){
          return false;
        }
        if(favorite[this.user.uid].favorite){
          if(favorite[this.user.uid].favorite === 'yes'){
            return true;
          }
        }
        return false;

      },


      _toggle:function (){
        this.toggle = !this.toggle;
      },

      _test: function(obj){
          console.log("TEST",obj);
      }

    });

  </script>

</dom-module>
