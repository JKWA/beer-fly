

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-location/iron-location.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/google-apis/google-maps-api.html">

<link rel="import" href="../bower_components/toggle-icon/toggle-icon.html">
<link rel="import" href="../bower_components/s-slider/s-slider.html">

<link rel="import" href="beer-icons.html">
<link rel="import" href="beer-rating-card.html">
<link rel="import" href="beer-near-breweries.html">



<dom-module id="beer-home">

  <template>

    <style>

      /*.near-card {
        --shadow-elevation-2dp: {
            box-shadow: 0 2px 2px 0 var(--app-selected-color),
                        0 1px 5px 0 var(--app-selected-color),
                        0 3px 1px -2px var(--app-selected-color);
          };
      }*/
      /*.body{
        
      height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
    
      }
       iron-list {
       height: 100vh;
    }*/

     a{
      color: var(--app-primary-color);
      text-decoration: none;
     }

    paper-spinner-lite{
      position: absolute;
      top: 40%;
      left: 50%;
    }

    paper-material > div{
        margin: 10px
      }

    .card{
      padding: 10px;
      margin: 10px;
    }

    .title-wrapper{
       @apply(--layout-horizontal);
       @apply(--layout-justified);
       @apply(--layout-wrap);
    }

   .title{
     font-size: 1em;
     font-weight: 500;
     color: var(--app-accent-color);
     margin: 10px 0
   }

   .geo-error{
      font-size: .8em;
      font-weight: 300;
      color: var(--app-secondary-color);
    }

    .distance {
      color: var(--app-secondary-color);
      font-size: 1.2em;
      font-weight: 300;
    }
    

    .name{
      font-size: 1.5em;
      font-weight: 300;
      color: var(--app-primary-color);
    }

    .address{
      color: var(--app-secondary-color);
      font-size: 1em;
      font-weight: 400;
    }

    .wrapper{
        @apply(--layout-horizontal);
        font-size: 1em;
        font-weight: 300;
        color: var(--app-accent-color);
      }
      .location-label{
        margin: 10px 0
      }
      paper-input{
        margin: 0 10px;
        color: var(--app-accent-color);
      }

      paper-button{
        color: var(--app-accent-color);
      }

     

      
    </style>

    <google-maps-api id="map" api-key="AIzaSyBPa6XlVFjF48fEyNT3qtnkFTZ0_dGMAzI" version="3.exp"></google-maps-api>
      <!--[[latitude]], [[longitude]]-->

    <beer-near-breweries
        latitude="[[latitude]]"
        longitude="[[longitude]]"
        distance="[[limitDistance]]"
        login="{{login}}"
        data="{{nearData}}">
    </beer-near-breweries>

    <!--[[_test(near)]]-->
    <div class="body">
   
    <paper-spinner-lite active id="spinner"></paper-spinner-lite>

     

      <paper-material class="card" elevation="1">
        <div class="title-wrapper">
        <iron-label class="wrapper">
              <paper-icon-button icon="beer-icons:[[gpsIcon]]" on-tap="_resetToLocal"></paper-icon-button>
              <span class="title">Nearest breweries<span>
          </iron-label>

        <iron-label class="wrapper">
            <toggle-icon
                  animation="flip-vertical" 
                  icon="beer-icons:expand-more"
                  checked="{{toggle}}"
                  noink>
            </toggle-icon>
            <span class="location-label">Change location</span>
          </iron-label>
        </div>
  
       
          <iron-collapse opened="[[toggle]]">
              <div hidden$="[[!geoError]]">
                  <div class="geo-error">Location not available from this device.</div>
              </div>

              <paper-input value="{{address}}" on-keydown="_watchForSubmit" label="City, State; or Zip"></paper-input>
              <paper-button on-click="_getGeoFromAddress">SET LOCATION</paper-button>
          </iron-collapse>
              
           
      </paper-material>

       <div hidden$="[[!isNear]]">
        <beer-pub-card 
            class="near-card"
            place-id="[[pub.place_id]]"
            name="[[pub.name]]"
            address="[[pub.vicinity]]"
            distance="[[distance]]"
            sponsor="[[pub.PREMIUM]]"
            dog-friendly="[[pub.dogFriendly]]"
            patio="[[pub.patio]]"
            over21="[[pub.over21]]"
            login="{{login}}">
        </beer-pub-card>
      </div>
        <div id="near" hidden>
          
         <template is="dom-repeat" initial-count="5" items="[[_toArray(nearData)]]" as="pub">
        
          <beer-pub-card 
            place-id="[[pub.place_id]]"
            name="[[pub.name]]"
            address="[[pub.vicinity]]"
            distance="[[pub.distance]]"
            sponsor="[[pub.PREMIUM]]"
            dog-friendly="[[!pub.dogFriendly]]"
            patio="[[!pub.patio]]"
            over21="[[!pub.over21]]"
            login="{{login}}">
        </beer-pub-card>

         </template>
        </div>

    </div>
</template>
  <script>

    Polymer({

      is: 'beer-home',

      properties: {

        address: {
          type: String
        },

        distance:{
          type: Number,
        },

        idle:{
          type: Boolean,
          notify: true
        },

        geoError:{
          type: Boolean,
          value: false
        },

        // gpsLat: {
        //   type: Number
        // },

        // gpsLng:{
        //   type: Number
        // },

        gpsIcon:{
          type: String,
          value: 'gps-searching'
        },

        initialLoad:{
          type: Boolean,
          value: false
        },

        isNear:{
          type: Boolean,
          computed: '_computeIsNear(distance)',
          value: false
        },

        latitude: {
            type: Number
        },

        longitude:{
          type: Number
        },

        limitDistance:{
          type: Number,
          value: 15
        },

        login: {
         type: Boolean,
         notify: true
       },

        mapLoaded:{
          type: Boolean,
          value: false
        },

        near:{
          type: Array
        },
        nearData:{
          type: Array
        },

        path: {
          type:String
        },

        query: {
          type: String
        },

        toggle:{
          type: Boolean,
          value: false
        }
      },
      
      observers:[ '_getGoogleDetails(mapLoaded, latitude, longitude)',
                  '_resolveGeoError(geoError)',
                  '_distance(latitude, longitude)',
                  '_watchNearData(nearData)'
                  ],

      listeners: {'api-load':'_mapHasLoaded' },

      // ready: function () {
      //   var that = this; 
      //   this.timeout = setTimeout(function(){ 
      //     console.log('sent error message');
          
      //     that.geoError = true; }, 4000);
      // },
      
      _watchNearData: function (nearData) {
        // console.log('near', nearData);
        this.$.spinner.active = false;

      },

      _computeIsNear(distance){
        if(distance < .05){
          return true;
        }else{
          return false;
        }
      },

      _mapHasLoaded: function (){
        this.mapLoaded = true;
      },

      _resolveGeoError: function (geoError){
        if(geoError){
          this.$.spinner.active = false;
          // this.idle = true;
          this.gpsIcon = 'gps-disabled';
          this.toggle = true;
          clearTimeout(this.timeout);
        }

      },

      _resetToLocal: function (){
        console.log('reset');
        // this.latitude = this.gpsLat;
        // this.longitude = this.gpsLng;
        this.idle = false;
        this.gpsIcon = 'gps-searching'
        this.$.near.hidden = true;
        this.$.spinner.active = true;
        this.toggle = false;
        this.address = '';
        // this._getGoogleDetails(true, this.gpsLat, this.gpsLng);
        
      },

  

      _getGoogleDetails: function (mapLoaded, latitude, longitude){
       
      //  console.log('GEO');
       
        if(mapLoaded){
           if(latitude){
            if(longitude){
              
              this.gpsIcon = 'gps-fixed';
              this.geoError = false;
              this.toggle = false;

              // clearTimeout(this.timeout);
              if(!this.initialLoad){
                this.initialLoad = true;
                this.$.spinner.active = true;
                // this.gpsLat = latitude;
                // this.gpsLng = longitude;
              }
              this.$.near.hidden = true;
              var map = this.$.map;

              var location = {};
              location.lat = latitude
              location.lng = longitude;


              var request = {};
              request.location = location;
              request.types = ['bar', 'restaurant'];
              request.type = 'bar';
              request.rankBy = google.maps.places.RankBy.DISTANCE
              var that = this;
        
              var places = new google.maps.places.PlacesService(map);
              places.nearbySearch(request, function (result){
                  if(result[0]){
                  that.pub = result[0];
                  // console.log('result', result[0]);
                  var location = result[0].geometry.location;
                  that.pubLat = location.lat();
                  that.pubLng = location.lng();
                  // console.log(result[0].geometry.location.lat());             
                  // that.$.spinner.active = false;
                  that.$.near.hidden = false;
                  var distance = that._distance (that.latitude, that.longitude, location.lat(), location.lng())
                  }
                })
             }
           }
        }
      },

      _watchForSubmit: function (event){
        // console.log(event);
         var key = event.which || event.keyCode;
        //  console.log(key);
         if(key === 13){
           this._getGeoFromAddress();
         }
      },

      _getGeoFromAddress: function () {
        // console.log('ADDRESS', this.address);
        this.toggle = false;
        this.$.near.hidden = true;
        this.gpsIcon = 'gps-searching'
        var that = this;
          this.geocode(this.address, function (address, lat, lng, placeId) {
            
              that.latitude = lat;
              that.longitude = lng
              this.gpsIcon = 'gps-fixed'
            
          });
      },


       geocode: function(address, onComplete) {

         var geocoder = this._geocoder = this._geocoder || new google.maps.Geocoder();

            geocoder.geocode({address: address}, function(results, status) {

              if (status == google.maps.GeocoderStatus.OK && results[0]) {
                console.log(results[0]);
                var searchAddressString = '';
                var address = results[0].address_components;
                for (var i=0; i<address.length; i++){
                  var type = address[i].types
                  for (var j=0; j<type.length; j++){
                    if(type[j] === 'locality'){
                      searchAddressString += address[i].long_name + ', ';
                    }else if (type[j] === 'administrative_area_level_1') {
                      searchAddressString += address[i].long_name + ' ';
                    }

                  }
                }
                console.log(searchAddressString);
                
                onComplete(
                        results[0].formatted_address,           
                        results[0].geometry.location.lat(),     
                        results[0].geometry.location.lng(),     
                        results[0].place_id);  
                                         
              } else {
                console.warn('Geocode failed for ' + address + '. Status ' + status, results);
                
                onComplete();
              }
            });
            return true;
      },

      _distance: function (myLat, myLng, pubLat, pubLng){
          var R = 6371; // Radius of the earth in km
          var dLat = this.deg2rad(pubLat-myLat);  // deg2rad below
          var dLon = this.deg2rad(pubLng-myLng); 
          var a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.deg2rad(myLat)) * Math.cos(this.deg2rad(pubLat)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);

          var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
          var d = R * c; // Distance in km
          this.distance = d;
       },

       deg2rad: function (deg) {
              return deg * (Math.PI/180)
       },


      _computeNameForUrl: function (name) {
        'use strict';
        if (name) {
          name = name.replace(/\s/g, '-')

          return name.replace(/[^a-zA-Z\d\s:]/g, '');
        } else {
          return 'pub-name-missing'
        }
      },
        _toArray(obj){
          // console.log('arrayfunction',obj);
          if(obj){
            var key = Object.keys(obj);
            // console.log(obj['ChIJ67q6T0MUkFQRKzMpFDL9Aoo']);
            var returnArray = []; 
          
            for (var i=0; i<key.length; i++){
              returnArray.push(obj[key[i]])
            }
          }
          var finalArray = returnArray.sort(this._sort);
          return finalArray;
        },

        _sort: function (a,b){
        return parseFloat(a.sort) - parseFloat(b.sort) ;
        },

      _test: function(obj){
          console.log("TEST",obj);
      }

    });

  </script>

</dom-module>
