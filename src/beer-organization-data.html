

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">


<dom-module id="beer-organization-data">

  <template>
 

    <!-- <firebase-document 
        app-name="beer" 
        id="pub"
        path="organization/[[orgId]]"
        data="{{fireOrg}}">
    </firebase-document> -->
    <firebase-auth id="auth" app-name="beer"></firebase-auth>



</template>
  <script>

    Polymer({

      is: 'beer-organization-data',

      properties: {

        organization: {
          type: Object,
          notify:true
        },

        orgId:{
          type: String
        },

        fireOrg:{
          type:Object
        },

        firebaseLoadedObject:{
          type:Boolean,
          value: false
        }
      },
      
      observers:['_getOrganizationData(orgId)'],

      _getOrganizationData: function (orgId){
        if(orgId){
          firebase.database(this.$.auth.app).ref(`/organization/${orgId}`)
          .on('value', snapshot =>{
            if(!snapshot.exists()){
              this.organization = null;
            }else{
              var organization = snapshot.val();

              organization.cacheTimestamp = Date.now()+604800000;
              organization.organization = true;
              organization.favoriteTotal = 0;
              organization.favoriteYes = 0;
              organization.favoriteNo = 0;
              organization.favoritePercent=null;

            if(snapshot.child('favorite').exists()){
              snapshot.child('favorite').forEach(favorite =>{
                organization.favoriteTotal ++
                // console.log(favorite);
                if(favorite.child('favorite').val() === 'yes'){
                  organization.favoriteYes++
                }else if(favorite.child('favorite').val() === 'no'){
                  organization.favoriteNo++
                }

              })
            }
            if(organization.favoriteTotal >0){
              organization.favoritePercent = Math.round((organization.favoriteYes/organization.favoriteTotal)*1000)/10;
            }

            this.organization = organization;

            window.localStorage.setItem('organization_'+organization.place_id, JSON.stringify(organization))
            console.log('cached', organization);

            }
          })
        }
      },

      _watchForFirebaseOrgData: function (fireOrg){

        console.log('fireOrg',fireOrg);
        if(Object.keys(fireOrg).length >0){
          this.firebaseLoadedObject = true;
          this.organization = fireOrg;
          if(fireOrg.place_id){
            fireOrg.cacheTimestamp = Date.now()+604800000;
            fireOrg.organization = true;
            window.localStorage.setItem('organization_'+fireOrg.place_id, JSON.stringify(fireOrg))
            console.log('cached', fireOrg);
          }
        }else{
          console.log('default');
          this._defaultOrganizationData();
        }

      },



_getDefaultObject: function (){
    var noCache = {};

    noCache.category = {};
    var beer = {};
    beer.$key = 'TAP';
    beer.category = 'TAP';
    beer.name = 'tap';
    beer.title = 'On-tap';
    beer.display = true;
    beer.order = 100;
    
    noCache.category['TAP'] = beer;

    var contact = {};
    contact.$key = 'CONTACT';
    contact.category = 'CONTACT';
    contact.name = 'contact';
    contact.title = 'Contact';
    contact.display = true;
    contact.order = 300;
    
    noCache.category['CONTACT'] = contact;

    var review = {};
    review.$key = 'REVIEW';
    review.category = 'REVIEW';
    review.name = 'review';
    review.title = 'Review';
    review.display = true;
    review.order = 400;
    
    noCache.category['REVIEW'] = review;
    // console.log('nocache', noCache);
    return noCache;
     },

       _defaultOrganizationData: function (){
      var noCache = {};

          noCache.category = {};
          var beer = {};
          beer.$key = 'TAP';
          beer.category = 'TAP';
          beer.name = 'tap';
          beer.title = 'On-tap';
          beer.display = true;
          beer.order = 100;
          
          noCache.category['TAP'] = beer;

          var contact = {};
          contact.$key = 'CONTACT';
          contact.category = 'CONTACT';
          contact.name = 'contact';
          contact.title = 'Contact';
          contact.display = true;
          contact.order = 300;
          
          noCache.category['CONTACT'] = contact;

          var review = {};
          review.$key = 'REVIEW';
          review.category = 'REVIEW';
          review.name = 'review';
          review.title = 'Review';
          review.display = true;
          review.order = 400;
          
          noCache.category['REVIEW'] = review;
          // console.log('nocache', noCache);
          this.organization = noCache;
          // this.initialLoad = false;
     },

      _test: function (obj){
        console.log('TEST', obj);
      }


    });

  </script>

</dom-module>
