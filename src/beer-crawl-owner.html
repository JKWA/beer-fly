

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">

<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/moment-element/moment-element.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-from-right-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-right-animation.html">

<link rel="import" href="beer-icons.html">
<link rel="import" href="beer-login.html">


<dom-module id="beer-crawl-owner">

<template strip-whitespace>
  <style include="paper-material-styles">

    a{
      /*color: var(--app-accent-color);*/
      text-decoration: none;
    }

    a > iron-icon {
      text-decoration: none;
    }

    ol{
      list-style-type: none;
    }

    li{
      @apply --layout-horizontal;
      padding: 10px;
      /*margin-left:20px;*/
      border-bottom: 1px solid var(--app-secondary-color);

    }

    li:first-child{
      border-top: 1px solid var(--app-secondary-color);
    }

    li:last-child{
      background-color:green;
    }


    li > div {
      margin: 0 10px 0 0;
      font-size: 1em;
      color: var(--app-primary-color);
      font-weight: 400;
    }

    paper-fab{
      background-color: var(--app-accent-color);
    }

  

    .add-icon{
      color: var(--app-accent-color);
    }

    .card{
      padding: 12px;
      margin: 15px;
      @apply --paper-material-elevation-1;
    }

    .title-wrapper{
       @apply --layout-horizontal;
       @apply --layout-justified;
    }

    .icon-wrapper{
      @apply --layout-horizontal;
      @apply --layout-justified;
      font-size: 1em;
      
    }

    .organization-wrapper{
      @apply --layout-horizontal;
      @apply --layout-justified;
      width: 100%;
    }

    .shared{
      color: var(--app-selected-color);
    }
    .icon{
      color: var(--app-secondary-color);
    }

    .shared-label{
      color: var(--app-selected-color);
      font-size: .8em;
      font-weight: 300;
    }

    .name{
      font-size: 1.5em;
      color: var(--app-primary-color);
      font-weight: 400;
    }

    .description{
      font-size: 1em;
      color: var(--app-primary-color);
      font-weight: 300;
      margin: 10px 0 30px 0;
    }

    .question-header{
      font-size: 1.5em;
      color: var(--app-primary-color);
      font-weight: 400;
    }

    .question-body-list{
      @apply --layout-vertical;
    }
    .question-body-list > div:not(:first-child){
      margin: 10px 0 0 0;
    }

    .delete{
      color:red;
    }

    .message-wrapper > div{
      margin: 10px 0 0 0;
    }

    .message-title span{
      font-size: 1.2em;
      color: var(--app-primary-color);
      font-weight: 300;
      margin-left: 10px;
    }

    .message span{
      font-size: 1em;
      color: var(--app-primary-color);
      font-weight: 300;
      margin-left: 10px;
    }

    .message iron-icon{
      font-size: 1em;
      color: var(--app-accent-color);
      font-weight: 300;
    }

    .plan {
      margin: 20px 0;
      @apply --layout-horizontal;
      @apply --layout-center-justified;
    }

    .org-icon-wrapper{
      @apply --layout-horizontal;
      @apply --layout-end-justified;
    }

    .move{
      color: var(--app-accent-color);
    }

    .share-button{
      color: var(--app-accent-color);
    }

  </style>

  <firebase-auth id="auth" app-name="beer" status-known="[[statusKnown]]"user="{{user}}"></firebase-auth>
  <firebase-document
      app-name="beer"
      id="userData"
      disabled
      path="user/[[user.uid]]"
      data="{{userData}}">
  </firebase-document>

  <div class="card" hidden="[[user]]">
     <div>Sign in to create a Beer-Crawl.</div>
        <beer-login></beer-login>
    </div>
    <div class="card" hidden="[[!user]]">
      <iron-label>
        <paper-icon-button class="add-icon" icon="beer-icons:add" on-tap="_openEditor"></paper-icon-button>
        Add a Beer-Crawl
      </iron-label>
      <div hidden="[[!crawlId]]">
        <a href="/home/crawl/mine">
          <iron-label>
          <paper-icon-button class="add-icon" icon="beer-icons:add"></paper-icon-button>
            <span>Show all my Beer-Crawls</span>
          </iron-label>
        </a>
      </div>
    </div>
 
    <template is="dom-repeat" 
              items="{{crawls}}" 
              as="crawl" 
              filter="{{_filter(crawlId)}}"
              sort="_sortByNew"
              observe="deleted $key created">
      <div class="card">
        <div class="title-wrapper">
          <div class="name">[[crawl.name]]</div>
          <div class="icon-wrapper">
            <div>
              <iron-label>
               <span class="shared-label" hidden$="[[!crawl.shared]]">(shared)</span>
              <paper-icon-button 
                  class$="[[_ifPublic(crawl.public)]]"
                  icon="beer-icons:public" 
                  shared="[[crawl.public]]" 
                  crawlid="[[crawl.$key]]" 
                  on-tap="_makePublic">
              </paper-icon-button>
              </iron-label>
            </div>
            <div>
              <paper-icon-button icon="beer-icons:edit" crawl="[[crawl]]"  on-tap="_openEditCrawlDialog"></paper-icon-button>
            </div>
            <div>
              <paper-icon-button icon="beer-icons:delete-forever" crawl="[[crawl]]" on-tap="_openDeleteCrawlDialog"></paper-icon-button>
            </div>
          </div>
        </div>
         <template is="dom-repeat" items="[[_addBreaks(crawl.description)]]" as="description">
            <div class="description">[[description]]</div>
         </template>

      
         <div class="message-wrapper" hidden$="[[crawl.organization]]">
           
            <div>
              <a class="message" href="#near_me">
                <iron-icon icon="beer-icons:gps-fixed"></iron-icon>
                <span>Find nearby pubs and breweries.</span>
              </a>
            </div>
            <div>
              <a class="message" href="/home/search">
                <iron-icon icon="beer-icons:search"></iron-icon>
                <span>Search for pubs and breweries </span>
              </a>
            </div>
             <div class="message"> 
              <iron-icon icon="beer-icons:crawl"></iron-icon>
               <span>Add breweries and pubs using the crawl icon on the pub or brewery main page</span>
            </div>
         </div>
         

        <ol>
        <template is="dom-repeat" items="[[_organizationArray(crawl.organization)]]" as="pub">
          <li> 
            
           <div class="organization-wrapper">
              <div>
                <div>[[pub.name]]</div>
                <div>[[pub.formatted_address]]</div>
              </div>
              <div class="org-icon-wrapper"> 
                <div hidden$="[[_hideLastIcon(index, pub.totalLength)]]">
                  <paper-icon-button  class="move" crawlid="[[crawl.$key]]" placeid="[[pub.place_id]]" icon="beer-icons:align-bottom" on-tap="_moveOrganizationToBottom"></paper-icon-button>
                </div>
                <paper-icon-button class="delete" crawlid="[[crawl.$key]]" placeid="[[pub.place_id]]" icon="beer-icons:delete" on-tap="_removeOrganization"></paper-icon-button>
                
              </div>
           </div>
            
          </li>
        </template>
        </ol>
        <div>
          <a href="/home/crawl?crawlId=[[crawl.$key]]">

            <paper-button class="share-button">Share this Beer-Crawl</paper-button>
          </a>
        </div>
      </div>
      
    </template>

     <paper-dialog 
            id="addCrawlDialog"
            with-backdrop
            entry-animation="slide-from-right-animation"
            exit-animation="slide-right-animation">
        <h2>Add a Beer-Crawl</h2>
        <paper-dialog-scrollable>
          <paper-input label="Crawl Name" value="{{editCrawlName}}"></paper-input>
          <paper-textarea label="Crawl Description" value="{{editCrawlDescription}}"></paper-textarea>
        </paper-dialog-scrollable>
         <div class="buttons">
          <paper-button on-tap="_addCrawl">Save</paper-button>
          <paper-button dialog-dismiss autofocus>Close</paper-button>
        </div>
      </paper-dialog>

      <paper-dialog 
            id="editCrawlDialog"
            with-backdrop
            entry-animation="slide-from-right-animation"
            exit-animation="slide-right-animation">
        <h2>Edit a Beer-Crawl</h2>
        <paper-dialog-scrollable>
          <paper-toggle-button checked="{{editCrawlPublic}}">[[editCrawlPublicMessage]]</paper-toggle-button>
          <paper-input label="Crawl Name" value="{{editCrawlName}}"></paper-input>
          <paper-textarea label="Crawl Description" value="{{editCrawlDescription}}"></paper-textarea>
        </paper-dialog-scrollable>
         <div class="buttons">
          <paper-button on-tap="_updateCrawl">Save</paper-button>
          <paper-button dialog-dismiss autofocus>Close</paper-button>
        </div>
      </paper-dialog>

      <paper-dialog 
            id="deleteCrawlDialog"
            with-backdrop
            entry-animation="slide-from-right-animation"
            exit-animation="slide-right-animation">
        <h2>Delete Beer-Crawl</h2>
        <paper-dialog-scrollable>
          <div>[[deleteName]]</div>
          <div>[[deleteDescription]]</div>
          <!--<div>[[deleteCrawlId]]</div>-->
        </paper-dialog-scrollable>
         <div class="buttons">
          <paper-button on-tap="_deleteCrawl">Delete</paper-button>
          <paper-button dialog-dismiss autofocus>Close</paper-button>
        </div>
      </paper-dialog>

      
      

</template>
  <script>

    Polymer({

      is: 'beer-crawl-owner',

      properties: {

        crawls:{
          type: Array,
          value: function (){
            return [];
          }
        },

        crawlData:Array,

        crawlId:String,

        editCrawlName:String,
        editCrawlDescription:String,
        editCrawlId:String,
        editCrawlPublic:Boolean,
        editCrawlPublicMessage:{
          type:String,
          computed: '_computedEditPublicMessage(editCrawlPublic)'
        },

        deleteCrawlId:String,
        deleteName:String,
        deleteDescription:String,

        sortedLocationHistory:{
          type:Array
        },
       
        user:{
          type: Object
        },
        
        userData:{
          type: Object
        },

        _showDeleted:{
          type:Boolean,
          value: false
        },

        _userDataSet:{
          type:Boolean,
          value:false
        }
        
      },

      observers:['_watchUser(user)'],
      
      _watchCrawlId: function (crawlId){
        if(crawlId){
          this._getSpecificCrawl(crawlId)
        }else{
          if(this.user){
            if(this.user.uid){
              if(!this._userDataSet){
                this._getUsersCrawls(this.user.uid)
                this._userDataSet = true;
                console.log('finished')
              }
            }
          }
        }
      },

      _watchUser: function (user){
        if(user){
          if(user.uid){
            if(!this._userDataSet){
              if(!this.crawlId){
                this._getUsersCrawls(this.user.uid)
                this._userDataSet = true;
                console.log('set all')
              }
            }

            this.$.userData.disabled = false;
            
          }else{
            this.$.userData.disabled = true;
            this.splice("crawls", 0, this.crawls.length);
          }
        }else{
          this.$.userData.disabled = true;
          this.splice("crawls", 0, this.crawls.length);
        }
      },

      _getUsersCrawls: function (userId){
        var that = this;

        firebase.database(this.$.auth.app).ref('/crawl')
          .orderByChild('user_id').equalTo(userId)
          .on('value', function(snapshot) {
            that.splice("crawls", 0, that.crawls.length)
            if(snapshot.numChildren() >0){
              that._showCrawls = true;
            }else{
              that._showCrawls = false;
            }
            snapshot.forEach(crawl => {
              var crawlData = crawl.val();
              crawlData.$key = crawl.key
              // console.log(crawlData);
              that.push('crawls', crawlData);
          })
        })
        
      },

      _getSpecificCrawl: function (crawlId){
        var that = this;
        firebase.database(this.$.auth.app).ref(`/crawl/${crawlId}`)
          .on('value', function(snapshot) {
            that.splice("crawls", 0, that.crawls.length)
           
            var crawlData = snapshot.val();
            // console.log(crawlData);
            crawlData.$key = snapshot.key;
            that.push('crawls', crawlData);
        })
        
      },


      _ifPublic: function (isPublic){

        if(isPublic){
          return 'shared'
        }
        return 'icon'
      },

      _openEditor: function (){
          var body = document.querySelector('body');
          Polymer.dom(body).appendChild(this.$.addCrawlDialog);
          this.$.addCrawlDialog.open();
      },
      
      // _addCrawl(event){
      //   var obj = {
      //     user_id: this.user.uid,
      //     name: this.editCrawlName,
      //     description: this.editCrawlDescription,
      //     created: Math.round(Date.now()/1000)
      //   }

      //   if(this.user.uid){
      //     firebase.database(this.$.auth.app).ref(`crawl`)
      //     .push(obj)
      //     .then(() =>{
      //       console.log('Added New Beer Crawl')
      //     })
      //     .catch(error =>{
      //       console.log('ERROR_PUSH', error)
      //     })
      //   }
      //   this.$.addCrawlDialog.close();
      // },

      _updateCrawl(event){
        if(!this.editCrawlPublic){
          this.editCrawlPublic = null;
        }
        var obj = {
          user_id: this.user.uid,
          name: this.editCrawlName,
          description: this.editCrawlDescription,
          created: Math.round(Date.now()/1000),
          public: this.editCrawlPublic
        }
        // console.log('obj', obj);

        if(this.user.uid){
          if(this.editCrawlId){
            firebase.database(this.$.auth.app).ref(`crawl/${this.editCrawlId}`)
            .update(obj)
            .then(() =>{
              console.log('Added New Beer Crawl')
            })
            .catch(error =>{
              console.log('ERROR_PUSH', error)
            })
          }
        }
        this.$.editCrawlDialog.close();
      },

      _makePublic: function (event){
        var target = event.currentTarget;
        var crawlId = target.crawlid;
        var shared = target.shared;

        var saveshared = null;
        

        if(!shared){
          saveshared = true;
        }

        firebase.database(this.$.auth.app).ref(`/crawl/${crawlId}`)
          .update({public: saveshared})
          .then(()=>{
            console.log('shared updated');
          })
          .catch(error =>{
            console.log('ERROR_SAVING', error);
          })

      },

      _openEditCrawlDialog: function (){
        var target = event.currentTarget;
        var crawl = target.crawl
        this.editCrawlId = crawl.$key;
        this.editCrawlDescription = crawl.description;
        this.editCrawlName = crawl.name;
        if(crawl.public){
          this.editCrawlPublic = crawl.public
        }else{
          this.editCrawlPublic = null;
        }
        
        var body = document.querySelector('body');
        Polymer.dom(body).appendChild(this.$.editCrawlDialog);
        this.$.editCrawlDialog.open();
      },

      _openDeleteCrawlDialog: function (){
        var target = event.currentTarget;
        var crawl = target.crawl
        // console.log('crawl', crawl)
        this.deleteCrawlId = target.crawl.$key;
        this.deleteDescription = target.crawl.description;
        this.deleteName = target.crawl.name;
        var body = document.querySelector('body');
        Polymer.dom(body).appendChild(this.$.deleteCrawlDialog);
        this.$.deleteCrawlDialog.open();
      },

      

      _deleteCrawl: function (){
        if(this.deleteCrawlId){
          
          firebase.database(this.$.auth.app).ref(`/crawl/${this.deleteCrawlId}`)
          .update({deleted: true,
                   user_id: this.user.uid})
          .then(()=>{
            console.log('Deleted crawl')
          })
          .catch(error =>{
            console.log('DELETE_ERROR', error)
          })
        }
        this.$.deleteCrawlDialog.close();
      },

      _moveOrganizationToBottom: function (){
         var target = event.currentTarget;
         var crawl_id = target.crawlid;
         var place_id = target.placeid;
       
         if(crawl_id){
           if(place_id){
             firebase.database(this.$.auth.app).ref(`crawl/${crawl_id}/organization/${place_id}`)
              .update({created: Math.round(Date.now()/1000)})
              .then(()=>{
                console.log('organization moved to bottom')
              })
              .catch(error =>{
                console.log('MOVE_ERROR', error)
              })
           }
         }
      },

      _removeOrganization: function () {
         var target = event.currentTarget;
         var crawl_id = target.crawlid;
         var place_id = target.placeid;

         console.log(crawl_id)
         console.log(place_id)

         if(crawl_id){
           if(place_id){
             firebase.database(this.$.auth.app).ref(`crawl/${crawl_id}/organization/${place_id}`)
              .remove()
              .then(()=>{
                console.log('organization removed')
              })
              .catch(error =>{
                console.log('DELETE_ERROR', error)
              })
           }
         }
      },

      _organizationArray: function (obj){
        var returnArray = [];
        if(typeof obj ==='object'){
          var key = Object.keys(obj);
          for (let value of key){
            obj[value].totalLength = key.length;

           returnArray.push(obj[value])
          }
        }
        return returnArray.sort(this._sortByCreated);
      },

      _sortByCreated: function(a,b){

        if (a.created < b.created)
          return -1;
        if (a.created > b.created)
          return 1;
        return 0;
      },

       _sortByNew: function(a,b){
        if (a.created > b.created)
          return -1;
        if (a.created < b.created)
          return 1;
        return 0;
      },

      _hideLastIcon:function (index, total){
        if (total <= index+1){
          return true;
        }
        return false;
      },


      _addBreaks: function(str){
        'use strict';
        if(str){
          return str.split('\n');
        }else{
          return [];
        }
      },
      
      _filter(crawlId){
        console.log('crawlId', crawlId)
        return function (crawl){
          
          if(!crawlId){
            if(crawl.deleted){
              return false;
            }
            return true;
          }else if(crawl.$key === crawlId){
            return true;
          }
          return true;
          
        }
        
        if(!item.deleted){
          return true;
        }
        return false;
      },


      _computedEditPublicMessage: function (share){
        if(share){
          return 'Shared'
        }
        return 'Private'
      },

      _test: function(obj){
          console.log(obj);

      }

    });

  </script>

</dom-module>
