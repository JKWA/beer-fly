
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">

<link rel="import" href="../bower_components/app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">

<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">

<link rel="import" href="../bower_components/app-layout/helpers/helpers.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-route/app-route-converter.html">

<!--<link rel="import" href="../bower_components/geo-location/geo-location.html">-->
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-location/iron-location.html">
<link rel="import" href="../bower_components/iron-location/iron-query-params.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">

<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">

<link rel="import" href="beer-organization-data.html">
<link rel="import" href="beer-location-data.html">
<link rel="import" href="beer-geo-data.html">
<link rel="import" href="beer-geo-location.html">
<link rel="import" href="beer-search-data.html">
<link rel="import" href="beer-cache-data.html">
<link rel="import" href="beer-analytics.html">



<!--<link rel="import" href="beer-pub.html">-->
<!--<link rel="import" href="beer-test.html">-->

<link rel="import" href="beer-home.html">
<link rel="import" href="beer-icons.html">
<link rel="import" href="beer-place-data.html">
<link rel="import" href="beer-tabs.html">
<link rel="import" href="beer-tab.html">

<!--lazyload-->
<!--<link rel="import" href="beer-login.html">-->

<dom-module id="beer-app">

  <template>

    <style>

      :host {
        display: block;
        position: relative;
        /*padding-top: 64px;*/
        /*padding-bottom: 64px;*/
        min-height: 90vh;
        --app-primary-color: #303030;
        --app-secondary-color: #757575;
        --app-accent-color: #172C50;
        --app-selected-color: #FF5722;
        --paper-button-ink-color: var(--app-accent-color);
        --paper-icon-button-ink-color: var(--app-accent-color);
        --paper-spinner-color: var(--app-accent-color);
        --paper-tab-ink: var(--app-secondary-color);
        --paper-tabs-selection-bar-color: var(--app-accent-color);
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        color: var(--app-primary-color);
        
      }

      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }

      app-header {
        @apply(--layout-fixed-top);
        z-index: 1;
        background-color: rgba(255, 255, 255, 0.95);
        --app-header-shadow: {
          box-shadow: inset 0px 5px 6px -3px rgba(0, 0, 0, 0.2);
          height: 10px;
          bottom: -10px;
        };
      }

      paper-icon-button {
        color: var(--app-primary-color);
      }

      paper-toast {
        z-index: 10000
      }

      a{ 
        text-decoration: none;
      }

      .logo {
        text-align: center;
        
      }

      .logo a {
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 0.3em;
        color: var(--app-primary-color);
        text-decoration: none;
        /* required for IE 11, so this <a> can receive pointer events */
        display: inline-block;
        pointer-events: auto;
        
      }

      .left-bar-item {
        width: 40px;
      }

      .menu-btn {
        display: none;
      }

      .home-btn-wrapper {
        position: relative;
        width: 90px;
      }

      .home-btn {
        color: var(--app-accent-color);
        text-decoration: none;
      }

      .announcer {
        position: fixed;
        height: 0;
        overflow: hidden;
      }


      [hidden] {
        display: none !important;
      }

      app-drawer{
        --app-drawer-content-container: {
          border: 1px solid var(--app-secondary-color);
          background-color: #F8F8F8;
        };
      }

      /*#tabContainer {
        position: relative;
        height: 66px;
      }*/

      /*beer-tabs, beer-tab {
        --beer-tab-overlay: {
          border-bottom: 2px solid var(--app-accent-color);
        };
      }*/

      /*beer-tabs {
        height: 100%;
      }

      beer-tab {
        margin: 0 10px;
      }

      beer-tab a {
        display: inline-block;
        outline: none;
        padding: 9px 5px;
        font-size: 13px;
        font-weight: 500;
        text-decoration: none;
        color: var(--app-primary-color);
      }*/

      .card {
        margin: 5px;
        padding: 5px;
      }
      .card-title{
        width: 100%;
        font-size: 1.12em;
        font-weight: 500;
        color: var(--app-primary-color);
        margin: 10px 0;
      }

      .drawer-list a {
        display: block;
        padding: 0 9px;
        line-height: 40px;
        text-decoration: none;
        color: var(--app-secondary-color);
      }

      .drawer-icon {
        margin: 0 5px 0 0;
      }

      .extra-links{
        display: block;
        padding: 0 9px;
        line-height: 40px;
        text-decoration: none;
        color: var(--app-secondary-color);
      }

      .login-wrapper{
        @apply(--layout-horizontal);
        @apply(--layout-start-justified);
        padding: 7px;
        background-color: #F8F8F8;
      }

      .login-box{
        color: white;
        background-color: purple;
        height: 50px;
        width: 50px;
        line-height: 50px;
        text-align: center;
        font-size: 2em;
        font-weight: 500;
      }

      .login-account{
        height: 50px;
        text-align: center;
        line-height: 50px;
        font-size: 1.2em;
        font-weight: 300;
        color: var(--app-primary-color);
        margin: 0 10px;
      }

      app-drawer {
        z-index: 3;
      }

      iron-pages {
        
        /*@apply(--layout-horizontal);
        @apply(--layout-center-justified);*/
        max-width: 640px;
        margin: 0 auto;
      }

      .main-content{
        /*@apply(--layout-horizontal);
        @apply(--layout-center-justified);*/
        min-height: 75vh;
      }



      .footer {
        /*position: absolute;
        bottom: 0;
        left: 0;
        right: 0;*/
        text-align: center;
        width: 100%;
        margin: 20px 0 0 0;
        line-height: 24px;
      }


      .footer-item {
        box-sizing: border-box;
        padding: 15px;
        margin:  15px 0 8px 0;
        background-color: var(--app-accent-color);
      }


      .beer-login-dialog {
        height: 400px;
      }


      /* small screen */
      @media (max-width: 640px) {

        .menu-btn {
          display: block;
        }

        app-drawer{
        --app-drawer-content-container: {
          border: none;
          background-color: white;
        };
      }

        :host([page=detail]) .menu-btn {
          display: none;
        }
      }

    </style>

<beer-analytics key="UA-97017491-1"></beer-analytics>

<iron-location path="{{path}}" query="{{query}}"></iron-location>
<iron-query-params params-string="{{query}}" params-object="{{queryParams}}">
</iron-query-params>
<app-route-converter path="{{path}}" query-params="{{queryParams}}" route="{{route}}">
</app-route-converter>

  <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}">
  </app-route>
  <app-route route="{{subroute}}" pattern="/:page" data="{{subRouteData}}">
  </app-route>


  <firebase-app 
      id="fire_DB" 
      name="beer" 
      api-key="AIzaSyD2Z_cYgNuKB58bGbSzo0kMmJAWj0A0p18" 
      auth-domain="beer-fly.firebaseapp.com"
      database-url="https://beer-fly.firebaseio.com" 
      storage-bucket="beer-fly.appspot.com">
  </firebase-app>


  <firebase-auth 
      id="auth" 
      app-name="beer"
      user="{{user}}"
      status-known="{{statusKnown}}">
  </firebase-auth>


  <firebase-document 
      id="userData"
      app-name="beer" 
      path="user/[[user.uid]]"
      data="{{userData}}">
  </firebase-document>

  <beer-geo-location
      location = "{{location}}"
      idle = "{{idle}}">
  </beer-geo-location>

  <beer-location-data
      location="{{location}}"
      location-history="{{locationHistory}}"
      sorted-location-history="{{sortedLocationHistory}}"
      search-string="[[searchString]]">
  </beer-location-data>

  <beer-place-data
    place-id="[[orgId]]"
    online="[[online]]"
    data="{{place}}">
  </beer-place-data>

   <beer-cache-data
      location="[[location]]"
      online="[[online]]"
      all-object="{{allObject}}"
      all-array="{{allArray}}">
  </beer-cache-data>

  <beer-geo-data
    org-id="[[orgId]]"
    location="[[location]]"
    all-object="{{allObject}}"
    all-array="{{allArray}}"
    page="[[page]]">
  </beer-geo-data>

  <beer-search-data
    org-id="[[orgId]]"
    location="[[location]]"
    all-object="{{allObject}}"
    all-array="{{allArray}}"
    page="[[page]]">
  </beer-search-data>

  <beer-organization-data
      org-id="[[orgId]]"
      organization="{{organization}}">
  </beer-organization-data>



<iron-media-query query="max-width: 640px" query-matches="{{smallScreen}}"></iron-media-query>

<app-drawer-layout>
  <app-drawer opened="{{drawerOpened}}" slot="drawer">     
    <section>
      <a aria-label="To home page" href="/home/account">
        <div class="login-wrapper">
          <div class="login-box" hidden$="[[!user]]">[[_returnFirstLetter(userData.displayName)]]</div>
          <div class="login-account">My Account</div>
        </div>  
      </a>
    
      <paper-material class="card"  elevation="0">
        
      <div class="card-title">[[_showOrgName(place.name)]]</div>

      <iron-selector role="navigation" selected-class="drawer-list" class="drawer-list" selected="[[categoryName]]" attr-for-selected="name">
   
        <template is="dom-if" if="[[!_isHome]]">
          <div hidden="[[smallScreen]]">
            <a name="main" aria-label="Breweries near me" href$="/[[nameUrl]]/main[[orgParam]]">Main</a>
          </div>
          <template is="dom-repeat" items="[[categories]]" as="category" sort="_sortCategory">
            <template is="dom-if" if="[[category.display]]">
              <a name="[[category.name]]" aria-label="To [[category.name]]" href$="/[[nameUrl]]/[[category.name]][[orgParam]]">[[category.title]]</a>
            </template>
          </template>
          <hr>
        </template>
        <a name="near" aria-label="Breweries near me" href="/home"><iron-icon class="drawer-icon" icon="beer-icons:gps-fixed"></iron-icon>Near me</a>
        <a name="search" aria-label="Search for breweries" href$="/[[nameUrl]]/search[[orgParam]]"><iron-icon class="drawer-icon" icon="beer-icons:search"></iron-icon>Search</a>
        <a name="favorite" aria-label="My favorites" href$="/[[nameUrl]]/favorite[[orgParam]]"><iron-icon class="drawer-icon" icon="beer-icons:favorite"></iron-icon>Favorites</a>
      </iron-selector>

      <div class="extra-links" hidden$="[[verified]]" on-tap="_verifyAccount"><iron-icon class="drawer-icon" icon="beer-icons:account"></iron-icon>Verify email</div>
      <div class="extra-links" hidden$="[[!user]]" on-tap="_logout"><iron-icon class="drawer-icon" icon="beer-icons:account"></iron-icon>Sign out</div>
      <div class="extra-links" hidden$="[[user]]" on-tap="_login"><iron-icon class="drawer-icon" icon="beer-icons:account"></iron-icon>Sign in</div>
      <div class="extra-links">Terms of use</div>
    </paper-material>
    </section>
  </app-drawer>


  <app-header-layout>
    <app-header fixed slot="header">
      <app-toolbar>
        <div class="left-bar-item">
          <div id="homeButton">
            <paper-icon-button class="menu-btn" icon="beer-icons:menu" drawer-toggle alt="Toggle drawer">
            </paper-icon-button>
          </div>
          <div class="left-bar-item" >
            <div id="backButton" hidden>
                <a class="menu-btn"  href$="/[[nameUrl]]/[[returnPage]][[orgParam]]" tabindex="-1">
                  <paper-icon-button alt="Back to main page" icon="beer-icons:arrow-back" ></paper-icon-button>
                </a>
            </div>
          </div>
        </div>
        <div class="logo" main-title><a aria-label="Go to main page" href$="/[[nameUrl]]/main[[orgParam]]" aria-label$="[[_showOrgName(place.name)]]">[[_showOrgName(place.name)]]</a></div>
      
      </app-toolbar>
      </app-header>

      <div class="main-content">
        <div class="main">
        <iron-pages role="main" selected="[[page]]" attr-for-selected="name" selected-attribute="visible" fallback-selection="404">
          <beer-account name="account" organization="[[organization]]" small-screen="[[smallScreen]]"owner="[[owner]]"></beer-account>
          <beer-allbeers name="allbeers" owner="[[owner]]"></beer-allbeers>
          <beer-pub name="pub" login="{{login}}" organization="{{organization}}" place="[[place]]" name-url="[[nameUrl]]" org-id="[[orgId]]" owner="[[owner]]" online="[[online]]"></beer-pub>
          <beer-tap name="tap" login="{{login}}" organization="[[organization]]" place="[[place]]" name-url="[[nameUrl]]" category=[[organization.category.TAP]] org-id="[[orgId]]" online="[[online]]" owner="[[owner]]"></beer-tap>
          <beer-beer name="beer" login="{{login}}" organization="[[organization]]" place="[[place]]" name-url="[[nameUrl]]" category=[[organization.category.BEER]] org-id="[[orgId]]" online="[[online]]" owner="[[owner]]"></beer-beer>
          <beer-tv name="tv" organization="[[organization]]" place="[[place]]" org-id="[[orgId]]" offline="[[offline]]" owner="[[owner]]"></beer-tv>
          <beer-favorite-beer name="favorite-beer" location="[[location]]" offline="[[offline]]"></beer-favorite-beer>
          <beer-favorite-brewery name="favorite-brewery" offline="[[offline]]"></beer-favorite-brewery>
          <beer-favorite-pub name="favorite-pub" offline="[[offline]]"></beer-favorite-pub>

          <beer-review name="review" organization="[[organization]]" place="[[place]]" category=[[organization.category.REVIEW]] org-id="[[orgId]]" online="[[online]]" owner="[[owner]]"></beer-review>
          
          <beer-menu name="menu" category=[[organization.category.MENU]] organization="[[organization]]" menu-item-id="[[menuItemId]]" place="[[place]]" name-url="[[nameUrl]]" org-id="[[orgId]]" online="[[online]]" owner="[[owner]]"></beer-menu>
          <beer-menu-edit name="menu-edit" org-id="[[orgId]]" menu-category-id="[[menuCategoryId]]" online="[[online]]" owner="[[owner]]"></beer-menu-edit>
          <beer-foodtruck name="foodtruck" truck-id="[[truckId]]" category=[[organization.category.FOOD_TRUCK]] organization="[[organization]]" place="[[place]]" name-url="[[nameUrl]]" org-id="[[orgId]]" online="[[online]]" owner="[[owner]]"></beer-foodtruck>
          <beer-foodtruck-edit name="foodtruck-edit" org-id="[[orgId]]" organization="[[organization]]" online="[[online]]" owner="[[owner]]"></beer-foodtruck-edit>

          <beer-contact name="contact" organization="[[organization]]" place="[[place]]" category=[[organization.category.CONTACT]] org-id="[[orgId]]" online="[[online]]" owner="[[owner]]"></beer-contact>
          <beer-event name="event" category=[[organization.category.EVENT]] place="[[place]]" org-id="[[orgId]]" online="[[online]]" owner="[[owner]]"></beer-event>
          <beer-store name="store" category=[[organization.category.STORE]] place="[[place]]" org-id="[[orgId]]" online="[[online]]" owner="[[owner]]"></beer-store>
          <beer-list name="list" route="[[subroute]]" offline="[[offline]]" place="[[place]]"  owner="[[owner]]"></beer-list>
          <beer-search name="search" location="{{location}}" idle="{{idle}}" search-string="{{searchString}}" sorted-location-history="[[sortedLocationHistory]]" geo-error="[[geoError]]"></beer-search>
          <beer-beer-info name="beer-info" login="{{login}}" location="[[location]]" beer-id="[[beerId]]"></beer-beer-info>

          <beer-home name="home" location="{{location}}" idle="{{idle}}" search-string="{{searchString}}" sorted-location-history="[[sortedLocationHistory]]" all-object="[[allObject]]" all-array="[[allArray]]"></beer-home>
          <beer-favorite name="favorite"></beer-favorite>
          <beer-tap-add name="tap-add" login="{{login}}" organization="[[organization]]" place="[[place]]" name-url="[[nameUrl]]" category=[[organization.category.BEER]] org-id="[[orgId]]" online="[[online]]" owner="[[owner]]"></beer-tap-add>
          <beer-beer-edit name="beer-edit" offline="[[offline]]" place="[[place]]" organization="[[organization]]"org-id="[[orgId]]" beer-id="[[beerId]]" name-url="[[nameUrl]]" owner="[[owner]]" return-name="[[returnName]]" return-org-id="[[returnOrgId]]"></beer-beer-edit>
          <beer-404-warning name="404"></beer-404-warning>
        </iron-pages>
        </div>

        <div class="announcer" aria-live="assertive">[[_a11yLabel]]</div>


        <paper-toast 
          class="toast" 
          id="offLineToast" 
          horizontal-align="right"
          horizontal-offset="50"
          vertical-offset="100"
          duration="5000">
          <div> 
            Offline, read only access  
            <br>
          </div>
        </paper-toast>


        <paper-toast 
            id="verificationToast" 
            duration="0" 
            horizontal-align="right"
            horizontal-offset="50"
            vertical-offset="100">
            <div>Verification sent to [[user.email]]</div>
            <div>Please refresh the app after verifying.</div>
          </paper-toast>
      </div>
          <div class="footer">
            <div class= "footer-item">
              <iron-image src="/images/powered_by_google_on_non_white.png"></iron-image>
            </div>
          </div>
      

    </app-header-layout>

  </app-drawer-layout>

      <paper-dialog 
            entry-animation="scale-up-animation"
            exit-animation="fade-out-animation"
            with-backdrop
            id="loginDialog"
            opened="{{login}}">
        <paper-dialog-scrollable>
          <section class="beer-login-dialog">

          <!--lazy loaded-->
          <beer-login class="beer-login-dialog"></beer-login>
          </section>
        </paper-dialog-scrollable>
        <paper-button dialog-dismiss autofocus>CLOSE</paper-button>
      </paper-dialog>
  

</template>

<script>

    // performance logging
    window.performance && performance.mark && performance.mark('beer-fly - before register');

    Polymer({

      is: 'beer-app',

      properties: {
        _a11yLabel: {
          type: String
        },

        allPubs: {
          type:Object
        },

        allArray:{
          type:Array,
          value: function (){return [];}
        },

        allObject:{
          type:Object,
          value: function (){return {};}
        },

        beerId: {
          type: String,
          computed: '_computeBeerId(queryParams)'
        },

        categories: {
          type: Array,
          computed: '_computeCategories(organization)'
        },

        drawerOpened:{
          type: Boolean
        },

        fireOrg:{
          type: Object,
        },

        geoError: {
          type: Boolean,
          value: false
        },

        geoResponse:{
          type: Object
        },

         geoRendered: {
          type: Boolean,
          value: false
        },

        idle: {
          type: Boolean,
          value: true
        },

        initialLoad:{
          type: Boolean,
          value: true
        },

        firstTimeHomeHasLoaded: {
          type: Boolean,
          value: true
        },

        location:{
          type: Object,
        },

        locationHistory:{
          type: Array
        },
        

        login: {
          type: Boolean,
          value: false
        },

        menuCategoryId: {
          type: String,
          computed: '_computeMenuId(queryParams)'
        },

         menuItemId: {
          type: String,
          computed: '_computeMenuItemId(queryParams)',
        },
         
        nameUrl: {
          type: String,
          computed: '_computeNameForUrl(place.name)'
        },

        offline:{
          type: Boolean
        },

        organization: {
          type: Object,
          
        },

        orgId: {
          type: String,
          computed: '_computeOrgId(queryParams)',
        },

        returnOrgId: {
          type: String,
          computed: '_computeReturnOrgId(queryParams)',
        },

        returnName: {
          type: String,
          computed: '_computeReturnName(queryParams)',
        },

        orgParam: {
          type: String,
          computed: '_computeOrgParam(orgId)'
        },

        owner:{
          type: Boolean,
          value: false
        },
  
        place: {
          type: Object
        }, 

        place_id:{
          type: String,
        },
  
        page: {
          type: String,
        },

        queryParams: {
          type: Object
        },

        route:{
          type: Object
        },

        routeData: {
          type: Object
        },

        statusKnown:{
          type:Boolean
        },

        subPage: {
          type: String,
          value: 'main',
          computed: '_computeSubPage(subRouteData.page)'
        },

        subRouteData: {
          type: Object
        },

        truckId:{
          type: String,
          computed: '_computeTruckId(queryParams)',
        },

        verified: {
          type: Boolean,
          value: true
        },

        user:{
          type: Object
        },

        userData:{
          type: Object
        },

        returnPage: {
          type: String,
          value: 'main'
        },

        _isHome:{
          type: Boolean,
          value:false
        }

      },
       

      observers: [
        '_routePageChanged(route)',
        '_pageChanged(page)',
        '_routeOrgIdChanged(orgId)',
        '_isOwner(userData.domain, userData.ADMIN, organization.domain)',
        '_toastOffline(online)',
        '_setBackArrowInHeader(page)',
        '_toggleDrawerOnPageChange(page)',
        '_updateUserEmailVerified(user)',
        '_isSignedIn(user)',
        '_updatePageTitle(place.name, page)',
        '_scrollToTop(page)',

        // '_setTimeoutForGeo(page)'
      ],

     
      behaviors: [
        Polymer.AppNetworkStatusBehavior,
       
       ],

      //  listeners: {
      //             'geo-error': '_geoError', 
      //             'geo-response':'_geoResponse' },

      created: function () {
        window.performance && performance.mark && performance.mark('beer-app.created');
        // Custom elements polyfill safe way to indicate an element has been upgraded.
        this.removeAttribute('unresolved');
      },

  

      _setTimeoutForGeo: function (page) {
        //if phone has location serves off and does not trigger error message
        // if(page === 'home'){
        //   if(this.firstTimeHomeHasLoaded){
            
        //     var that = this; 
        //     this.timeout = setTimeout(function(){ 
        //     console.log('sent error message');
            
        //     that.geoError = true; }, 7000);

        //     this.firstTimeHomeHasLoaded = false;

        //   }
         

        // }

      },
 
      _scrollToTop: function (page){
        console.log('scroll_top');
        Polymer.AppLayout.scroll({ top: 0, behavior: 'silent' });
      },

      _updateUserEmailVerified: function (user){
        
          if(user){
            if(user.emailVerified){
              this.verified = true;
            }else{
              this.verified = false;
            }
          }else{
            this.verified = true;
          }
      },

      _isSignedIn: function (user){
        if(user){
          this.login = false;
        }
      },


      _setBackArrowInHeader: function (page){
        if(page === 'pub' || page==='home'){
          this.$.backButton.hidden = true;
          this.$.homeButton.hidden = false;
           
        }else{
          this.$.backButton.hidden = false;
          this.$.homeButton.hidden = true;
        }
      },

      _isOwner: function(domain, admin, orgDomain){
        var owner = false;
      
        if(admin){
          this.owner = true;
          return;
        }
        try{
        if(domain){
          upperDomain = domain.toUpperCase();
          if(orgDomain){
            upperOrgDomain = orgDomain.toUpperCase();
            if(upperDomain === upperOrgDomain){
              this.owner = true;
              return;
            }
          }
        }
        }catch(error){
          this.owner = false;
        }
        
       this.owner = false;
      },


        _toastOffline: function(online){
          if(online){
            this.$.offLineToast.close();
            // this._isOwner(this.userData.domain, this.userData.ADMIN, this.organization.domain);
          }else{
            this.$.offLineToast.open();
            this.owner = false;
          }

      },


     


      _routePageChanged: function (route) {

        var place = this.place;
    
        var title = 'Beer-Fly'
        var page = 'home'
        var returnPage='main';
        var path = route.path;
        if(!path){
          page ='home';
          this._isHome=true;
        }else{
          
          pathArray = path.split('/');
          var route = pathArray[1];
          var subRoute = pathArray[2];
          var thirdRoute = pathArray[3];
          if(!route){
            route = 'home';
            this._isHome=true;
          }

          if(route === 'home'){
            this._isHome=true;
            if(subRoute === 'main'){
              page = 'home';
            }else if(subRoute==='allbeers'){
               page = 'allbeers';
            }else if(subRoute==='search'){
               page = 'search';
            }else if(subRoute==='account'){
               page = 'account';
            }else if(subRoute==='favorite'){
               
               if(!thirdRoute){
                 page = 'favorite';
               }else{
                 if(thirdRoute === 'beer'){
                   page='favorite-beer';
                   returnPage='favorite';
                 }else if(thirdRoute === 'brewery'){
                   page='favorite-brewery';
                   returnPage='favorite';
                 }else if(thirdRoute === 'pub'){
                   page='favorite-pub';
                   returnPage='favorite';
                 }else{
                   page = 'favorite';
                 }
               }
            }else{
              page = 'home';
            }
            

          }else{
            this._isHome=false;
            if(subRoute === 'main'){
              page = 'pub';
              
            }else if(subRoute==='beer'){
               page = 'beer';
            }else if(subRoute ==='description'){
                page='beer-info';
            }else if(subRoute==='tap'){
               page = 'tap';
            }else if(subRoute==='menu'){
               page = 'menu';
            }else if(subRoute==='menu-edit'){
               page = 'menu-edit';
               returnPage='menu';
             }else if(subRoute==='foodtruck'){
               page = 'foodtruck';
            }else if(subRoute==='foodtruck-edit'){
               page = 'foodtruck-edit';
               returnPage='foodtruck';
            }else if(subRoute==='contact'){
               page = 'contact';
             }else if(subRoute==='review'){
               page = 'review';
            }else if(subRoute==='tv'){
              page = 'tv';
              returnPage='tap';
            }else if(subRoute==='search'){
               page = 'search';
            }else if(subRoute==='account'){
               page = 'account';
            }else if(subRoute==='home'){
               page = 'home';
            }else if(subRoute==='browse'){
               page = 'browse';
            }else if(subRoute==='beer-edit'){
               page = 'beer-edit';
               returnPage='beer';
            }else if(subRoute==='tap-add'){
               page = 'tap-add';
               returnPage='tap';
            }else if(subRoute==='favorite'){
               
               if(!thirdRoute){
                 page = 'favorite';
               }else{
                 if(thirdRoute === 'beer'){
                   page='favorite-beer';
                   returnPage='favorite';
                 }else if(thirdRoute === 'brewery'){
                   page='favorite-brewery';
                   returnPage='favorite';
                 }else if(thirdRoute === 'pub'){
                   page='favorite-pub';
                   returnPage='favorite';
                 }else{
                   page = 'favorite';
                 }
               }
            }else{
              page='list';
            }
          }
        }
      
        this.returnPage = returnPage
        this.page = page || 'home';
        if (this.page === 'home') {
          this.orgId = 'home';
        }

        this._closeDrawer();
      },

      _routeOrgIdChanged: function (orgId) {
        if (this.page === 'home') {
          this.orgId = 'home'
        }
        if (orgId) {
          this.orgId = orgId;
        } else {
          this.orgId = 'home';
        }
      },

      _updatePageTitle: function (name, page){
          
          name = (name) ? name : 'Beer Fly'
          var title;

            switch (page){
              case 'beer':
                title = name+' Beers';
                break;
              case 'tap':
                title = name+' On-tap';
                break;
              case 'menu':
                title = name+' Menu';
                break;
              case 'foodtruck':
                title = name+' Trucks';
                break;
              case 'contact':
                title = name+' Contact';
                break;
              case 'review':
                title = name+' Reviews';
                break;
              case 'near':
                title = 'Near me';
                break;
              case 'home':
                title = 'Beer-Fly';
                break;
              
              default:
                title = name;

            }
            
            if(title === 'home'){
              title = 'Beer-Fly'
            }

            document.title = title;
          

      },
     
      _pageChanged: function (page, oldPage) {
        if (page != null) {
          if (page == 'home') {
            this._pageLoaded(Boolean(oldPage));
          } else {            
            // When a load failed, it triggered a 404 which means we need to
            // eagerly load the 404 page definition
            var cb = this._pageLoaded.bind(this, Boolean(oldPage));
            this.importHref(
              this.resolveUrl('beer-' + page + '.html'),
              cb, cb, true);
          }
        }
      },

     


      _pageLoaded: function (shouldResetLayout) {
        this._ensureLazyLoaded();
        if (shouldResetLayout) {
          // The size of the header depends on the page (e.g. on some pages the tabs
          // do not appear), so reset the header's layout only when switching pages.
          this.async(function () {
            this.$.header.resetLayout();
          }, 1);
        }
      },

      _ensureLazyLoaded: function () {
        // load lazy resources after render and set `loadComplete` when done.
        if (!this.loadComplete) {
          console.log('LAZY_LOADED')

          Polymer.RenderStatus.afterNextRender(this, function () {
            this.importHref(this.resolveUrl('lazy-resources.html'), function () {
              // Register service worker if supported.
              if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js');
              }
            
              this.loadComplete = true;
            });
          });
        }
      },

     
      _toggleDrawer: function () {
        this.drawerOpened = !this.drawerOpened;
      },

      _toggleDrawerOnPageChange: function (page){
        console.log('page_change', page)
        this._closeDrawer();
        // this.drawerOpened = !this.drawerOpened;
      },

      _closeDrawer: function (){
        console.log('close');
        if(this.smallScreen){
          this.drawerOpened = false;
        }
      },

      


      // Elements in the app can notify a change to be a11y announced.
      _onAnnounce: function (e) {
        this._announce(e.detail);
      },

      // A11y announce the given message.
      _announce: function (message) {
        this._a11yLabel = '';
        this.debounce('_a11yAnnouncer', function () {
          this._a11yLabel = message;
        }, 100);
      },

      // This is for performance logging only.
      _domChange: function (e) {
        if (window.performance && performance.mark && !this.__loggedDomChange) {
          var target = Polymer.dom(e).rootTarget;
          if (target.domHost.is.match(this.page)) {
            this.__loggedDomChange = true;
            performance.mark(target.domHost.is + '.domChange');
          }
        }
      },

      _onFallbackSelectionTriggered: function () {
        this.page = '404';
      },




      _computeSubPage: function (subPage) {
        if (subPage) {
          return subPage;
        } else {
          return 'main';
        }
      },

      _computeOrgId: function (queryParams) {
        if (queryParams) {
          if (queryParams.orgid) {
            return queryParams.orgid
          }
        }
        return 'home';
      },

      _computeBeerId: function (queryParams) {
        if (queryParams) {
          if (queryParams.beerId) {
            return queryParams.beerId
          }
        }
        return null;
      },

       _computeTruckId: function (queryParams) {
        if (queryParams) {
          if (queryParams.truckId) {
            return queryParams.truckId
          }
        }
        return null;
      },

       _computeMenuId: function (queryParams) {
        if (queryParams) {
          if (queryParams.menuCategory) {
            return queryParams.menuCategory
          }
        }
        return null;
      },

      _computeMenuItemId: function (queryParams) {
        if (queryParams) {
          if (queryParams.menuItem) {
            return queryParams.menuItem
          }
        }
        return null;
      },

      _computeReturnName: function (queryParams) {
        if (queryParams) {
          if (queryParams.returnName) {
            return decodeURI(queryParams.returnName);
          }
        }
        return null;
      },

      _computeReturnOrgId: function (queryParams) {
        if (queryParams) {
          if (queryParams.returnOrgId) {
            return queryParams.returnOrgId;
          }
        }
        return null;
      },

      _computeOrgParam: function (orgId) {
        if (orgId) {
          if (orgId !== 'home') {
            return '?orgid=' + orgId;
          }
        }
      },

      _computeCategories: function (organization) {
        var returnArray = [];
        // console.log('catagory', organization);
        if(!organization){
          organization = {};
          organization.category = {};
        }
        if (organization) {
         
          if (organization.category) {
            
            var category = organization.category;
            var key = Object.keys(category);
            for (var i = 0; i < key.length; i++) {
              category[key[i]].$key = key[i];
              returnArray.push(category[key[i]])
            }
          
          }else{
            this.organization.category = {};
            var beer = {};
            beer.$key = 'TAP';
            beer.category = 'TAP';
            beer.name = 'tap';
            beer.title = 'On-tap';
            beer.display = true;
            beer.order = 100;
            returnArray.push(beer);
            this.organization.category['TAP'] = beer;

            var contact = {};
            contact.$key = 'CONTACT';
            contact.category = 'CONTACT';
            contact.name = 'contact';
            contact.title = 'Contact';
            contact.display = true;
            contact.order = 300;
            returnArray.push(contact);
            this.organization.category['CONTACT'] = contact;

            var review = {};
            review.$key = 'REVIEW';
            review.category = 'REVIEW';
            review.name = 'review';
            review.title = 'Review';
            review.display = true;
            review.order = 400;
            returnArray.push(review);
            this.organization.category['REVIEW'] = review;
          }
        }else{

        }
        
        return returnArray.sort(function (a, b) {
          return parseFloat(a.order) - parseFloat(b.order);
        });
      },

      
      _computeNameForUrl: function (name) {
        'use strict';
        if (name) {
          name = name.replace(/\s/g, '-')
          return name.replace(/[^a-zA-Z\d\s:]/g, '');
        } else {
          return 'home'
        }
      },

     _showOrgName: function (name) {
       if(name){
          if(name === 'home'){
            return 'Beer-Fly'
          }else{
            return name;
          }
       }else{
         return 'Beer-Fly'
       }
     },

     _sortCategory: function(a,b){
      
        'use strict';
        if (a.order < b.order)
          return -1;
        if (a.order > b.order)
          return 1;
        return 0;
      },

      _returnFirstLetter: function (text){
        if(text){
        return text.charAt(0).toUpperCase();
        }
      },

      // _isHome: function (){
        
      //   if(page === 'home'){
      //     return true;
      //   }else{
      //     return false;
      //   }
      // },

      _hideExtraButtons: function (smallScreen, page){
       
        var hide = false;
        if(smallScreen){
          hide = true;
        }
        if(page=='account'){
          hide = true;
        }
        //  console.log(hide)
        return hide;
      },

      _login: function(){
        'use strict';
        this.login = true;
        this._closeDrawer();
      }, 

      _logout: function(){
        'use strict';
        this._closeDrawer();
        var that = this;
        return this.$.auth.signOut().then(function(){
          that.owner = false;
        });
      }, 

      _verifyAccount: function (){
        var that = this;
        var app = this.$.auth.app;
        // this.$.verificationToast.open();
        // this.drawerOpened = false;

        firebase.auth(app).currentUser.sendEmailVerification()
         .then(function(response) {
            console.log("Email Sent");
            that._closeDrawer();
            that.$.verificationToast.open();
        })
        .catch(function(error) {
          console.log('error', JSON.stringify(error))
        });
      },

      _test: function (obj) {
        console.log("TEST",obj)
      }

    });

  </script>

</dom-module>