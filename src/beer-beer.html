<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">

<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-from-right-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-right-animation.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="beer-beer-card.html">
<link rel="import" href="../bower_components/login-fire/login-fire.html">


<link rel="import" href="../my_components/data/upload-image.html">
<link rel="import" href="beer-fab.html">
<link rel="import" href="beer-fab-search.html">
<link rel="import" href="beer-beer-add.html">




<dom-module id="beer-beer">

  <template>

    <style>

      a{
        color: var(--app-accent-color);
        text-decoration: none;
        }

      .card{
        margin: 10px;
        padding: 20px;
      }


      .motto {
        font-size: 2.0em;
        font-weight: 500;
        margin: 40px 5px 0 20px;
      }

      .description {
        font-size: 1.2em;
        font-weight: 300;
        margin: 10px 5px 0 20px;
      }

    </style>

    <firebase-auth  app-name="beer" user="{{user}}"></firebase-auth>
    <!--<firebase-query 
       app-name="beer"
       order-by-child="place_id"
       equal-to="[[orgId]]"
       path="beer"
       data="{{beer}}">
    </firebase-query>-->

    <iron-image 
        style="width:100%; height:300px; background-color: #F8F8F8;"
        sizing="cover" 
        preload 
        fade
        src="[[photoUrl]]">
    </iron-image>
    
    <beer-fab owner="[[owner]]" on-tap="_edit"></beer-fab>

    <div class="motto">
        [[category.motto]]
    </div>

   <template is="dom-repeat" items="[[_addBreaks(category.description)]]" as="description">

    <div class="description">
        [[description]]
    </div>
   </template>

   
    <paper-material class="card" elevation="1">


      <iron-label>
      <paper-icon-button icon="beer-icons:add" on-tap="_addBeerDialog"></paper-icon-button>
      Add a beer
      </iron-label>
    </paper-material>
  
   
    <!--<template is="dom-if" if="{{user}}">-->
      <paper-dialog 
            id="addBeer"
            with-backdrop
            modal
            opened="{{dialogOpen}}"
            style="width: 90vw;"
            entry-animation="slide-from-right-animation"
            exit-animation="slide-right-animation">

      <beer-beer-add
          org-id="[[orgId]]"
          uid="[[user.uid]]"
          name-url="[[nameUrl]]"
          brewery-id="[[organization.breweryId]]"
          org-name="[[organization.name]]"
          organization="[[organization]]"
          edit-beer-id="{{editBeerId}}">
      </beer-beer-add>
      
      </paper-dialog>
    <!--</template>-->

    
      <paper-dialog 
          id="loginDialog"
          with-backdrop
          entry-animation="fade-in-animation"
          exit-animation="fade-out-animation">
        <login-fire  app-name="beer"  google></login-fire>
        <paper-button dialog-dismiss autofocus>CLOSE</paper-button>
      </paper-dialog>
    
    <template is="dom-repeat" items="[[_getArray(organization.brewBeer)]]" sort="_sortOrder" as="beer">
      <beer-beer-card 
          beer-id="[[beer.id]]"
          beer-name="[[beer.name]]"
          beer-description="[[beer.description]]"
          brewery-name="[[place.name]]"
          brewery-city="[[organization.city]]"
          brewery-state="[[organization.stateAbbreviation]]"
          style-name="[[beer.styleName]]"
          abv="[[beer.abv]]"
          place-id="[[place.place_id]]"
          crowd-source="[[organization.crowdSource]]"
          owner="[[owner]]"
          uid="[[user.uid]]"
          edit="[[canEdit]]"
          edit-beer-id="{{editBeerId}}"
          login="{{login}}">
      </beer-beer-card>
    </template>


    <paper-dialog 
        id="editDialog"
        with-backdrop
        style="width: 90vw;"
        entry-animation="slide-from-right-animation"
        exit-animation="slide-right-animation">
            
      <div class=""> 
          <h3>[[category.title]]</h3>
      </div>
    
        <paper-dialog-scrollable>
          <upload-image org-id="[[orgId]]" type="banner" key="category/BEER/image"></upload-image>   
          <paper-input label="Motto" value="{{category.motto}}"maxlength=100 char-counter></paper-input>
          <paper-textarea label="Description" value="{{category.description}}" maxlength=2000 char-counter></paper-textarea>
        </paper-dialog-scrollable>
      </template>
      <div class="">
        <paper-button dialog-dismiss autofocus>CLOSE</paper-button>
      </div>
    </paper-dialog>

  

  </template>

  <script>

    Polymer({

      is: 'beer-beer',

      properties:{
        photoUrl: {
          type: String,
          computed: '_computePhotoUrl(category, place)'
        },

       dialogOpen:{
          type:Boolean
       },

       login: {
         type: Boolean,
         notify: true
       },

       
        owner:{
          type: Boolean,
          value: false
        },

        user: {
          type: Object,
          value: function (){
            return {};
          }
        },

        editBeerId:{
          type: String
        },


        canEdit:{
          type: Boolean,
          computed: '_computeCanEdit(user, owner, organization)'
        }
        
      },
      observers: ['_addBeerDialog(editBeerId)', '_dialogOpenStatus(dialogOpen)'],

      // listeners: {'iron-overlay-closed': '_onDialogClosed'},

      _dialogOpenStatus: function (dialogOpen){
          // console.log('dialog', dialogOpen);
          if(!dialogOpen){
            this.editBeerId = null;
          }
       },

      _computeCanEdit: function (user, owner, organization){
      
       if(!user){
        return false;
       }

       var uid = user.uid;
        var crowdSource = true;
        if(!organization){
          return false
        }else{
          if(owner){
            return true;
          }
          if(organization.stopCrowdSourcedData){
            crowdSource = false;
          }
          if(crowdSource && uid){
            return true
          }
         
        }
        return false;
      },


      _addBeerDialog: function(editBeerId){
        'use strict';
        if(editBeerId){
          if(this.user){
            var body = document.querySelector('body');
            Polymer.dom(body).appendChild(this.$.addBeer);
            this.$.addBeer.open();
          }else{
            var body = document.querySelector('body');
            Polymer.dom(body).appendChild(this.$.loginDialog);
            this.$.loginDialog.open()
          }
        }
      },

     _edit: function(){
        'use strict';
        
        var body = document.querySelector('body');
          Polymer.dom(body).appendChild(this.$.editDialog);
          this.$.editDialog.open()
       
      },
      
      _addBreaks: function(str){
        'use strict';
        if(str){
          return str.split('\n');
        }else{
          return [];
        }
      },

       _getArray: function(obj){
        'use strict';
        if(obj){
          var returnArray = [];
          var key = Object.keys(obj);
          for (var i=0; i<key.length; i++){
            obj[key[i]].$key = key[i]
            returnArray.push(obj[key[i]])
          }
          //  return returnArray.sort(this._sortOrder);
           return returnArray;
        }
      },

      _sortOrder: function(a,b){
        'use strict';
        if (a.order < b.order)
          return -1;
        if (a.order > b.order)
          return 1;
        return 0;
      },
       _computePhotoUrl: function (category, place) {
         try{
          if(category.image){
            if(category.image.banner){
              if(category.image.banner.url){
                return category.image.banner.url;
              }
            }
          }
          var photoMeta = {};
          var photos = place.photos
          var categoryIndex = 2
          if(photos.length < categoryIndex){
            categoryIndex = photos.length
          }
          photoMeta.maxWidth = place.photos[categoryIndex].width;
          photoMeta.maxHeight = place.photos[categoryIndex].height;
          return place.photos[categoryIndex].getUrl(photoMeta);
         
       }catch (error){

       }
      },

      _test: function (obj) {
        console.log('TEST', obj);
      }

    });

  </script>

</dom-module>
