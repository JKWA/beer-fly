<link rel="import" href="../bower_components/polymer/polymer.html">
<!--<link rel="import" href="../bower_components/geo-query/geo-query.html">-->
<link rel="import" href="../bower_components/geo-query/geofire-import.html">

<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">



<dom-module id="beer-home-geo-data">
    <template>

        <firebase-auth id="auth" app-name="beer" status-known="{{statusKnown}}" user="{{user}}"></firebase-auth>


    </template>

    <script>
        Polymer({

            is: 'beer-home-geo-data',
            properties: {
                geofire: {
                    type: Object
                },
                orgId: {
                    type: String
                },

                allObject: {
                    type: Object,
                    notify: true
                },

                allArray: {
                    type: Array,
                    notify: true
                },


                location: {
                    type: Object
                },

                radius: {
                    type: Number,
                    value: 10
                },

                statusKnown:{
                    type:Boolean,
                    value:false
                },

                page: {
                    type: String
                },

                user:{
                    type:Object
                }


            },

            observers: ['_getLocation(location, statusKnown)'],

            _getLocation: function (location, statusKnown) {
                if(statusKnown){
                    console.log(this.user.uid)
              if(location){
                var latitude = location.latitude;
                var longitude = location.longitude;
            
               var radius = 10;
                // var obj={
                //     latitude: latitude, longitude: longitude, radius: radius
                // }
                // console.log(obj); 

                if (latitude && longitude) {
                    //   console.log('location', location)
                    // this.allObject = {};
                    // this.set('allObject', {})
                    // this.splice('allArray', 0, this.allArray.length);


                    var allObject = this.allObject;

                //     if(Array.isArray(this.allArray)){
                //     // for (var i=0; i<this.allArray.length; i++){
                //      for(i=this.allArray.length-1; i>=0; i--){
                //         var pub = this.allArray[i];
                        
                //         var distance = this._distance (location.latitude, location.longitude, pub.latitude, pub.longitude);
                //         // console.log('ARRAY', distance);
                //         var sort = distance;
                //         if(pub.PREMIUM){
                //             if(distance <= 10){
                //                 sort = sort-10;
                //             }
                //         }
                //         this.set('allArray.'+[i]+'.distance', distance)
                //         this.set('allArray.'+[i]+'.sort', sort)
                //         this.set('allArray.'+[i]+'.distance', distance)
                //         this.set('allObject.'+pub.place_id+'.sort', sort)
                //         this.set('allObject.'+pub.place_id+'.arrayPosition', i+1);
                //     }
                // }

                    // if (Array.isArray(this.allArray)) {
                    // for (let pub of this.allArray) {
                    //     let distance = this._distance(latitude, longitude, pub.latitude, pub.longitude);
                    //     let sort = distance;

                    //     if (this._isPremium(pub.plan)) {
                    //         if (distance <= 5) {
                    //             sort = sort - 5;
                    //         }
                    //     }

                    //     if(this.allObject[pub.place_id]){
                    //         let index = this.allObject[pub.place_id].arrayPosition;
                    //         console.log('change', this.allArray[index])
                    //         this.set(`allArray.${index}.distance`, distance);
                            
                    //         this.notifyPath(`allArray.${index}.distance`)
                    //         this.set(`allArray.${index}.sort`, sort);
                    //         this.notifyPath(`allArray.${index}.sort`);

                    //         this.set(`allArray.${index}.name`, 'testing');
                    //         this.notifyPath(`allArray.${index}.name`)

                    //     }
                    // }


                        // for (var i = 0; i < this.allArray.length; i++) {

                        //     var pub = this.allArray[i];

                        //     var distance = this._distance(latitude, longitude, pub.latitude, pub.longitude);

                        //     var sort = distance;

                        //     if (this._isPremium(pub.plan)) {
                        //         if (distance <= 5) {
                        //             sort = sort - 5;
                        //         }
                        //     }



                        //     this.set('allArray.' + [i] + '.distance', distance)
                        //     this.set('allArray.' + [i] + '.sort', sort)
                        //     this.set('allObject.' + pub.place_id + '.sort', sort)
                        //     this.set('allObject.' + pub.place_id + '.arrayPosition', i + 1);

                        // }

                    // }

                    // console.log('testing')


                    var that = this;
                    var app = this.$.auth.app;
                    var firebaseRef = app.database().ref('GeoFire');
                    var geoFire = new GeoFire(firebaseRef);

                    var query = {};
                    var number = 0;

                    query.center = [latitude, longitude];
                    query.radius = radius * 1.609344;

                    var locations = geoFire.query(query).on("key_entered", function (key, location, distance) {
                        app.database().ref(`/organization/${key}`)
                          .once('value').then(function (snapshot) {
                            if (!snapshot.exists()) {
                                console.log('null')
                                return null;
                            }
                            var pub = snapshot.val();

                            pub.favoriteTotal = 0;
                            pub.favoriteYes = 0;
                            pub.favoriteNo = 0;
                            pub.favoritePercent=null;
                            let dislike = false;

                            if(snapshot.child('favorite').exists()){
                              snapshot.child('favorite').forEach(favorite =>{
                                pub.favoriteTotal ++
                                if(favorite.child('favorite').val() === 'yes'){
                                  pub.favoriteYes++
                                }else if(favorite.child('favorite').val() === 'no'){
                                  pub.favoriteNo++
                                  if(that.user){
                                    if(that.user.uid){
                                        if(favorite.key === that.user.uid){
                                            dislike = true;
                                        }
                                    }
                                  }
                                }
                              })
                            }
                        if(pub.favoriteTotal >0){
                        pub.favoritePercent = Math.round((pub.favoriteYes/pub.favoriteTotal)*1000)/10;
                        }

                        var pubDistance = distance * 0.621371;
                        pub.distance = pubDistance;

                        if (location) {
                            // console.log('geo-location', location)
                            pub.latitude = location[0];
                            pub.longitude = location[1];
                        }

                        if (that._isPremium(pub.plan)) {
                            if (pubDistance <= 5) {
                                pub.sort = pubDistance - 5;

                            } else {
                                pub.sort = pubDistance;
                            }
                        } else {
                            if(dislike){   
                                pub.sort = pubDistance+10
                            }else{
                                pub.sort = pubDistance;
                            }
                        }

                        pub.beerfly = true;
                        pub.organization = true;


                        // if (!pub.favorite) {
                        //     pub.favorite = {};
                        // }
                        return pub;


                        }).then(function (pub) {
                            if (!pub) {
                                return null;
                            }
                           

                            if (that.allObject[pub.place_id]) {
                                pub.arrayPosition = that.allObject[pub.place_id].arrayPosition;
                                var index = pub.arrayPosition-1;
                                // console.log('exists', pub);
                                that.set(`allArray.${index}`, pub);
                                that.set(`allObject.${pub.place_id}`, pub);
                                that.notifyPath(`allArray.${index}.sort`)

                            } else {
                                var position = that.push('allArray', pub);
                                //  console.log('does not exist', pub);
                                pub.arrayPosition = position;
                                that.set(`allObject.${pub.place_id}`, pub);
                                that.notifyPath(`allObject.${pub.place_id}.sort`)
                            }

                            return pub;

                        }).then(function (pub) {
                            if (pub) {
                                if (pub.place_id) {
                                    // pub.cacheTimestamp = Date.now()+604800000;
                                    pub.cacheTimestamp = Date.now()
                                    pub.organization = true;
                                    // window.localStorage.setItem('organization_'+pub.place_id, JSON.stringify(pub));
                                    // console.log('cached');
                                }
                            }

                        });
                    })

                }
              }
                }

            },


            _distance: function (myLat, myLng, pubLat, pubLng) {
                var R = 3959;
                var dLat = this.deg2rad(pubLat - myLat);
                var dLon = this.deg2rad(pubLng - myLng);
                var a =
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(this.deg2rad(myLat)) * Math.cos(this.deg2rad(pubLat)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);

                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                var d = R * c;
                return d
            },

            deg2rad: function (deg) {
                return deg * (Math.PI / 180)
            },

            _isPremium: function (plan) {
                var today = Date.now() / 1000;
                if (plan) {
                    if (plan.current_period_end) {
                        if (plan.current_period_end > today) {
                            return true;
                        }
                    }
                }
                return false;
            },



            _test: function (obj) {
                console.log(obj);
            }

        });
    </script>

</dom-module>