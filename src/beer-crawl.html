

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-down-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/moment-element/moment-element.html">

<link rel="import" href="beer-icons.html">
<link rel="import" href="beer-location.html">
<link rel="import" href="beer-crawl-favorite.html">
<link rel="import" href="beer-crawl-url.html">
<link rel="import" href="beer-crawl-edit.html">

<link rel="import" href="beer-dialog.html">



<dom-module id="beer-crawl">

<template strip-whitespace>
  <style include="paper-material-styles">

    a{
      text-decoration: none;
    }

    a > iron-icon {
      text-decoration: none;
      color: var(--app-accent-color);
    }

    ol{
      list-style-type: none;
    }

    li{
      @apply --layout-horizontal;
      padding: 10px;
      border-bottom: 1px solid var(--app-secondary-color);
    }

    li:first-child{
      border-top: 1px solid var(--app-secondary-color);
    }


    li > div {
      margin: 0 10px 0 0;
      font-size: 1em;
      color: var(--app-primary-color);
      font-weight: 400;
    }

    .add-icon{
      color: var(--app-accent-color);
    }

    .edit-icon{
      color: var(--app-secondary-color);
    }

    .link-icon{
      color: var(--app-accent-color);
    }

    .card{
      padding: 12px;
      margin: 15px;
      @apply --paper-material-elevation-1;
    }

    .title-wrapper{
       @apply --layout-horizontal;
       @apply --layout-justified;
    }

    .icon-wrapper{
      @apply --layout-horizontal;
      @apply --layout-justified;
      font-size: 1em;
    }

    .organization-wrapper{
      @apply --layout-horizontal;
      @apply --layout-justified;
      width: 100%;
    }

    .name{
      font-size: 1.5em;
      color: var(--app-primary-color);
      font-weight: 400;
    }

    .description{
      font-size: 1em;
      color: var(--app-primary-color);
      font-weight: 300;
      margin: 10px 0 20px 0;
    }

    .distance{
      font-size: 1em;
      color: var(--app-primary-color);
      font-weight: 400;
    }

    .edit-message{
      font-size: 1em;
      color: var(--app-primary-color);
      font-weight: 300;
    }

    .footer{
      @apply --layout-horizontal;
      @apply --layout-justified;
      margin: 15px;
    }

  </style> 

  <firebase-auth id="auth" app-name="beer" status-known="[[statusKnown]]"user="{{user}}"></firebase-auth>
  
    <div class="card" hidden="[[!user]]">
      <div>
        <a href="/home/crawl/mine">
          <iron-label>
            <paper-icon-button class="add-icon" icon="beer-icons:edit"></paper-icon-button>
            <span class="edit-message">Edit my Beer-Crawls</span>
          </iron-label>
        </a>
      </div>
   

      <template is="dom-if" if="[[crawlId]]">
        <div>
          <a href="/home/crawl">
            <iron-label>
              <paper-icon-button class="add-icon" icon="beer-icons:view-all" on-tap="_resetLocation"></paper-icon-button>
              <span class="edit-message">Show all near-by Beer-Crawls</span>
            </iron-label>
          </a>
        </div>
      </template>

    </div>

    <template is="dom-if" if="[[crawlId]]">
      <div class="card">
        
        <div class="title-wrapper"> 
          <div class="name">[[crawl.name]]</div>
          <div class="icon-wrapper">
             <div hidden$="[[!crawl.owner]]"> 
                <paper-icon-button class="edit-icon" icon="beer-icons:edit" on-tap="_openEditor"></paper-icon-button>
             </div> 
            <div>
              <beer-crawl-favorite
                crawl-id="[[crawl.crawl_id]]">
              </beer-crawl-favorite>
            </div>
          </div>
        </div>
        <div>
          CREATED[[crawl.created]]
          <moment-element
              datetime="[[crawl.created]]"
              output-format="MMM DD[,] YYYY">
          </moment-element>
        </div>
         <template is="dom-repeat" items="[[_addBreaks(crawl.description)]]" as="description">
            <div class="description">[[description]]</div>
         </template>
        <ol>
        <template is="dom-repeat" items="[[_organizationArray(crawl.organization)]]" as="pub">
          <a href="/[[_computeNameForUrl(pub.name)]]/main?orgid=[[pub.place_id]]">
            <li> 
    
            <div class="organization-wrapper">
                <div>
                  <div>[[pub.name]]</div>
                  <div>[[pub.formatted_address]]</div>
                </div>
                <div> 
                  
                </div>
            </div>
            </li>
          </a>
        </template>
        </ol>
        <div class="footer">
          <div>
            <beer-crawl-url organizations="[[crawl.organization]]">
            </beer-crawl-url>
          </div>
          <!-- <div class="distance">Begins [[crawl.distance]] miles from you.</div> -->
        </div>
      </div>
    
    </template>
    

    <template is="dom-if" if="[[!crawlId]]">
    

    
      <beer-location
        location={{location}}>
      </beer-location>
  


    <template is="dom-repeat" items="[[crawlData]]" as="crawl" sort="_sortByNew" observe="created">
      <div class="card">
        
        <div class="title-wrapper"> 
          <div class="name">[[crawl.name]]</div>
          <div class="icon-wrapper">

            <div hidden$="[[!crawl.owner]]"> 
              <paper-icon-button class="edit-icon" crawl="[[crawl]]" icon="beer-icons:edit" on-tap="_openEditor"></paper-icon-button>
            </div> 
            
            <div>
              <a href="/home/crawl?crawlId=[[crawl.crawl_id]]">
              <paper-icon-button class="link-icon" icon="beer-icons:link"></paper-icon-button>
              </a>
            </div>
            
            <div>
              <beer-crawl-favorite
                crawl-id="[[crawl.crawl_id]]">
              </beer-crawl-favorite>
            </div>
          </div>
        </div>
        <div>
          <!-- CREATED[[crawl.created]] -->
          <moment-element
              datetime="[[crawl.timestamp]]"
              output-format="MMM DD[,] YYYY">
          </moment-element>
        </div>
        
         <template is="dom-repeat" items="[[_addBreaks(crawl.description)]]" as="description">
            <div class="description">[[description]]</div>
         </template>
        <ol>
        <template is="dom-repeat" items="[[_organizationArray(crawl.organization)]]" as="pub">
          <a href="/[[_computeNameForUrl(pub.name)]]/main?orgid=[[pub.place_id]]">
            <li> 
    
            <div class="organization-wrapper">
                <div>
                  <div>[[pub.name]]</div>
                  <div>[[pub.formatted_address]]</div>
                </div>
                <div> 
                  
                </div>
            </div>
            </li>
          </a>
        </template>
        </ol>
        <div class="footer">
          <div>
            <beer-crawl-url organizations="[[crawl.organization]]">
            </beer-crawl-url>
          </div>
          <div class="distance">Begins [[crawl.distance]] miles from you.</div>
        </div>
      </div>
    </template>

    </template>
   
    <beer-dialog
      id="crawlEditDialog"
      entry-animation="slide-from-bottom-animation"
      exit-animation="slide-down-animation"
      with-backdrop>
      <beer-crawl-edit
        crawl-id="[[editCrawlId]]">
      </beer-crawl-edit>

    </beer-dialog>

</template>
  <script>

    Polymer({

      is: 'beer-crawl',

      properties: {

         crawlData:{
          type: Array,
          value: function (){
            return [];
          }
        },

        crawlDataLocation:{
          type: Object,
          value: function (){
            return {};
          }
        },

        crawl:Object,

        crawlId:String,
        crawlUrl:String,
        editCrawl:Object,
        editCrawlId:String,

        location:{
          type:Object,
          notify:true
        },
        // latitude:Number,
        // longitude:Number,
        

        sortedLocationHistory:{
          type:Array
        },

        urlParameter:String,
       
        user:{
          type: Object
        },
        
        userData:{
          type: Object
        },


        
      },

      ready: function (){
        var body = document.querySelector('body');
          Polymer.dom(body).appendChild(this.$.crawlEditDialog);
          // this.$.crawlEditDialog.open();
      },

      observers:['_getData(location)',
                '_watchCrawlId(crawlId)'],

      _watchCrawlId: function (crawlId){
        if(crawlId){
          var that = this;
          firebase.database(this.$.auth.app).ref(`/crawl/${crawlId}`)
          .on('value', snapshot =>{
            if(snapshot.exists){
              var obj = snapshot.val();
              obj.crawl_id = snapshot.key;
              that.crawl = obj
              document.title = obj.name;
            }
          })
        }
      },


      _getData: function (location){
        // if(!this.crawlId){
        // this.splice("crawlData", 0, this.crawlData.length)

        var that = this;
        var app = this.$.auth.app;
        var firebaseRef = app.database().ref('GeoCrawl');
        var geoFire = new GeoFire(firebaseRef);
  

        var query = {};
        if(location.latitude && location.longitude){
        
        document.title = `Beer-Crawls: ${location.address}`;
        query.center = [Number(location.latitude), Number(location.longitude)];
        query.radius = 30*1.609344;

        geoFire.query(query)
          .on("key_entered", function(key, location, distance) {
            // that.splice("crawlData", 0, that.crawlData.length)
            app.database().ref('/crawl/'+key)
              .on('value', snapshot => {
                var crawl = snapshot.val();
                crawl.timestamp = snapshot.child('created').val()*1000;
                crawl.distance = Math.round((distance*0.621371)*10)/10;
                crawl.crawl_id = key;

                if(that.user){
                  if(snapshot.child('user_id').val() === that.user.uid){
                    crawl.owner = true;
                  }
                }
                
                 if (snapshot.child('public').exists() || crawl.owner){
                  
                  // console.log(`crawlData.${key}`)
                  if (!that.crawlDataLocation[key]){
                    var arrayLocation = that.push('crawlData', crawl);
                    that.crawlDataLocation[key] = {location:arrayLocation}
                  }else{
                    var existingLocation = that.crawlDataLocation[key].location -1;
                    that.set(`crawlData.${existingLocation}`, crawl);
                  }
                 }
              })
          })

        geoFire.query(query)
          .on('key_exited', function(key){
            var crawls = that.crawlData
            if(Array.isArray(crawls)){
              for(var i=0; i<crawls.length; i++){
                var crawl = crawls[i];
                if(crawl.crawl_id === key){
                  that.splice('crawlData', i, 1);
                }
              }
            }
          })
        
        }
      },

      _resetLocation: function (){
        this._getData(this.location);
      },

      _openEditor(event){
        console.log('worked')
        var crawl = event.currentTarget.crawl;
        this.editCrawlId = crawl.crawl_id;
        this.$.crawlEditDialog.open();
      },

      _isOwner: function (user_id, user){
        if(!user){
          return false;
        }
        if(user_id === user.uid){
          return true;
        }
        return false;
      },

        _organizationArray: function (obj){
        var returnArray = [];
        if(typeof obj ==='object'){
          var key = Object.keys(obj);
          for (let value of key){
           returnArray.push(obj[value])
          }
        }
        return returnArray.sort(this._sortByCreated);
      },

      _sortByCreated: function(a,b){

        if (a.created < b.created)
          return -1;
        if (a.created > b.created)
          return 1;
        return 0;
      },

      _sortByNew: function(a,b){
        if (a.created > b.created)
          return -1;
        if (a.created < b.created)
          return 1;
        return 0;
      },
      

      _addBreaks: function(str){
        'use strict';
        if(str){
          return str.split('\n');
        }else{
          return [];
        }
      },

      _computeNameForUrl: function (name) {
        'use strict';
        if (name) {
          name = name.replace(/\s/g, '-')
          return name.replace(/[^a-zA-Z\d\s:]/g, '');
        } else {
          return 'home'
        }
      },

      

   
      

      _test: function(obj){
          console.log(obj);

      }

    });

  </script>

</dom-module>
